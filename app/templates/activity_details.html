<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <link rel="manifest" href="/static/manifest.json" />
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("/static/service-worker.js")
          .then(() => console.log("Service Worker Registered"))
          .catch((error) =>
            console.error("Service Worker Registration Failed:", error)
          );
      }
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ´»å‹•è©³ç´°é </title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        background-color: #f5f5f5;
        color: #2c4975;
      }

      .container {
        padding: 20px;
        max-width: 900px;
        margin: 0 auto;
      }

      h1 {
        text-align: center;
        margin-top: 20px;
        margin-bottom: 10px;
        font-size: 28px;
        color: #2c4975;
      }

      .info-box {
        background: #fff;
        padding: 15px;
        border-radius: 10px;
        margin: 0 auto 20px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        max-width: 400px;
      }

      .info-box p {
        margin: 5px 0;
      }

      .info-box p strong {
        color: #2c4975;
        font-weight: bold;
      }

      .info-box p span {
        color: #000;
      }

      .btn {
        display: block;
        width: 200px;
        padding: 12px;
        margin-top: 20px;
        background-color: #81d3e1;
        color: white;
        text-align: center;
        text-decoration: none;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      .button-group {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 20px;
        flex-wrap: wrap;
      }

      .btn:hover {
        background-color: #2c4975;
      }

      .disabled {
        background-color: #ccc;
        cursor: not-allowed;
        pointer-events: none;
      }

      @media screen and (max-width: 600px) {
        .container {
          padding: 10px;
        }
      }
    </style>
  </head>
  <body>
    <h1 id="activity-title">è¼‰å…¥ä¸­...</h1>
    <div class="container">
      <section id="activity-info" class="info-box">
        <p style="text-align: center; color: gray">è¼‰å…¥ä¸­...</p>
      </section>
      <section id="description" class="info-box">
        <p style="text-align: center; color: gray">è¼‰å…¥ä¸­...</p>
      </section>
      <section id="participants" class="info-box">
        <p style="text-align: center; color: gray">è¼‰å…¥ä¸­...</p>
      </section>
      <div class="button-group" id="button-group">
        <button class="btn" id="view-others-btn">æˆ‘æƒ³çœ‹çœ‹å…¶ä»–æ´»å‹•ï¼</button>
        <button class="btn" id="join-btn">æˆ‘è¦åƒåŠ ï¼</button>
      </div>
    </div>

    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const activityId = urlParams.get("id");
      const memberId = urlParams.get("member_id");

      if (!activityId) {
        document.querySelector(".container").innerHTML =
          `<p style="color:red;">æ‰¾ä¸åˆ°æ´»å‹• IDï¼</p>`;
        throw new Error("No activity ID found in URL");
      }

      fetch(`/api/activities/details?activity_id=${activityId}`)
        .then((response) => {
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          return response.json();
        })
        .then((data) => {
          if (data.error) throw new Error(data.error);

          const isFull = data.current_participants >= data.max_participants;

          document.getElementById("activity-title").innerText = data.title;
          document.getElementById("activity-info").innerHTML = `
            <p><strong>é¡å‹ï¼š</strong><span>${data.sport_name} / ${data.level}</span></p>
            <p><strong>é–‹å§‹æ™‚é–“ï¼š</strong><span>${new Date(data.start_time).toLocaleString()}</span></p>
            <p><strong>çµæŸæ™‚é–“ï¼š</strong><span>${new Date(data.end_time).toLocaleString()}</span></p>
            <p><strong>åœ°é»ï¼š</strong><span>${data.location_name}</span></p>
            <p><strong>ç›®å‰å ±åäººæ•¸ï¼š</strong><span>${data.current_participants} / ${data.max_participants} äºº</span></p>
            ${isFull ? `<p style='color: red; font-weight: bold;'>å ±åäººæ•¸å·²é¡æ»¿å›‰ï¼</p>` : ""}
          `;

          if (data.description && data.description.trim() !== "") {
            document.getElementById("description").innerHTML = `
              <h3>æ´»å‹•ä»‹ç´¹</h3>
              <p>${data.description}</p>
            `;
          } else {
            document.getElementById("description").style.display = "none";
          }

          const joinBtn = document.getElementById("join-btn");
          const viewOthersBtn = document.getElementById("view-others-btn");
          const buttonGroup = document.getElementById("button-group");

          if (isFull) {
            joinBtn.disabled = true;
            joinBtn.classList.add("disabled");
            joinBtn.innerText = "å·²é¡æ»¿";
            joinBtn.style.width = "300px";
            viewOthersBtn.style.display = "none";
            buttonGroup.style.justifyContent = "center";
          }

          // ğŸ” æŸ¥çœ‹å…¶ä»–æ´»å‹•
          viewOthersBtn.onclick = () => {
            const url = memberId
              ? `/api/activities/overview?member_id=${memberId}`
              : `/api/activities/overview`;
            window.location.href = url;
          };

          // âœ… æˆ‘è¦åƒåŠ åŠŸèƒ½ï¼šPOST åŠ å…¥æ´»å‹•
          joinBtn.onclick = () => {
            if (!memberId) {
              alert("è«‹å…ˆç™»å…¥æˆ–æä¾› member_id æ‰èƒ½åƒåŠ æ´»å‹•ï¼");
              return;
            }

            fetch("/api/activities/join", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                member_id: memberId,
                activity_id: activityId,
              }),
            })
              .then((res) => res.json())
              .then((result) => {
                if (result.error) {
                  alert(`âš ï¸ ${result.error}`);
                } else {
                  alert("âœ… å·²é€å‡ºåƒåŠ ç”³è«‹ï¼");
                  location.reload();
                }
              })
              .catch((err) => {
                console.error("åƒåŠ æ´»å‹•å¤±æ•—", err);
                alert("åƒåŠ æ´»å‹•æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ï¼");
              });
          };
        })
        .catch((error) => {
          console.error("è¼‰å…¥æ´»å‹•è³‡æ–™å¤±æ•—", error);
          document.querySelector(".container").innerHTML = `
            <div style="text-align:center; color: red; font-weight: bold; font-size: 20px;">
              ç„¡æ³•è¼‰å…¥æ´»å‹•è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚
            </div>`;
        });

      // ğŸ‘¥ è¼‰å…¥åƒèˆ‡è€…
      fetch(`/api/activities/participants?activity_id=${activityId}`)
        .then((res) => {
          if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
          return res.json();
        })
        .then((data) => {
          const organizer = data.organizer;
          const joined = data.joined_participants;

          let html = `
            <h3>ä¸»è¾¦äºº</h3>
            <p style="margin: 6px 0; color: #000;">${organizer.name}</p>
          `;

          if (joined.length > 0) {
            html += `
              <h3>å·²åƒåŠ </h3>
              ${joined
                .map(
                  (p) =>
                    `<p style="margin: 6px 0; color: #000;">${p.name}</p>`
                )
                .join("")}
            `;
          } else {
            html += `<h3 style="color: gray;">ç›®å‰é‚„æ²’æœ‰åƒåŠ äººå“¡å–”ï¼</h3>`;
          }

          document.getElementById("participants").innerHTML = html;
        })
        .catch((err) => {
          console.error("è¼‰å…¥åƒåŠ è€…å¤±æ•—", err);
          document.getElementById("participants").innerHTML = `
            <p style="color: red; font-weight: bold;">ç„¡æ³•è¼‰å…¥åƒåŠ è€…è³‡è¨Š</p>
          `;
        });
    </script>
  </body>
</html>
