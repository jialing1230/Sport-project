<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>活動評價</title>

    <style>
      :root {
        --main-color: #81d3e1;
        --deep-blue: #2c4975;
        --text-color: #444;
        --bg-color: #f5f5f5;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: var(--bg-color);
        margin: 0;
        padding: 0px 20px;
      }

      .page-header {
        position: sticky;
        top: 0;
        z-index: 100;
        background-color: #ffffff;
        display: flex;
        align-items: center;
        padding: 6px 16px;
        border-bottom: 1px solid #eee;
        margin: 0 -20px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
      }

      .arrow-icon {
        fill: #2c4975;
        transition: fill 0.2s ease;
        cursor: pointer;
        flex-shrink: 0;
        margin-left: 10px;
      }

      .arrow-icon:hover {
        fill: #64bcd0;
      }

      .header-center {
        display: flex;
        align-items: center;
        margin: 0 auto;
        gap: 8px;
      }

      .header-logo {
        width: 45px;
        height: 45px;
        margin-top: 10px;
      }

      .header-title {
        font-size: 16px;
        font-weight: bold;
        color: #2c4975;
      }

      /* ✅ 新增白底置中容器樣式 */
      .container {
        background-color: #ffffff;
        max-width: 500px;
        margin: 0px auto;
        padding: 0px 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
		min-height: calc(100vh - 66px); /* 扣掉 header 的高度（依實際高度調整） */
	    box-sizing: border-box;
	    display: flex;
	    flex-direction: column;
	    justify-content: flex-start;
		padding-bottom: 30px;
      }

     .activity-title {
	   font-size: 24px;
	   font-weight: bold;
	   color: var(--deep-blue);
	   border-bottom: 1px solid var(--main-color);
	   padding-bottom: 15px;
	   margin-bottom: 12px;
	   margin-top: 20px;
	 }

      .section {
        margin-top: 2px;
      }

      .section-title {
        font-size: 18px;
        
        color: var(--deep-blue);
        margin-bottom: 0px;
      }

		.star-container {
		  display: flex;
		  gap: 8px;
		  align-items: center;
		  margin-bottom: 8px;
		}

		.star {
		  cursor: pointer;
		}

		.star svg {
		  width: 32px;
		  height: 32px;
		  fill: #cccccc; /* 預設灰色 */
		  transition: fill 0.2s ease;
		}

		.star.active svg {
		  fill: #fcbf1b; /* 選中時變金色 */
		}


      .tag-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
		margin-top: 15px;
		margin-bottom: 15px;
		border-bottom: 1px solid var(--main-color);
		padding-bottom: 20px;
      }

      .tag {
        padding: 6px 12px;
        border-radius: 20px;
        background: #f0f0f0;
        border: 1px solid #ccc;
        cursor: pointer;
        font-size: 14px;
        user-select: none;
        transition: background-color 0.2s;
      }

      .tag.active {
        background-color: var(--main-color);
        color: white;
        border-color: var(--main-color);
      }

      .note {
        font-size: 14px;
        color: #64BCD0;
        margin-bottom: 10px;
		margin-top: 2px;
      }
	 .evaluate-container {
		display: flex;
		gap: 24px;
	
	  }

	  .avatar-list {
		  display: grid;
          grid-template-columns: repeat(5, 1fr); /* 5 欄，這是你原本就有的 */
		  gap:12px 25px;
          padding: 0 6px;  /* ✅ 左右補齊 gap，使兩側距離一致 */
		  box-sizing: border-box;
		  width: 100%;
		  max-width: 800px;
		  margin: 0 auto; /* 置中 */
	  }

	  .avatar-block {
		  display: flex;
		  flex-direction: column;
		  align-items: center;
		  cursor: pointer;
		  text-align: center;
	  }
			  
		.avatar-svg svg {
		  width: 56px;
		  height: 56px;
		}
		.avatar-name {
		  font-size: 13px;
		}

		.feedback-output {
		  grid-column: 1 / -1;       /* ✅ 讓評價區佔滿整列 */
		  width: 100%;
		  box-sizing: border-box;

		  max-height: 0;
		  opacity: 0;
		  overflow: hidden;
		  transition: max-height  0.25s cubic-bezier(.23,1.21,.51,1.02), opacity 0.25s, padding 0.25s;
          padding: 0 12px;
		  padding: 0 12px;
		  margin-top: 12px;
		}

		.feedback-output.active {
		  max-height: 500px; /* 根據實際內容高度調整 */
		  opacity: 1;
		  padding: 12px;
		}
		#user-stars {
		  display: flex;
		  flex-wrap: wrap;
		  gap: 8px;
		  justify-content: flex-start;
		}
		.avatar-arrow {
		  width: 0;
		  height: 0;
		  margin-top: 2px;
		  border-left: 12px solid transparent;
		  border-right: 12px solid transparent;
		  border-top: 12px solid #81d3e1; /* 箭頭顏色，和主色一致 */
		  display: none;
		  transition: opacity 0.2s;
		}
		.avatar-block.active-user .avatar-arrow {
		  display: block;
		  /* 你可以加個動畫進場，如果想更有感 */
		  opacity: 1;
		  /* 可以加點陰影，讓箭頭更立體 */
		  filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));
		}
		.submit-evaluation-btn {
		  background-color: #fea3a8;
		  color: #fff;
		  font-size: 20px;
		  font-weight: bold;
		  border: none;
		  width: 100%;
		  margin: 36px 0 0 0;
		  border-radius: 12px;
		  height: 56px;
		  box-shadow: 0 2px 10px rgba(252,167,167,0.08);
		  letter-spacing: 2px;
		  cursor: pointer;
		  transition: background 0.18s, filter 0.18s;
		  display: block;
		}
		.submit-evaluation-btn:active {
		  filter: brightness(0.95);
		}


    </style>
  </head>

  <body>
    <header class="page-header">
      <svg class="arrow-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 256 256" onclick="redirectToMemberView()">
        <path d="M228,128a12,12,0,0,1-12,12H69l51.52,51.51a12,12,0,0,1-17,17l-72-72a12,12,0,0,1,0-17l72-72a12,12,0,0,1,17,17L69,116H216A12,12,0,0,1,228,128Z"/>
      </svg>
      <div class="header-center">
        <img src="/static/logo.png" class="header-logo" alt="logo">
        <span class="header-title">活動評價</span>
      </div>
    </header>

    <!-- ✅ 白底內容容器開始 -->
    <div class="container">
	<div class="activity-title">輕鬆認識拍友團</div>
      <div class="section">
        <div class="section-title">評價此活動</div>
        <div class="note">從流程、氣氛到內容，給主辦人一個回饋吧！</div>

		<div class="star-container" id="activity-stars">
		  <span class="star" data-score="1">
			<svg viewBox="0 0 256 256"><path d="M234.29,114.85l-45,38.83L203,211.75a16.4,16.4,0,0,1-24.5,17.82L128,198.49,77.47,229.57A16.4,16.4,0,0,1,53,211.75l13.76-58.07-45-38.83A16.46,16.46,0,0,1,31.08,86l59-4.76,22.76-55.08a16.36,16.36,0,0,1,30.27,0l22.75,55.08,59,4.76a16.46,16.46,0,0,1,9.37,28.86Z"/></svg>
		  </span>
		  <span class="star" data-score="2">
			<svg viewBox="0 0 256 256"><path d="M234.29,114.85l-45,38.83L203,211.75a16.4,16.4,0,0,1-24.5,17.82L128,198.49,77.47,229.57A16.4,16.4,0,0,1,53,211.75l13.76-58.07-45-38.83A16.46,16.46,0,0,1,31.08,86l59-4.76,22.76-55.08a16.36,16.36,0,0,1,30.27,0l22.75,55.08,59,4.76a16.46,16.46,0,0,1,9.37,28.86Z"/></svg>
		  </span>
		  <span class="star" data-score="3">
			<svg viewBox="0 0 256 256"><path d="M234.29,114.85l-45,38.83L203,211.75a16.4,16.4,0,0,1-24.5,17.82L128,198.49,77.47,229.57A16.4,16.4,0,0,1,53,211.75l13.76-58.07-45-38.83A16.46,16.46,0,0,1,31.08,86l59-4.76,22.76-55.08a16.36,16.36,0,0,1,30.27,0l22.75,55.08,59,4.76a16.46,16.46,0,0,1,9.37,28.86Z"/></svg>
		  </span>
		  <span class="star" data-score="4">
			<svg viewBox="0 0 256 256"><path d="M234.29,114.85l-45,38.83L203,211.75a16.4,16.4,0,0,1-24.5,17.82L128,198.49,77.47,229.57A16.4,16.4,0,0,1,53,211.75l13.76-58.07-45-38.83A16.46,16.46,0,0,1,31.08,86l59-4.76,22.76-55.08a16.36,16.36,0,0,1,30.27,0l22.75,55.08,59,4.76a16.46,16.46,0,0,1,9.37,28.86Z"/></svg>
		  </span>
		  <span class="star" data-score="5">
			<svg viewBox="0 0 256 256"><path d="M234.29,114.85l-45,38.83L203,211.75a16.4,16.4,0,0,1-24.5,17.82L128,198.49,77.47,229.57A16.4,16.4,0,0,1,53,211.75l13.76-58.07-45-38.83A16.46,16.46,0,0,1,31.08,86l59-4.76,22.76-55.08a16.36,16.36,0,0,1,30.27,0l22.75,55.08,59,4.76a16.46,16.46,0,0,1,9.37,28.86Z"/></svg>
		  </span>
		</div>



        <div class="section-title">這次活動感覺如何？（可複選）</div>
        <div id="activity-tags" class="tag-container"></div>
      </div>
	  <div class="section-title">評價其他參加者</div>
	  <div class="note">點選頭像可為該參加者給予星等與標籤回饋！</div>
	  <div class="evaluate-container">
	  <div class="avatar-list"></div>
<div class="feedback-output" id="feedback-slot-1"></div>
<div class="feedback-output" id="feedback-slot-2"></div>  
    </div>

	</div>
		<div class="fixed-submit-btn-bar">
	  <button type="button" class="submit-evaluation-btn">送出評價</button>
	</div>

	</div>
	
    <!-- ✅ 白底內容容器結束 -->

    <script>
      // 星星互動邏輯
      let selectedActivityStars = 0;
		const activityStars = document.querySelectorAll("#activity-stars .star");

		
activityStars.forEach(star => {
  star.addEventListener("click", () => {
    selectedActivityStars = parseInt(star.dataset.score);
    activityStars.forEach(s => {
      s.classList.toggle("active", parseInt(s.dataset.score) <= selectedActivityStars);
    });
    if (selectedActivityStars > 0) {
      loadActivityTagsByStars(selectedActivityStars);
    }
  });
});

function loadActivityTagsByStars(stars) {
  fetch(`/api/review_templates?stars=${stars}`)
    .then(res => res.json())
    .then(data => {
      activityTagContainer.innerHTML = '';
      selectedActivityTags.clear();
      data.forEach(item => {
        const tag = document.createElement("div");
        tag.className = "tag";
        tag.innerText = item.text;
        tag.addEventListener("click", () => {
          tag.classList.toggle("active");
          if (selectedActivityTags.has(item.text)) {
            selectedActivityTags.delete(item.text);
          } else {
            selectedActivityTags.add(item.text);
          }
        });
        activityTagContainer.appendChild(tag);
      });
    });
}

		;

      // 評價 tag 互動
      // 活動評價標籤由 API 動態載入
		const userTags = [
		  "互動很自然", "友善好聊", "人很隨和", "活潑又熱情",
		  "和他互動很輕鬆", "活動有趣", "氣氛帶動", "有禮親切"
		];

      const selectedActivityTags = new Set();
      const activityTagContainer = document.getElementById("activity-tags");

      // 可給後端呼叫的函式
      function getActivityEvaluation() {
        return {
          stars: selectedStars,
          tags: Array.from(selectedActivityTags)
        };
      }

      // 返回頁面
      function getMemberIdFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('member_id');
}

      function redirectToMemberView() {
        const memberId = getMemberIdFromURL();
        if (memberId) {
          window.location.href = `/activity?member_id=${memberId}`;
        } else {
           window.location.href = '/'; // 或導回登入頁
  }
}
	      const blocks = document.querySelectorAll('.avatar-block');
const feedbackSlot1 = document.getElementById('feedback-slot-1');
const feedbackSlot2 = document.getElementById('feedback-slot-2');
let activeUser = null;


const selectedUserStarsMap = new Map(); // 儲存每個 user 的星星
const selectedUserTagsMap = new Map();  // 儲存每個 user 的 tag（Set）

blocks.forEach(block => {
  block.addEventListener('click', () => {
    const user = block.dataset.user;
    const slot = (['user1','user2','user3','user4','user5'].includes(user)) ? feedbackSlot1 : feedbackSlot2;

    // 防切換（有填但未完成不可切）
    let preventSwitch = false;
    if (activeUser) {
      const stars = selectedUserStarsMap.get(activeUser);
      const tags = selectedUserTagsMap.get(activeUser);
      const hasFilled = (stars > 0) || (tags && tags.size > 0);
      const isComplete = isUserEvaluationComplete(activeUser);
      preventSwitch = hasFilled && !isComplete;
    }

    // 點自己且尚未填寫 ➜ 收合
    if (activeUser === user && !(selectedUserStarsMap.get(user) > 0) && !(selectedUserTagsMap.get(user) && selectedUserTagsMap.get(user).size > 0)) {
      slot.classList.remove('active');
      setTimeout(() => { slot.innerHTML = ''; }, 250); // 給收合動畫時間
      activeUser = null;
      block.classList.remove('active-user');
    } else if (activeUser !== user) {
      if (preventSwitch) {
        alert("請先完成目前這位參加者的星等與標籤評價！");
        return;
      }
      // 換人時滑順收合
      slot.classList.remove('active');
      setTimeout(() => {
        renderUserEvaluation(user, slot);
        slot.classList.add('active');
      }, 220);  // 與 CSS transition 時間相同
      blocks.forEach(b => b.classList.remove('active-user'));
      block.classList.add('active-user');
      activeUser = user;
    }
  });
});


// 星星互動
function initUserStars(user) {
  const userStars = document.querySelectorAll("#user-stars .star");
  let selectedUserStars = selectedUserStarsMap.get(user) || 0;

  userStars.forEach(star => {
    // 狀態回填
    const sScore = parseInt(star.dataset.score);
    star.classList.toggle("active", sScore <= selectedUserStars);

    star.addEventListener("click", () => {
      const score = parseInt(star.dataset.score);
      if (score === selectedUserStars) {
        selectedUserStars = 0;
      } else {
        selectedUserStars = score;
      }
      selectedUserStarsMap.set(user, selectedUserStars);
      userStars.forEach(s => {
        const sScore = parseInt(s.dataset.score);
        s.classList.toggle("active", sScore <= selectedUserStars);
      });
    });
  });
}

// 標籤互動
function renderUserTags(containerId, user) {
  const tagContainer = document.createElement("div");
  tagContainer.className = "tag-container";

  const selectedTags = selectedUserTagsMap.get(user) || new Set();

  userTags.forEach(tagText => {
    const tag = document.createElement("div");
    tag.className = "tag";
    tag.innerText = tagText;

    // 標示已選
    if (selectedTags.has(tagText)) {
      tag.classList.add("active");
    }

    tag.addEventListener("click", () => {
      tag.classList.toggle("active");
      if (selectedTags.has(tagText)) {
        selectedTags.delete(tagText);
      } else {
        selectedTags.add(tagText);
      }
      selectedUserTagsMap.set(user, selectedTags); // 更新儲存
    });

    tagContainer.appendChild(tag);
  });

  const container = document.getElementById(containerId);
  container.innerHTML = "";
  container.appendChild(tagContainer);
}

function renderUserEvaluation(user, slot) {
  // 直接覆蓋自己這個 slot（不用 setTimeout）
  slot.classList.remove('active');
  slot.innerHTML = `
    <div class="star-container" id="user-stars">
      ${[1,2,3,4,5].map(score => `
        <span class="star" data-score="${score}">
          <svg viewBox="0 0 256 256"><path d="M234.29,114.85l-45,38.83L203,211.75a16.4,16.4,0,0,1-24.5,17.82L128,198.49,77.47,229.57A16.4,16.4,0,0,1,53,211.75l13.76-58.07-45-38.83A16.46,16.46,0,0,1,31.08,86l59-4.76,22.76-55.08a16.36,16.36,0,0,1,30.27,0l22.75,55.08,59,4.76a16.46,16.46,0,0,1,9.37,28.86Z"/></svg>
        </span>`).join('')}
    </div>
    <div id="user-tags"></div>
  `;
  initUserStars(user);
  renderUserTags("user-tags", user);

  // 更新頭像勾勾
  blocks.forEach(b => {
    const u = b.dataset.user;
    const done = isUserEvaluationComplete(u);
    const check = b.querySelector('.checkmark');
    if (check) {
      check.style.display = done ? 'block' : 'none';
    }
  });
}

function isUserEvaluationComplete(user) {
  const stars = selectedUserStarsMap.get(user);
  const tags = selectedUserTagsMap.get(user);
  return stars > 0 && tags && tags.size > 0;
}
    
const urlParams = new URLSearchParams(window.location.search);
const activityId = urlParams.get('activity_id');
const currentUserId = urlParams.get('member_id');


function initAvatarClickEvents() {
  const blocks = document.querySelectorAll('.avatar-block');
  blocks.forEach(block => {
    block.addEventListener('click', () => {
      const user = block.dataset.user;
      const slot = feedbackSlot1;
      let preventSwitch = false;
      if (activeUser) {
        const stars = selectedUserStarsMap.get(activeUser);
        const tags = selectedUserTagsMap.get(activeUser);
        const hasFilled = (stars > 0) || (tags && tags.size > 0);
        const isComplete = isUserEvaluationComplete(activeUser);
        preventSwitch = hasFilled && !isComplete;
      }
      if (activeUser === user && !(selectedUserStarsMap.get(user) > 0) && !(selectedUserTagsMap.get(user) && selectedUserTagsMap.get(user).size > 0)) {
        slot.classList.remove('active');
        setTimeout(() => { slot.innerHTML = ''; }, 250);
        activeUser = null;
        block.classList.remove('active-user');
      } else if (activeUser !== user) {
        if (preventSwitch) {
          alert("請先完成目前這位參加者的星等與標籤評價！");
          return;
        }
        slot.classList.remove('active');
        setTimeout(() => {
          renderUserEvaluation(user, slot);
          slot.classList.add('active');
        }, 220);
        blocks.forEach(b => b.classList.remove('active-user'));
        block.classList.add('active-user');
        activeUser = user;
      }
    });
  });
}


document.querySelector('.submit-evaluation-btn').addEventListener('click', () => {
  const activityPayload = {
    activity_id: parseInt(activityId),
    member_id: parseInt(currentUserId),
    stars: selectedActivityStars,
    tags: Array.from(selectedActivityTags)
  };

  const userPayloads = [];
  selectedUserStarsMap.forEach((stars, userId) => {
    userPayloads.push({
      activity_id: parseInt(activityId),
      member_id: parseInt(currentUserId),
      target_user_id: parseInt(userId),
      stars: stars,
      tags: Array.from(selectedUserTagsMap.get(userId) || [])
    });
  });

  Promise.all([
    fetch('/api/activity_reviews', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(activityPayload)
    }),
    fetch('/api/user_reviews/bulk', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(userPayloads)
    })
  ]).then(() => {
    alert('評價已送出！');
    window.location.href = `/activity?member_id=${encodeURIComponent(currentUserId)}`;
  }).catch(err => {
    console.error(err);
    alert('送出失敗，請稍後再試');
  });
});

fetch(`/api/activities/${activityId}/participants`)
  .then(res => res.json())
  .then(participants => {
    const avatarList = document.querySelector('.avatar-list');
    avatarList.innerHTML = '';
    participants
      .filter(p => p.user_id != currentUserId)
      .forEach((p, index) => {
        const block = document.createElement('div');
        block.className = 'avatar-block';
        block.dataset.user = p.user_id;
        block.innerHTML = `
          <div class="avatar-svg">
            <img src="/static/avatars/default.jpg" alt="${p.name}" width="56" height="56" style="border-radius:50%;">
          </div>
          <div class="avatar-name">${p.name}</div>
          <div class="avatar-arrow"></div>
          <div class="checkmark" style="display:none;">✔</div>
        `;
        avatarList.appendChild(block);
        if ((index + 1) % 5 === 0) {
          const slotId = (index + 1) / 5;
          const slot = document.createElement('div');
          slot.className = 'feedback-output';
          slot.id = `feedback-slot-${slotId}`;
          avatarList.appendChild(slot);
        }
      });
    initAvatarClickEvents();
  });

function initAvatarClickEvents() {
  const blocks = document.querySelectorAll('.avatar-block');
  blocks.forEach((block, idx) => {
    block.addEventListener('click', () => {
      const user = block.dataset.user;
      const slot = (idx < 5) ? document.getElementById('feedback-slot-1') : document.getElementById('feedback-slot-2');
      let preventSwitch = false;
      if (activeUser) {
        const stars = selectedUserStarsMap.get(activeUser);
        const tags = selectedUserTagsMap.get(activeUser);
        const hasFilled = (stars > 0) || (tags && tags.size > 0);
        const isComplete = isUserEvaluationComplete(activeUser);
        preventSwitch = hasFilled && !isComplete;
      }
      if (activeUser === user && !(selectedUserStarsMap.get(user) > 0) && !(selectedUserTagsMap.get(user) && selectedUserTagsMap.get(user).size > 0)) {
        slot.classList.remove('active');
        setTimeout(() => { slot.innerHTML = ''; }, 250);
        activeUser = null;
        block.classList.remove('active-user');
      } else if (activeUser !== user) {
        if (preventSwitch) {
          alert("請先完成目前這位參加者的星等與標籤評價！");
          return;
        }
        slot.classList.remove('active');
        setTimeout(() => {
          renderUserEvaluation(user, slot);
          slot.classList.add('active');
        }, 220);
        blocks.forEach(b => b.classList.remove('active-user'));
        block.classList.add('active-user');
        activeUser = user;
      }
    });
  });
}

function initUserStars(user) {
  const userStars = document.querySelectorAll("#user-stars .star");
  let selectedUserStars = selectedUserStarsMap.get(user) || 0;

  userStars.forEach(star => {
    const sScore = parseInt(star.dataset.score);
    star.classList.toggle("active", sScore <= selectedUserStars);

    star.addEventListener("click", () => {
      const score = parseInt(star.dataset.score);
      selectedUserStars = (score === selectedUserStars) ? 0 : score;
      selectedUserStarsMap.set(user, selectedUserStars);

      userStars.forEach(s => {
        const sScore = parseInt(s.dataset.score);
        s.classList.toggle("active", sScore <= selectedUserStars);
      });

      if (selectedUserStars > 0) {
        loadUserTagsByStars(selectedUserStars, "user-tags");
      }
    });
  });
}

function loadUserTagsByStars(stars, containerId) {
  // 參加者的 type = 活動星等 + 5
  const type = stars + 5;
  fetch(`/api/review_templates?stars=${type}`)
    .then(res => res.json())
    .then(data => {
      const tagContainer = document.createElement("div");
      tagContainer.className = "tag-container";
      const selectedTags = selectedUserTagsMap.get(activeUser) || new Set();

      data.forEach(item => {
        const tag = document.createElement("div");
        tag.className = "tag";
        tag.innerText = item.text;
        if (selectedTags.has(item.text)) {
          tag.classList.add("active");
        }
        tag.addEventListener("click", () => {
          tag.classList.toggle("active");
          if (selectedTags.has(item.text)) {
            selectedTags.delete(item.text);
          } else {
            selectedTags.add(item.text);
          }
          selectedUserTagsMap.set(activeUser, selectedTags);
        });
        tagContainer.appendChild(tag);
      });

      const container = document.getElementById(containerId);
      container.innerHTML = "";
      container.appendChild(tagContainer);
    });
}



</script>
  </body>
</html>
