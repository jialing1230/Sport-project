<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <link rel="manifest" href="/static/manifest.json" />
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("/static/service-worker.js")
          .then(() => console.log("Service Worker Registered"))
          .catch((error) =>
            console.error("Service Worker Registration Failed:", error)
          );
      }
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>發起課程</title>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        color: #333;
        margin: 0;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
      }
      .container {
        max-width: 800px;
        width: 100%;
        background-color: #fff;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      .title-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 30px;
      }
      .title-left,
      .title-right {
        width: 60px; /* 和 SVG 寬度差不多，保持對稱 */
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .title-center {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        flex-grow: 1;
      }
      .back-button {
        background: none;
        border: none;
        cursor: pointer;
      }
      .logo-inline {
        width: 50px;
        height: 50px;
        object-fit: contain;
        border-radius: 50%;
      }
      h1 {
        color: #2c4975;
        white-space: nowrap;
        font-size: 18px;
        margin: 0;
      }
      .form-row {
        margin-bottom: 20px;
      }
      .form-label {
        margin-bottom: 20px;
        font-weight: bold;
        color: #2c4975;
        display: block;
      }
      .radio-card-group {
        display: flex;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
      }
      .radio-card {
        padding: 10px 20px;
        background-color: #f9f9f9;
        border: 1px solid #ccc;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
		font-size: 15px;
	    user-select: none;
	    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      .radio-card input {
        display: none;
      }
	  .radio-card:hover {
	   background-color: #eaf3fa;
	   color: #2c4975;
	  }
      .radio-card:has(input:checked) {
        background-color: #81d3e1;
        color: white;
		font-weight: bold;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }
	  .radio-card:active {
	   transform: scale(0.96);
	  }
	  .radio-card:has(input:checked) span {
		  color: white; /* 專門讓包住文字的 span 變白色 */
		}
      .btn-primary {
        padding: 10px 20px;
        font-size: 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        color: white;
        background-color: #81d3e1;
        width: 100%;
        transition: 0.2s ease;
      }
      .btn-primary:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .btn-primary:hover:enabled {
        background-color: #2c4975;
      }
      input[type="text"],
      input[type="datetime-local"],
      input[type="number"],
      textarea {
        padding: 10px;
        width: 100%;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
      }
      textarea {
        resize: vertical;
        min-height: 100px;
      }
      #other-sport-row {
        margin-top: 16px;
        display: none;
      }
      .back-button {
        background: none;
        border: none;
        cursor: pointer;
        margin-left: -8px; /* ← 控制往左 */
      }
      .arrow-icon {
        fill: #2c4975;
        transition: fill 0.2s ease;
      }

      .back-button:hover .arrow-icon {
        fill: #81d3e1;
      }
	  
	  .course-type {
	   display: flex;
	   gap: 18px; /* 控制按鈕之間的間距 */
	   flex-wrap: wrap; /* 如果螢幕太小會自動換行 */
	   margin-top: 8px;
	  }

      .course-type button.active {
        background-color: #81d3e1;
        color: white;
        font-weight: bold;
        }
      .course-type button {
        padding: 10px 15px;
        border: 1px solid #ccc;
        background-color: white;
        color: #2c4975;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        font-size: 16px;
        justify-content: center;
        }

       .weekday-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
        margin-top: 8px;
        }

       .weekday-btn {
        padding: 10px 15px;
        border: 1px solid #ccc;
        border-radius: 8px;
        background-color: white;
        color: #2c4975;
        cursor: pointer;
        transition: all 0.2s ease;
        user-select: none;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

       .weekday-btn input {
        display: none;
        }

       .weekday-btn:has(input:checked) {
        background-color: #81d3e1;
        color: white;
        border-color: #ccc;
        font-weight: bold;
        }

        .form-label-with-action {
        display: flex;
        justify-content: space-between;
        align-items: center;
        }

        .text-button {
        background: none;
        border: none;
        color: #81d3e1;
        font-size: 14px;
        cursor: pointer;
        font-weight: bold;
        }

        .text-button:hover {
        color: #81d3e1;
        }

        .dropdown-list {
        margin-top: 8px;
        padding: 8px;
        background-color: #f9f9f9;
        border: 1px solid #ccc;
        border-radius: 4px;
        list-style-type: none;
        max-height: 200px;
        overflow-y: auto;
        }

        .dropdown-list li {
        padding: 6px 10px;
        cursor: pointer;
        }

        .dropdown-list li:hover {
        background-color: #eaf3fa;
        }
		.half-row {
		  display: flex;
		  gap: 16px;
		  align-items: center;
		}

		.half-input,
		.half-button {
		  flex: 1;
		}

		.half-button {
		  padding: 10px;
		  font-size: 14px;
		}
		.btn-generate {
		  padding: 10px 15px;
		  font-size: 16px;
		  background-color: #81d3e1;   /* 藍綠色背景 */
		  color: white;                /* 白字 */
		  border: 1px solid #ccc;   /* 深一點的藍綠邊框 */
		  border-radius: 6px;
		  cursor: pointer;
		  transition: all 0.2s ease;
		  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
		  font-weight: bold;
		  white-space: nowrap;
		  max-width: 160px; /* ✅ 限制最大寬度 */
		  flex-shrink: 0;   /* ✅ 不會被壓扁 */
		}

		.btn-generate:hover {
		  background-color: #2c4975;   /* 深藍 hover 色 */
		  border-color: #2c4975;
		}

		.btn-generate:active {
		  transform: scale(0.96);
		}
    /* === 付費會員優惠 Switch === */
    .discount-toggle {
      display: flex; align-items: center; gap: 10px; margin-top: 12px;
    }
    .discount-toggle .row-title { min-width: 180px; color:#2c4975; font-weight:600; }

    .switch {
      --on:#2c4975;           /* 開：深藍 */
      --off:#cfd8e3;          /* 關底色 */
      --knob:#ffffff;
      width: 46px; height: 26px; border-radius: 999px; position: relative;
      background: var(--off); border: 0; cursor: pointer; padding: 0;
      transition: background .2s ease;
    }
    .switch .knob {
      position: absolute; top: 3px; left: 3px; width: 20px; height: 20px;
      background: var(--knob); border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,.2);
      transition: transform .2s ease;
    }
    /* 開關 + 灰字保持垂直置中 */
    .switch-row {
      display: flex;
      align-items: center;   /* ✅ 垂直置中 */
      gap: 12px;              /* 開關和灰字的距離 */
      margin-top: 8px;
    }

    .switch.is-on { background: #81d3e1; }          /* 開啟時底色（淡藍） */
    .switch.is-on .knob { transform: translateX(20px); }
    .switch:focus-visible { outline: 2px solid #64bcd0; outline-offset: 2px; }

    /* 停用（非付費發起人時） */
    .switch.is-disabled { opacity:.5; cursor:not-allowed; }
    .hint { font-size: 14px; color:#6b7280; }
    @media (max-width: 480px) {
      .discount-toggle {
        flex-direction: column;   /* 手機版改直向 */
        align-items: flex-start;  /* 左對齊 */
        gap: 4px;
      }

      /* 第二、三個元素：switch + hint 改同行 */
      .discount-toggle .switch,
      .discount-toggle .hint {
        display: inline-block;
        vertical-align: middle;
      }
    }




    </style>
  </head>
  <body>
    <div class="container">
      <div class="title-row">
        <div class="title-left">
          <button onclick="history.back()" class="back-button">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="28"
              height="28"
              class="arrow-icon"
              viewBox="0 0 256 256"
            >
              <path
                d="M228,128a12,12,0,0,1-12,12H69l51.52,51.51a12,12,0,0,1-17,17l-72-72a12,12,0,0,1,0-17l72-72a12,12,0,0,1,17,17L69,116H216A12,12,0,0,1,228,128Z"
              />
            </svg>
          </button>
        </div>
        <div class="title-center">
          <h1>發起課程</h1>
        </div>
        <div class="title-right"><!-- 預留空間用 --></div>
      </div>
      <form id="classForm">
  <!-- 表單欄位們 -->
    <div class="form-row">
        <div class="form-label-with-action">
            <label class="form-label">課程名稱</label>
            <button type="button" class="text-button" onclick="togglePastTitles()">曾發起的活動</button>
        </div>
        <input type="text" name="title" placeholder="公開顯示，請簡明清楚" required />
        <ul id="pastTitles" class="dropdown-list" style="display: none;"></ul>
    </div>

  <div class="form-row">
    <label class="form-label">類型</label>
    <div class="radio-card-group" id="sport-options"></div>
    <div class="form-row" id="other-sport-row">
      <input type="text" id="other-sport-input" placeholder="請輸入其他類型" />
    </div>
  </div>

  <div class="form-row">
    <label class="form-label">地點</label>
    <div style="display: flex; gap: 10px;">
      <input
        type="text"
        id="place-input"
        name="location"
        placeholder="請輸入完整地址"
        required
        style="flex: 1;"
      />
    </div>
    <input type="hidden" id="location-lat" name="location_lat" />
    <input type="hidden" id="location-lng" name="location_lng" />
  </div>
  
  <div class="form-row">
    <label class="form-label">地圖預覽</label>
    <div
      id="map"
      style="width: 100%; height: 300px; border: 1px solid #ccc; border-radius: 4px;"
    ></div>
  </div>

  <div class="form-row">
    <label class="form-label">課程時間</label>
    <div class="course-type">
      <button type="button" onclick="selectCourseType('single')" id="btn-single" class="active">單　堂　課　程</button>
      <button type="button" onclick="selectCourseType('multi')" id="btn-multi">多　堂　課　程</button>
    </div>
  </div>

  <!-- ✅ 單堂課程表單 -->
  <div id="single-course-form">
    <div class="form-row">
      <label class="form-label">課程開始時間</label>
      <input type="datetime-local" name="startTime" required />
    </div>
    <div class="form-row">
      <label class="form-label">課程結束時間</label>
      <input type="datetime-local" name="endTime" required />
    </div>
    <div class="form-row">
          <label class="form-label">上限人數</label>
          <input
            type="number"
            name="numPeople"
            placeholder="請輸入最高上限人數"
            required
            min="1"
          />
        </div>
    <div class="form-row">
          <label class="form-label">下限人數</label>
          <input
            type="number"
            name="minPeople"
            placeholder="請輸入最低下限人數"
            required
            min="1"
          />
          <div style="font-size: 12px; color: #666; margin-top: 5px;">
            提醒：報名截止人數未達最低下限，活動將自行取消
          </div>
        </div>
    <div class="form-row">
      <label class="form-label">費用NTD（每位學員）</label>
      <input type="number" name="venue_fee" placeholder="請輸入每位學員費用" step="0.01" min="0" required />
    </div>
    <!-- 【新增】單堂課：是否提供付費會員優惠 -->
    <div class="form-row discount-toggle">
      <label class="row-title">是否提供付費會員優惠</label>
      <div class="switch-row">
      <button type="button" id="allowDiscountSwitchSingle" class="switch" aria-pressed="false" aria-label="是否提供付費會員優惠（單堂）">
        <span class="knob"></span>
      </button>

      <span id="allowDiscountTextSingle" class="hint">關閉（不提供優惠）</span>
      <!-- 送後端的值：0/1 -->
       </div>
      <input type="hidden" name="allow_discount_single" id="allow_discount_single" value="0">
    </div>

    <div class="form-row">
      <label class="form-label">報名截止日期</label>
      <input type="datetime-local" name="registration_deadline" required />
    </div>
	<div class="form-row">
          <label class="form-label">性別</label>
          <div class="radio-card-group">
            <label class="radio-card">
			  <input type="radio" name="gender" value="男性" required />
			  <span>男性</span>
			</label>
            <label class="radio-card"
              ><input
                type="radio" name="gender" value="女性" required />
			  <span>女性</span>
			</label>
           <label class="radio-card">
			  <input type="radio" name="gender" value="不限" required />
			  <span>不限</span>
			</label>
		  </div>
		</div>

		<div class="form-row">
		  <label class="form-label">年齡區間</label>
		  <div class="radio-card-group">
			<label class="radio-card">
			  <input type="radio" name="ageRange" value="18-25" required />
			  <span>18–25</span>
			</label>
			<label class="radio-card">
			  <input type="radio" name="ageRange" value="26-35" required />
			  <span>26–35</span>
			</label>
			<label class="radio-card">
			  <input type="radio" name="ageRange" value="36-45" required />
			  <span>36–45</span>
			</label>
			<label class="radio-card">
			  <input type="radio" name="ageRange" value="46-64" required />
			  <span>46–64</span>
			</label>
			<label class="radio-card">
			  <input type="radio" name="ageRange" value="65+" required />
			  <span>65以上</span>
			</label>
			<label class="radio-card">
			  <input type="radio" name="ageRange" value="不限" required />
			  <span>不限</span>
			</label>
		  </div>
		</div>

		<div class="form-row">
		  <label class="form-label">等級</label>
		  <div class="radio-card-group">
			<label class="radio-card">
			  <input type="radio" name="level" value="初學" required />
			  <span>初學</span>
			</label>
			<label class="radio-card">
			  <input type="radio" name="level" value="中階" required />
			  <span>中階</span>
			</label>
			<label class="radio-card">
			  <input type="radio" name="level" value="進階" required />
			  <span>進階</span>
			</label>
			<label class="radio-card">
			  <input type="radio" name="level" value="不限" required />
			  <span>不限</span>
			</label>
		  </div>
		</div>
<!-- ✅ 裝備建議 -->
<div class="form-row" id="equipment-row" style="display:none;">
  <label class="form-label">裝備建議</label>
  <div id="equipment-options" class="radio-card-group" 
       style="flex-wrap: wrap; justify-content:center; gap:10px;">
    <!-- JavaScript 會動態生成 -->
  </div>
</div>


    <div class="form-row">
      <label class="form-label">活動介紹及補充說明</label>
      <textarea name="description" placeholder="EX：地標描述、裝備建議、注意事項..."></textarea>
    </div>
    <input type="hidden" id="location-lat" name="location_lat">
<input type="hidden" id="location-lng" name="location_lng">
     <button type="submit" class="btn-primary" id="single-submit-btn">發起單堂課程</button>
  </div>

  <!-- ✅ 多堂課程表單 -->
  <div id="multi-course-form" style="display: none;">
    <div class="form-row">
      <label class="form-label">第一次上課時間</label>
      <input type="datetime-local" name="firstTime" required />
    </div>
    <div class="form-row">
      <label class="form-label">每週上課日（複選）</label>
      <div class="weekday-group">
        <label class="weekday-btn">
            <input type="checkbox" name="weekdays" value="一" />
            週一
        </label>
        <label class="weekday-btn">
            <input type="checkbox" name="weekdays" value="二" />
            週二
        </label>
        <label class="weekday-btn">
            <input type="checkbox" name="weekdays" value="三" />
            週三
        </label>
        <label class="weekday-btn">
            <input type="checkbox" name="weekdays" value="四" />
            週四
        </label>
        <label class="weekday-btn">
            <input type="checkbox" name="weekdays" value="五" />
            週五
        </label>
        <label class="weekday-btn">
            <input type="checkbox" name="weekdays" value="六" />
            週六
        </label>
        <label class="weekday-btn">
            <input type="checkbox" name="weekdays" value="日" />
            週日
        </label>
      </div>
    </div>
    <div class="form-row">
      <label class="form-label">每堂課開始時間</label>
      <input type="time" name="every_startTime" required />
    </div>
    <div class="form-row">
      <label class="form-label">每堂課結束時間</label>
      <input type="time" name="every_endTime" required />
    </div>
    <div class="form-row">
	  <label class="form-label">總堂數與產生時間表</label>
	  <div class="half-row">
		<input type="number" name="multi_count" class="half-input" />
		<button type="button" class="btn-generate half-button" onclick="generateSchedule()">產生時間表</button>
	  </div>
	</div>
	<div class="form-row">
	  <label class="form-label">預覽課程時間表</label>
	  <ul id="schedule-preview" class="dropdown-list"></ul>
	</div>

    <div class="form-row">
          <label class="form-label">上限人數</label>
          <input
            type="number"
            name="multi_numPeople"
            placeholder="請輸入最高上限人數"
            required
            min="1"
          />
        </div>
    <div class="form-row">
          <label class="form-label">下限人數</label>
          <input
            type="number"
            name="multi_minPeople"
            placeholder="請輸入最低下限人數"
            required
            min="1"
          />
          <div style="font-size: 12px; color: #666; margin-top: 5px;">
            提醒：報名截止人數未達最低下限，活動將自行取消
          </div>
        </div>
    <div class="form-row">
      <label class="form-label">費用NTD（每位學員）</label>
      <input type="number" name="multi_venue_fee" placeholder="請輸入每位學員費用" step="0.01" min="0" required />
    </div>
    <!-- 【新增】多堂課：是否提供付費會員優惠 -->
    <div class="form-row discount-toggle">
      <label class="row-title">是否提供付費會員優惠</label>
     <div class="switch-row">

      <button type="button" id="allowDiscountSwitchMulti" class="switch" aria-pressed="false" aria-label="是否提供付費會員優惠（多堂）">
        <span class="knob"></span>
      </button>

      <span id="allowDiscountTextMulti" class="hint">關閉（不提供優惠）</span>
      <!-- 送後端的值：0/1 -->
       </div>
      <input type="hidden" name="allow_discount_multi" id="allow_discount_multi" value="0">
    </div>

    <div class="form-row">
      <label class="form-label">報名截止日期</label>
      <input type="datetime-local" name="multi_registration_deadline" required />
    </div>
		<div class="form-row">
	  <label class="form-label">性別</label>
	  <div class="radio-card-group">
		<label class="radio-card">
		  <input type="radio" name="multi_gender" value="男性" required />
		  <span>男性</span>
		</label>
		<label class="radio-card">
		  <input type="radio" name="multi_gender" value="女性" required />
		  <span>女性</span>
		</label>
		<label class="radio-card">
		  <input type="radio" name="multi_gender" value="不限" required />
		  <span>不限</span>
		</label>
	  </div>
	</div>

	<div class="form-row">
	  <label class="form-label">年齡區間</label>
	  <div class="radio-card-group">
		<label class="radio-card">
		  <input type="radio" name="multi_ageRange" value="18-25" required />
		  <span>18–25</span>
		</label>
		<label class="radio-card">
		  <input type="radio" name="multi_ageRange" value="26-35" required />
		  <span>26–35</span>
		</label>
		<label class="radio-card">
		  <input type="radio" name="multi_ageRange" value="36-45" required />
		  <span>36–45</span>
		</label>
		<label class="radio-card">
		  <input type="radio" name="multi_ageRange" value="46-64" required />
		  <span>46–64</span>
		</label>
		<label class="radio-card">
		  <input type="radio" name="multi_ageRange" value="65+" required />
		  <span>65以上</span>
		</label>
		<label class="radio-card">
		  <input type="radio" name="multi_ageRange" value="不限" required />
		  <span>不限</span>
		</label>
	  </div>
	</div>

	<div class="form-row">
	  <label class="form-label">等級</label>
	  <div class="radio-card-group">
		<label class="radio-card">
		  <input type="radio" name="multi_level" value="初學" required />
		  <span>初學</span>
		</label>
		<label class="radio-card">
		  <input type="radio" name="multi_level" value="中階" required />
		  <span>中階</span>
		</label>
		<label class="radio-card">
		  <input type="radio" name="multi_level" value="進階" required />
		  <span>進階</span>
		</label>
		<label class="radio-card">
		  <input type="radio" name="multi_level" value="不限" required />
		  <span>不限</span>
		</label>
	  </div>
	</div>
<!-- ✅ 裝備建議 -->
<div class="form-row" id="equipment-row" style="display:none;">
  <label class="form-label">裝備建議</label>
  <div id="equipment-options" class="radio-card-group" 
       style="flex-wrap: wrap; justify-content:center; gap:10px;">
    <!-- JavaScript 會動態生成 -->
  </div>
</div>
    <div class="form-row">
      <label class="form-label">活動介紹及補充說明</label>
      <textarea name="multi_description" placeholder="EX：地標描述、裝備建議、注意事項..."></textarea>
    </div>
    <input type="hidden" id="location-lat" name="location_lat">
<input type="hidden" id="location-lng" name="location_lng">
     <button type="submit" class="btn-primary" id="multi-submit-btn">發起多堂課程</button>
  </div>


  
</form>

        
        
    <script>
        function setupDiscountSwitch(switchId, hiddenId, hintId){
        const btn = document.getElementById(switchId);
        const hidden = document.getElementById(hiddenId);
        const hint = document.getElementById(hintId);
        if(!btn || !hidden) return; // 沒有該顆就略過（避免報錯）

        function render(isOn){
          btn.classList.toggle('is-on', isOn);
          btn.setAttribute('aria-pressed', String(isOn));
          hidden.value = isOn ? '1' : '0';
          if(hint) hint.textContent = isOn ? '開啟（付費會員享優惠）' : '關閉（不提供優惠）';
        }

        // 預設：關
        render(false);

        btn.addEventListener('click', ()=>{
          const isOn = !btn.classList.contains('is-on');
          render(isOn);
        });
      }

      // 網頁載入後啟動（兩顆都綁；若其中一顆不存在會自動跳過）
      document.addEventListener('DOMContentLoaded', ()=>{
        setupDiscountSwitch('allowDiscountSwitchSingle','allow_discount_single','allowDiscountTextSingle');
        setupDiscountSwitch('allowDiscountSwitchMulti','allow_discount_multi','allowDiscountTextMulti');
      });
        // 當第一次上課時間改變時，自動填入每堂課開始時間並勾選對應每週上課日
  document.addEventListener('DOMContentLoaded', function() {
    const firstTimeInput = document.querySelector('input[name="firstTime"]');
    const startTimeInput = document.querySelector('input[name="every_startTime"]');
    const weekdayInputs = document.querySelectorAll('input[name="weekdays"]');
    if (firstTimeInput) {
      firstTimeInput.addEventListener('change', function() {
        const val = firstTimeInput.value;
        if (!val) return;
        const date = new Date(val);
        if (isNaN(date)) return;
        // 自動填入時間
        const hhmm = val.split('T')[1]?.slice(0,5);
        if (hhmm && startTimeInput) startTimeInput.value = hhmm;
        // 自動勾選星期
        const weekdayMap = { 0: '日', 1: '一', 2: '二', 3: '三', 4: '四', 5: '五', 6: '六' };
        const day = date.getDay();
        weekdayInputs.forEach(input => {
          input.checked = (input.value === weekdayMap[day]);
        });
      });
    }
  });
	  let scheduleList = []; // 存目前課表的陣列
      const sportRadios = document.querySelectorAll('input[name="sport"]');
      const otherSportRow = document.getElementById("other-sport-row");
      const otherSportInput = document.getElementById("other-sport-input");
      const submitBtn = document.getElementById("submitBtn");

      sportRadios.forEach((radio) => {
        radio.addEventListener("change", function () {
          otherSportRow.style.display =
            this.value === "其他" ? "block" : "none";
          if (this.value !== "其他") otherSportInput.value = "";
        });
      });

        function selectCourseType(type) {
            const single = document.getElementById("single-course-form");
            const multi = document.getElementById("multi-course-form");
            const btnSingle = document.getElementById("btn-single");
            const btnMulti = document.getElementById("btn-multi");
            const singleSubmitBtn = document.getElementById("single-submit-btn");
            const multiSubmitBtn = document.getElementById("multi-submit-btn");

            if (type === "single") {
                single.style.display = "block";
                multi.style.display = "none";
                btnSingle.classList.add("active");
                btnMulti.classList.remove("active");
                singleSubmitBtn.style.display = "block";
                multiSubmitBtn.style.display = "none";
            } else {
                single.style.display = "none";
                multi.style.display = "block";
                btnSingle.classList.remove("active");
                btnMulti.classList.add("active");
                singleSubmitBtn.style.display = "none";
                multiSubmitBtn.style.display = "block";
            }
        }

           function togglePastTitles() {
            const list = document.getElementById("pastTitles");
            list.style.display = list.style.display === "none" ? "block" : "none";
            if (list.innerHTML.trim() === "") {
              const urlParams = new URLSearchParams(window.location.search);
              const memberId = urlParams.get("member_id");

              if (!memberId) {
                console.error("無法取得 member_id");
                return;
              }

              fetch(`/api/activities/past_class?member_id=${memberId}`)
                .then((response) => response.json())
                .then((data) => {
                  const uniqueTitles = new Set();
                  data.forEach((activity) => {
                    if (!uniqueTitles.has(activity.title)) {
                      uniqueTitles.add(activity.title);
                      const li = document.createElement("li");
                      li.textContent = `${activity.title} - ${activity.location_name}`;
                      li.style.cursor = "pointer";
                      li.addEventListener("click", () => {
                        document.querySelector('input[name="title"]').value = activity.title;
                        document.querySelector('input[name="location"]').value = activity.location_name;
                        const sportOptions = document.querySelectorAll('input[name="sport"]');
                        sportOptions.forEach((option) => {
                          if (option.value == activity.sport_type_id) {
                            option.checked = true;
                          }
                        });

                        // 更新地圖地標
                        const lat = parseFloat(activity.location_lat);
                        const lng = parseFloat(activity.location_lng);
                        if (!isNaN(lat) && !isNaN(lng)) {
                          const location = { lat, lng };
                          map.setCenter(location);

                          if (marker) marker.setMap(null);
                          marker = new google.maps.Marker({
                            map: map,
                            position: location,
                            title: activity.location_name,
                          });

                          document.getElementById("location-lat").value = lat;
                          document.getElementById("location-lng").value = lng;
                        }

                        list.style.display = "none";
                      });
                      list.appendChild(li);
                    }
                  });
                })
                .catch((error) => console.error("Error fetching past classes:", error));
            }
          }
// ✅ 運動類型與建議裝備對應表（跟活動一致）
const equipmentMapping = {
  1: ["跑鞋", "毛巾", "水壺"],        // 跑步
  2: ["羽球拍", "羽球鞋", "護腕"],      // 羽球
  3: ["瑜珈墊", "毛巾", "水壺"],        // 瑜珈
  4: ["護腰", "水壺", "運動毛巾"],      // 健身
  5: ["安全帽", "手套", "護膝"],        // 騎腳踏車
  6: ["籃球", "護腕", "運動鞋"],        // 籃球
  7: ["泳衣", "泳鏡", "泳帽"],          // 游泳
  8: ["排球", "護膝", "排球鞋"],        // 排球
  9: ["網球拍", "網球鞋", "毛巾"],      // 網球
  10: ["桌球拍", "桌球", "毛巾"],       // 桌球
  11: ["拳擊手套", "護齒", "護腕"],     // 拳擊
  12: ["足球", "護脛", "運動鞋"],       // 足球
};


      fetch("/api/preferences/options")
        .then((response) => response.json())
        .then((data) => {
          const sportOptionsContainer =
            document.getElementById("sport-options");
          data.sport_types.forEach((sport) => {
            const label = document.createElement("label");
            label.className = "radio-card";
            label.innerHTML = `
              <input type="radio" name="sport" value="${sport.sport_type_id}" required />
              ${sport.name}
            `;
            sportOptionsContainer.appendChild(label);
          });
              // ✅ 類型切換 → 裝備建議顯示
    document.getElementById("sport-options").addEventListener("change", (e) => {
      if (e.target && e.target.name === "sport") {
        const selectedSportId = parseInt(e.target.value);
        const equipmentRow = document.getElementById("equipment-row");
        const equipmentOptions = document.getElementById("equipment-options");

        // 清空舊的選項
        equipmentOptions.innerHTML = "";

        if (equipmentMapping[selectedSportId]) {
          equipmentMapping[selectedSportId].forEach(item => {
            const label = document.createElement("label");
            label.className = "radio-card";
            label.innerHTML = `
              <input type="checkbox" name="equipment" value="${item}">
              <span>${item}</span>
            `;
            equipmentOptions.appendChild(label);
          });
          equipmentRow.style.display = "block";
        } else {
          equipmentRow.style.display = "none";
        }
      }
    });

        })
        .catch((error) => console.error("Error fetching sport types:", error));

      const urlParams = new URLSearchParams(window.location.search);
      const memberId = urlParams.get("member_id");

      document
        .getElementById("single-submit-btn")
        .addEventListener("click", function (e) {
          e.preventDefault();
          const formData = new FormData(document.getElementById("classForm"));

          const now = new Date();
          const registrationDeadline = new Date(formData.get("registration_deadline"));
          const startTime = new Date(formData.get("startTime"));
          const endTime = new Date(formData.get("endTime"));


          

          if (registrationDeadline <= now) {
            alert("報名截止日期必須在現在時間之後！");
            return;
          }

          if (startTime <= now) {
            alert("開始時間必須在現在時間之後！");
            return;
          }

          if (endTime <= now) {
            alert("結束時間必須在現在時間之後！");
            return;
          }

          if (registrationDeadline >= startTime) {
            alert("報名截止日期必須早於開始時間！");
            return;
          }

          if (startTime >= endTime) {
            alert("開始時間必須早於結束時間！");
            return;
          }

          const maxParticipants = parseInt(formData.get("numPeople"));
          const minParticipants = parseInt(formData.get("minPeople"));
          
          if (minParticipants > maxParticipants) {
            alert("下限人數不能超過上限人數！");
            return;
          }

          if (!confirm("確定要發起課程嗎？")) {
            return;
          }

          const data = {
            title: formData.get("title"),
            first_time: formData.get("firstTime"),
            start_time: formData.get("startTime"),
            end_time: formData.get("endTime"),
            every_starttime: formData.get("every_startTime"),
            every_endtime: formData.get("every_endTime"),
            weekdays: formData.getAll("weekdays"),
            multi_count: parseInt(formData.get("multi_count")),
            location_name: document.getElementById("place-input").value,
            location_lat: parseFloat(document.getElementById("location-lat").value),
            location_lng: parseFloat(document.getElementById("location-lng").value),
            max_participants: parseInt(formData.get("numPeople")),
            min_participants: parseInt(formData.get("minPeople")),
            venue_fee: parseFloat(formData.get("venue_fee")),
            registration_deadline: formData.get("registration_deadline"),
            organizer_id: memberId, // 使用網址中的 member_id
            level: formData.get("level"),
            gender: formData.get("gender"),
            age_range: formData.get("ageRange"),
            sport_type_id: parseInt(formData.get("sport")),
            description: formData.get("description"),
            status: "open",
            is_discounted: parseInt(formData.get("allow_discount_single")) || 0,
          };

          fetch("/api/activities/class", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          })
            .then((res) => {
              if (res.ok) {
                alert("課程發起成功！");
                window.location.href = `/activity?member_id=${memberId}`;
              } else {
                alert("課程發起失敗，請稍後再試！");
              }
            })
            .catch((err) => {
              console.error("錯誤:", err);
              alert("發起課程時出錯！");
            });
        });

      document
        .getElementById("multi-submit-btn")
        .addEventListener("click", function (e) {
          e.preventDefault();
          const formData = new FormData(document.getElementById("classForm"));

          const now = new Date();
          const registrationDeadline = new Date(formData.get("multi_registration_deadline"));
          const firstTime = new Date(formData.get("firstTime"));
          const everyStartTime = new Date(formData.get("every_startTime"));
          const everyEndTime = new Date(formData.get("every_endTime"));

          if (everyStartTime && everyEndTime) {
            if (everyStartTime >= everyEndTime) {
              alert("每堂課開始時間必須在結束時間之前！");
              return;
            }
          }

          if (registrationDeadline <= now) {
            alert("報名截止日期必須在現在時間之後！");
            return;
          }

          if (!isNaN(firstTime.getTime())) {
            if (firstTime <= now) {
              alert("第一次上課時間必須在現在時間之後！");
              return;
            }

            if (registrationDeadline >= firstTime) {
              alert("報名截止日期必須早於第一次上課時間！");
              return;
            }
          }

          const maxParticipants = parseInt(formData.get("multi_numPeople"));
          const minParticipants = parseInt(formData.get("multi_minPeople"));
          
          if (minParticipants > maxParticipants) {
            alert("下限人數不能超過上限人數！");
            return;
          }

          if (!confirm("確定要發起多堂課程嗎？")) {
            return;
          }

          const data = {
            title: formData.get("title"),
            sport_type_id: parseInt(formData.get("sport")),
            first_time: formData.get("firstTime"),
            every_starttime: formData.get("every_startTime"),
            every_endtime: formData.get("every_endTime"),
            weekdays: formData.getAll("weekdays"),
            multi_count: parseInt(formData.get("multi_count")),
            max_participants: parseInt(formData.get("multi_numPeople")),
            min_participants: parseInt(formData.get("multi_minPeople")),
            gender: formData.get("multi_gender"),
            age_range: formData.get("multi_ageRange"),
            level: formData.get("multi_level"),
            location_name: document.getElementById("place-input").value,
            location_lat: parseFloat(document.getElementById("location-lat").value),
            location_lng: parseFloat(document.getElementById("location-lng").value),
            venue_fee: parseFloat(formData.get("multi_venue_fee")),
            registration_deadline: formData.get("multi_registration_deadline"),
            organizer_id: memberId, // 使用網址中的 member_id
            description: formData.get("multi_description"),
            status: "open",
            scheduleList: scheduleList, // 添加 scheduleList
            is_discounted: parseInt(formData.get("allow_discount_multi")) || 0,
          };

          fetch("/api/activities/multiclass", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          })
            .then((res) => {
              if (res.ok) {
                alert("多堂課程發起成功！");
                window.location.href = `/activity?member_id=${memberId}`;
              } else {
                alert("多堂課程發起失敗，請稍後再試！");
              }
            })
            .catch((err) => {
              console.error("錯誤:", err);
              alert("發起多堂課程時出錯！");
            });
        });

      function sportNameToId(sport) {
        const mapping = {
          跑步: 1,
          羽球: 2,
          瑜珈: 3,
          健身: 4,
          騎單車: 5,
          籃球: 6,
          游泳: 7,
          排球: 8,
          網球: 9,
          棒球: 10,
          足球: 11,
        };
        return mapping[sport] || 0;
			  }
			 function generateSchedule() {
		  const firstTimeInput = document.querySelector('input[name="firstTime"]');
		  const weekdayInputs = document.querySelectorAll('input[name="weekdays"]:checked');
		  const startTimeInput = document.querySelector('input[name="every_startTime"]');
		  const endTimeInput = document.querySelector('input[name="every_endTime"]');
		  const countInput = document.querySelector('input[name="multi_count"]');
		  const previewList = document.getElementById("schedule-preview");

		  previewList.innerHTML = "";
		  scheduleList = []; // 清空舊資料

		  const firstDate = new Date(firstTimeInput.value);
		  if (isNaN(firstDate)) {
			alert("請先輸入第一次上課時間");
			return;
		  }

		  const weekdays = Array.from(weekdayInputs).map(input => input.value);
		  if (weekdays.length === 0) {
			alert("請選擇每週上課日");
			return;
		  }

		  const startTime = startTimeInput.value;
		  const endTime = endTimeInput.value;
		  const totalCount = parseInt(countInput.value);
		  if (!startTime || !endTime || isNaN(totalCount) || totalCount <= 0) {
			alert("請完整輸入時間與堂數");
			return;
		  }

      const weekdayMap = { "日": 0, "一": 1, "二": 2, "三": 3, "四": 4, "五": 5, "六": 6 };
      const targetWeekdays = weekdays.map(w => weekdayMap[w]);

      // 檢查第一次上課時間的星期是否有選到
      const firstDay = firstDate.getDay();
      if (!targetWeekdays.includes(firstDay)) {
        alert("第一次上課時間的星期必須包含在每週上課日中！");
        return;
      }
      // 檢查第一次上課時間的時間部分是否等於每堂課開始時間
      const firstTimeStr = firstDate.toTimeString().slice(0,5); // HH:MM
      if (firstTimeStr !== startTime) {
        alert("每堂課開始時間必須等於第一次上課時間的時間部分！");
        return;
      }
      // 檢查每堂課結束時間必須晚於開始時間
      if (startTime >= endTime) {
        alert("每堂課結束時間必須晚於開始時間！");
        return;
      }

		  let date = new Date(firstDate);
		  while (scheduleList.length < totalCount) {
			if (targetWeekdays.includes(date.getDay())) {
			  const dateStr = date.toISOString().split("T")[0];
			  scheduleList.push(`${dateStr} ${startTime} ~ ${endTime}`);
			}
			date.setDate(date.getDate() + 1);
		  }

		  renderScheduleList();
		}
		function renderScheduleList() {
		  const previewList = document.getElementById("schedule-preview");
		  previewList.innerHTML = "";

		  scheduleList.forEach((line, index) => {
			const li = document.createElement("li");
			li.innerHTML = `第 ${index + 1} 堂：${line} 
			  <button type="button" onclick="deleteSchedule(${index})" 
				style="margin-left: 8px; color: red; border: none; background: none; cursor: pointer;">✖</button>`;
			previewList.appendChild(li);
		  });

		  // ✅ 自動更新總堂數欄位
		  const countInput = document.querySelector('input[name="multi_count"]');
		  countInput.value = scheduleList.length;
		}

		function deleteSchedule(index) {
		  if (!confirm(`你確定要刪除第 ${index + 1} 堂課嗎？`)) return;
		  scheduleList.splice(index, 1); // 刪掉該堂課
		  renderScheduleList(); // 重新渲染清單
		}


    </script>
    <!-- Google Maps JS 載入 -->
    <script>
      let map, marker, autocomplete, geocoder, places;

// 幫手：放標記 + 更新隱藏欄位
function setMarkerAndUpdateUI(latLng, displayText) {
  if (!marker) {
    marker = new google.maps.Marker({
      map,
      position: latLng,
      draggable: true,
    });
    // 拖曳結束 → 更新地址
    marker.addListener("dragend", () => handleLatLngChange(marker.getPosition()));
  } else {
    marker.setPosition(latLng);
  }

  map.panTo(latLng);
  document.getElementById("location-lat").value = latLng.lat();
  document.getElementById("location-lng").value = latLng.lng();

  if (displayText) {
    document.getElementById("place-input").value = displayText;
  }
}

// 幫手：反查地址
function reverseGeocodeAndFillInput(latLng) {
  const input = document.getElementById("place-input");
  geocoder.geocode({ location: latLng }, (results, status) => {
    if (status === "OK" && results && results[0]) {
      const first = results[0];
      const placeId = first.place_id;

      if (placeId) {
        places.getDetails({ placeId, fields: ["name", "formatted_address"] }, (detail, s2) => {
          const name = detail && detail.name;
          const addr = (detail && detail.formatted_address) || first.formatted_address;
          input.value = name || addr || "未知地址";
        });
      } else {
        input.value = first.formatted_address || "未知地址";
      }
    } else {
      input.value = "未知地址";
    }
  });
}

// 幫手：座標改變時統一處理
function handleLatLngChange(latLng) {
  setMarkerAndUpdateUI(latLng);
  reverseGeocodeAndFillInput(latLng);
}

// 新版 initAutocomplete
function initAutocomplete() {
  console.log("✅ initAutocomplete 已執行！");

  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 25.0330, lng: 121.5654 },
    zoom: 15,
  });

  geocoder = new google.maps.Geocoder();
  places   = new google.maps.places.PlacesService(map);

  const input = document.getElementById("place-input");
  autocomplete = new google.maps.places.Autocomplete(input, {
  types: ["establishment", "geocode"], // ✅ 支援地標 + 地址
  componentRestrictions: { country: "tw" },
});

  // 使用者選了建議地址
  autocomplete.addListener("place_changed", () => {
    const place = autocomplete.getPlace();
    if (!place || !place.geometry || !place.geometry.location) {
      alert("找不到此地址的地理位置，請重新輸入！");
      return;
    }
    const loc = place.geometry.location;
    const display = place.name || place.formatted_address || input.value;
    setMarkerAndUpdateUI(loc, display);
  });

  // 點一下地圖也能放標記
  map.addListener("click", (e) => {
    handleLatLngChange(e.latLng);
  });
}
    </script>
    
    <!-- ✅ 將 Google Maps 的 script 放到最下方 -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC2K8DZKTi1bzEDRlwbqd7xzCByJxYjRIw&libraries=places&callback=initAutocomplete" defer></script>
    </body>
    </html>