<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>活動評價</title>

    <style>
      :root {
        --main-color: #81d3e1;
        --deep-blue: #2c4975;
        --text-color: #444;
        --bg-color: #f5f5f5;
        --avatar-size: 48px;      /* ← 頭像直徑（調大調小都靠它） */
        --avatar-col-gap: 20px;   /* ← 同一排頭像之間的水平間距（中間間距） */
        --avatar-row-gap: 12px;   /* ← 每一排與下一排的垂直間距 */
        --container-max: 500px;   /* 和 .container 的 max-width 一致 */
        --page-xpad: 20px;        /* 和 body 的左右 padding 一致 */
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: var(--bg-color);
        margin: 0;
        padding: 0px 20px;
      }

      .page-header {
        position: sticky;
        top: 0;
        z-index: 100;
        background-color: #ffffff;
        display: flex;
        align-items: center;
        padding: 10px 16px;
        border-bottom: 1px solid #eee;
        margin: 0 -20px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
      }

      .arrow-icon {
        fill: #2c4975;
        transition: fill 0.2s ease;
        cursor: pointer;
        flex-shrink: 0;
        margin-left: 10px;
      }

      .arrow-icon:hover {
        fill: #64bcd0;
      }

      .header-center {
        display: flex;
        align-items: center;
        margin: 12px auto;
        gap: 8px;
      }

      .header-logo {
        width: 45px;
        height: 45px;
        margin-top: 10px;
      }

      .header-title {
        font-size: 18px;
        font-weight: bold;
        color: #2c4975;
      }

      /* ✅ 新增白底置中容器樣式 */
      .container {
        background-color: #ffffff;
        max-width: var(--container-max);  /* ← 用變數 */
        margin: 0px auto;
        padding: 0px 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
		    min-height: calc(100vh - 66px); /* 扣掉 header 的高度（依實際高度調整） */
	      box-sizing: border-box;
	      display: flex;
	      flex-direction: column;
	      justify-content: flex-start;
		    padding-bottom: 30px;
      }

     .activity-title {
	   font-size: 24px;
	   font-weight: bold;
	   color: var(--deep-blue);
	   border-bottom: 1px solid var(--main-color);
	   padding-bottom: 15px;
	   margin-bottom: 12px;
	   margin-top: 20px;
	 }

      .section {
        margin-top: 2px;
      }

      .section-title {
        font-size: 18px;
        
        color: var(--deep-blue);
        margin-bottom: 0px;
      }

		.star-container {
		  display: flex;
		  gap: 8px;
		  align-items: center;
		  margin-bottom: 8px;
		}

		.star {
		  cursor: pointer;
		}

		.star svg {
		  width: 32px;
		  height: 32px;
		  fill: #cccccc; /* 預設灰色 */
		  transition: fill 0.2s ease;
		}

		.star.active svg {
		  fill: #fcbf1b; /* 選中時變金色 */
		}


      .tag-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 15px;
        margin-bottom: 15px;
        border-bottom: 1px solid var(--main-color);
        padding-bottom: 20px;
      }

      .tag {
        padding: 6px 12px;
        border-radius: 20px;
        background: #f0f0f0;
        border: 1px solid #ccc;
        cursor: pointer;
        font-size: 14px;
        user-select: none;
        transition: background-color 0.2s;
      }

      .tag.active {
        background-color: var(--main-color);
        color: white;
        border-color: var(--main-color);
      }

      .note {
        font-size: 14px;
        color: #64BCD0;
        margin-bottom: 10px;
		    margin-top: 2px;
        font-weight: bold;
      }
	 .evaluate-container {
		display: flex;
		gap: 24px;
	box-sizing: border-box;
	  }



	  .avatar-block {
      position: relative;
      min-width: var(--avatar-size);
		  display: flex;
		  flex-direction: column;
		  align-items: center;
		  cursor: pointer;
		  text-align: center;
	  }
		.avatar-svg {
      position: relative;
      display: inline-block;  /* 或 block，隨你需求 */
    }	  
    .avatar-svg svg,
    .avatar-svg img {
      width: var(--avatar-size);
      height: var(--avatar-size);
      display: block;  
    }
		.avatar-name {
      max-width: var(--avatar-size);
      margin-top: 6px;            /* 視覺間距 */
      font-size: 13px;
      overflow-wrap: anywhere;    /* 名字太長就換行，不把版面撐爆 */
      text-align: center;
    }

		.feedback-output {
			width: 100%;
		  box-sizing: border-box;
      overflow-x: auto;   /* 預防內容真的爆掉時橫向滾動，而不是推寬父容器 */
		  max-height: 0;
		  opacity: 0;
		  overflow: hidden;
		  transition: max-height  0.25s cubic-bezier(.23,1.21,.51,1.02), opacity 0.25s, padding 0.25s;
      padding: 0 12px;
		  padding: 0 12px;
		  margin-top: 12px;
		}

		.feedback-output.active {
		  max-height: 500px; /* 根據實際內容高度調整 */
		  opacity: 1;
		  padding: 12px;
		}
		#user-stars {
		  display: flex;
		  flex-wrap: wrap;
		  gap: 8px;
		  justify-content: flex-start;
		}
		.avatar-arrow {
		  width: 0;
		  height: 0;
		  margin-top: 2px;
      margin-bottom: -20px;
		  border-left: 12px solid transparent;
		  border-right: 12px solid transparent;
		  border-top: 12px solid #81d3e1; /* 箭頭顏色，和主色一致 */
		  display: none;
		  transition: opacity 0.2s;
		}
		.avatar-block.active-user .avatar-arrow {
		  display: block;
		  /* 你可以加個動畫進場，如果想更有感 */
		  opacity: 1;
		  /* 可以加點陰影，讓箭頭更立體 */
		  filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));
		}
		.submit-evaluation-btn {
		  background-color: #81d3e1;
		  color: #fff;
		  font-size: 18px;
		  border: none;
		  width: 100%;
		  margin: 36px 0 0 0;
		  border-radius: 8px;
		  height: 42px;
		  box-shadow: 0 2px 10px rgba(252,167,167,0.08);
		  letter-spacing: 2px;
		  cursor: pointer;
		  transition: background 0.18s, filter 0.18s;
		  display: block;
      margin-top: 8px;

		}
    .submit-evaluation-btn:hover {
        background-color: #2c4975;
       
    }
    .avatar-rows {
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }
    .avatar-row {
      display: grid;
      /* 以前是固定 5 欄 → 改成自動填滿、寬度不夠就自動掉到下一排 */
      grid-template-columns: repeat(auto-fit, minmax(var(--avatar-size), 1fr));
      /* 上下間距、左右間距：用 clamp 縮小時自動收斂，避免擠爆 */
      gap: var(--avatar-row-gap) clamp(12px, 5vw, var(--avatar-col-gap));
      padding: 8px 6px 0 0px;
      width: 100%;
      box-sizing: border-box;
    }

    .avatar-done-icon {
      position: absolute;
      right: 0;    /* 改成0 */
      bottom: 0;   /* 改成0 */
      width: 15px;
      height: 15px;
      background: #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      border: 2px solid #fff;
      padding: 0;
      display: none; /* 預設隱藏，填完才顯示 */
    }


    .fade-out {
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
    }
    .fade-in {
      opacity: 1;
      transition: opacity 0.2s;
    }
    .blacklist-btn {
      background: #fea3a8;
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 6px 16px;
      font-size: 15px;
      margin-left: 12px;
      cursor: pointer;
      transition: opacity 0.2s;
      display: inline-block;
    }
    .blacklist-btn:hover {
      background: #c93c4e;
      box-shadow: 0 2px 10px rgba(241,91,91,0.16);

      transition: all 0.17s;
    }
    /* 批次列黑彈窗 */
   /* 跟 .container 一樣：桌機最多 500px，手機吃滿遮罩剩下的寬度 */
    .blk-card{
      background:#fff;
      border-radius:8px;
      width: 100%;                  /* 先吃滿遮罩 */
      max-width: 500px;             /* 和 .container 的 max-width 一致 */
      /* 若你用變數，改成：max-width: var(--container-max); */
      padding:24px;
      box-shadow:0 10px 30px rgba(0,0,0,.2);
      box-sizing: border-box;
      overflow-x: hidden;           /* 防止內部元素把卡片撐出橫向捲軸 */
    }

    .blk-title       { color:#2c4975; font-size:18px; font-weight:500; margin-bottom:6px; }
    .blk-sub         { color:#64bcd0; margin-bottom:12px; font-weight:bold; font-size:14px; }
    .blk-list        { max-height:46vh; overflow:auto; padding-right:4px; margin-bottom:14px; overflow-x:hidden; }
    .blk-row         { display:grid; grid-template-columns:24px 1fr 260px; gap:12px; align-items:center; padding:12px 0; border-bottom:1px solid #eee; }
    .blk-name        { color:#2c4975; font-weight:600; }
    .blk-fields      { display:flex; gap:8px; }
    .blk-reason,
    .blk-other       { padding:6px 8px; font-size:14px; border:1px solid #ddd; border-radius:6px; }
    .blk-actions     { display:flex; justify-content:flex-end; gap:10px; }
    .btn             { padding:8px 16px; border:none; border-radius:8px; font-size:15px; }
    .btn-ghost       { background:#eee; }
    .btn-danger      { background:#f15b5b; color:#fff; opacity:.5; } /* 會被 JS 切換 disabled 狀態 */

    /* 把 480px 改成 600px（或 640px，看你需求） */
    @media (max-width: 600px){
      .blk-row{
        grid-template-columns: 24px 1fr;   /* 兩欄：勾選 + 名字 */
        align-items: flex-start;
      }
      .blk-name{ margin-top: 2px; }

      /* 理由欄改放下一行、吃滿寬 */
      .blk-fields{
        grid-column: 2 / -1;
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
        width: 100%;
      }

      .blk-reason,
      .blk-other{
        width: 100%;
        max-width: 100%;
        min-width: 0;               /* 防止 select 的最小寬撐爆 */
      }
    }

    /* 清單本身只允許縱向捲動 */
    .blk-list{
      max-height:46vh;
      overflow-y:auto;
      overflow-x:hidden;
    }

    /* 讓遮罩本身留出和頁面一樣的左右 20px 內距 */
    #bulk-blacklist-modal{
      padding: 0 20px;           /* = 和 body 的左右 padding 一致 */
      box-sizing: border-box;
    }

    html, body { max-width: 100%; overflow-x: hidden; }

    </style>
  </head>

  <body>
    <script>
        // 頁面載入時檢查是否已評價
        document.addEventListener('DOMContentLoaded', async function() {
          const urlParams = new URLSearchParams(window.location.search);
          const activityId = urlParams.get('activity_id');
          const memberId = urlParams.get('member_id');
          if (activityId && memberId) {
            try {
              const res = await fetch(`/api/activities/${activityId}/participants`);
              if (res.ok) {
                const participants = await res.json();
                // 找出當前使用者
                const me = participants.find(p => String(p.user_id) === String(memberId));
                if (me && me.has_review) {
                  alert('您已評價過此活動，將自動返回上一頁');
                  window.history.back();
                }
              }
            } catch (e) {}
          }
        });
      </script>
    <header class="page-header">
      <svg class="arrow-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 256 256" onclick="redirectToMemberView()">
        <path d="M228,128a12,12,0,0,1-12,12H69l51.52,51.51a12,12,0,0,1-17,17l-72-72a12,12,0,0,1,0-17l72-72a12,12,0,0,1,17,17L69,116H216A12,12,0,0,1,228,128Z"/>
      </svg>
      <div class="header-center">
        <span class="header-title">活動評價</span>
      </div>
    </header>

    <!-- ✅ 白底內容容器開始 -->
    <div class="container">
	<div class="activity-title">輕鬆認識拍友團</div>
      <div class="section">
        <div class="section-title">評價此活動</div>
        <div class="note">從流程、氣氛到內容，給主辦人一個回饋吧！</div>

		<div class="star-container" id="activity-stars">
		  <span class="star" data-score="1">
			<svg viewBox="0 0 256 256"><path d="M234.29,114.85l-45,38.83L203,211.75a16.4,16.4,0,0,1-24.5,17.82L128,198.49,77.47,229.57A16.4,16.4,0,0,1,53,211.75l13.76-58.07-45-38.83A16.46,16.46,0,0,1,31.08,86l59-4.76,22.76-55.08a16.36,16.36,0,0,1,30.27,0l22.75,55.08,59,4.76a16.46,16.46,0,0,1,9.37,28.86Z"/></svg>
		  </span>
		  <span class="star" data-score="2">
			<svg viewBox="0 0 256 256"><path d="M234.29,114.85l-45,38.83L203,211.75a16.4,16.4,0,0,1-24.5,17.82L128,198.49,77.47,229.57A16.4,16.4,0,0,1,53,211.75l13.76-58.07-45-38.83A16.46,16.46,0,0,1,31.08,86l59-4.76,22.76-55.08a16.36,16.36,0,0,1,30.27,0l22.75,55.08,59,4.76a16.46,16.46,0,0,1,9.37,28.86Z"/></svg>
		  </span>
		  <span class="star" data-score="3">
			<svg viewBox="0 0 256 256"><path d="M234.29,114.85l-45,38.83L203,211.75a16.4,16.4,0,0,1-24.5,17.82L128,198.49,77.47,229.57A16.4,16.4,0,0,1,53,211.75l13.76-58.07-45-38.83A16.46,16.46,0,0,1,31.08,86l59-4.76,22.76-55.08a16.36,16.36,0,0,1,30.27,0l22.75,55.08,59,4.76a16.46,16.46,0,0,1,9.37,28.86Z"/></svg>
		  </span>
		  <span class="star" data-score="4">
			<svg viewBox="0 0 256 256"><path d="M234.29,114.85l-45,38.83L203,211.75a16.4,16.4,0,0,1-24.5,17.82L128,198.49,77.47,229.57A16.4,16.4,0,0,1,53,211.75l13.76-58.07-45-38.83A16.46,16.46,0,0,1,31.08,86l59-4.76,22.76-55.08a16.36,16.36,0,0,1,30.27,0l22.75,55.08,59,4.76a16.46,16.46,0,0,1,9.37,28.86Z"/></svg>
		  </span>
		  <span class="star" data-score="5">
			<svg viewBox="0 0 256 256"><path d="M234.29,114.85l-45,38.83L203,211.75a16.4,16.4,0,0,1-24.5,17.82L128,198.49,77.47,229.57A16.4,16.4,0,0,1,53,211.75l13.76-58.07-45-38.83A16.46,16.46,0,0,1,31.08,86l59-4.76,22.76-55.08a16.36,16.36,0,0,1,30.27,0l22.75,55.08,59,4.76a16.46,16.46,0,0,1,9.37,28.86Z"/></svg>
		  </span>
		</div>



        <div class="section-title">這次活動感覺如何？（可複選）</div>
        <div id="activity-tags" class="tag-container"></div>
      </div>
	  <div class="section-title">評價其他參加者</div>
	  <div class="note">點選頭像可為該參加者給予星等與標籤回饋！</div>
	  <div class="evaluate-container">
      <div class="avatar-rows"></div>
	  </div>
		<div class="fixed-submit-btn-bar">
	  <button type="button" class="submit-evaluation-btn">送出評價</button>
	</div>
</div>
	</div>
	<!-- 批次黑名單彈窗（送出評價後才會出現） -->
  <div id="bulk-blacklist-modal" style="display:none; position:fixed; z-index:9999; inset:0; background:rgba(0,0,0,.35); align-items:center; justify-content:center;">
    <div class="blk-card">
      <div class="blk-title">評價已送出！</div>
      <div class="blk-sub">你給了以下參加者 1 星，是否將他們列入黑名單？</div>
      <div id="bulk-blacklist-list" class="blk-list"></div>
      <div class="blk-actions">
        <button id="bulk-blacklist-skip" class="btn btn-ghost">跳過</button>
        <button id="bulk-blacklist-confirm" class="btn btn-danger" disabled>確認列入黑名單</button>
      </div>
    </div>
  </div>


    <!-- ✅ 白底內容容器結束 -->

    <script>
      // 星星互動邏輯
      let selectedActivityStars = 0;
		const activityStars = document.querySelectorAll("#activity-stars .star");

		
activityStars.forEach(star => {
  star.addEventListener("click", () => {
    selectedActivityStars = parseInt(star.dataset.score);
    activityStars.forEach(s => {
      s.classList.toggle("active", parseInt(s.dataset.score) <= selectedActivityStars);
    });
    if (selectedActivityStars > 0) {
      loadActivityTagsByStars(selectedActivityStars);
    }
  });
});

function loadActivityTagsByStars(stars) {
activityTagContainer.classList.remove('fade-in');
activityTagContainer.classList.add('fade-out');

fetch(`/api/review_templates?stars=${stars}`)
  .then(res => res.json())
  .then(data => {
    setTimeout(() => {
      activityTagContainer.innerHTML = '';
      selectedActivityTemplateIds.clear();
      data.forEach(item => {
        const tag = document.createElement("div");
        tag.className = "tag";
        tag.innerText = item.text;
        tag.addEventListener("click", () => {
          tag.classList.toggle("active");
          if (selectedActivityTemplateIds.has(item.template_id)) {
            selectedActivityTemplateIds.delete(item.template_id);
          } else {
            selectedActivityTemplateIds.add(item.template_id);
          }
        });
        activityTagContainer.appendChild(tag);
      });
      activityTagContainer.classList.remove('fade-out');
      activityTagContainer.classList.add('fade-in');
    }, 180); // 時間和 transition 一樣
  });

}



		;

      // 評價 tag 互動
      // 活動評價標籤由 API 動態載入


      const selectedActivityTemplateIds = new Set();
      const activityTagContainer = document.getElementById("activity-tags");

      // 可給後端呼叫的函式
      function getActivityEvaluation() {
        return {
          stars: selectedStars,
          tags: Array.from(selectedActivityTemplateIds)
        };
      }

      // 返回頁面
      function getMemberIdFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('member_id');
}

      function redirectToMemberView() {
        const memberId = getMemberIdFromURL();
        if (memberId) {
          window.location.href = `/activity?member_id=${memberId}`;
        } else {
           window.location.href = '/'; // 或導回登入頁
  }
}
	      const blocks = document.querySelectorAll('.avatar-block');
const feedbackSlot1 = document.getElementById('feedback-slot-1');
const feedbackSlot2 = document.getElementById('feedback-slot-2');
let activeUser = null;


const selectedUserStarsMap = new Map(); // 儲存每個 user 的星星
const selectedUserTagsMap = new Map();
const selectedUserTemplateMap = new Map();  // 儲存每個 user 的 tag（Set）

blocks.forEach(block => {
  block.addEventListener('click', () => {
    const user = block.dataset.user;
    const slot = (['user1','user2','user3','user4','user5'].includes(user)) ? feedbackSlot1 : feedbackSlot2;

    // 防切換（有填但未完成不可切）
    let preventSwitch = false;
    if (activeUser) {
      const stars = selectedUserStarsMap.get(activeUser);
      const tags = selectedUserTagsMap.get(activeUser);
      const hasFilled = (stars > 0) || (tags && tags.size > 0);
      const isComplete = isUserEvaluationComplete(activeUser);
      preventSwitch = hasFilled && !isComplete;
    }

    // 點自己且尚未填寫 ➜ 收合
    if (activeUser === user && !(selectedUserStarsMap.get(user) > 0) && !(selectedUserTagsMap.get(user) && selectedUserTagsMap.get(user).size > 0)) {
      slot.classList.remove('active');
      setTimeout(() => { slot.innerHTML = ''; }, 250); // 給收合動畫時間
      activeUser = null;
      block.classList.remove('active-user');
    } else if (activeUser !== user) {
      if (preventSwitch) {
        alert("請先完成目前這位參加者的星等與標籤評價！");
        return;
      }
      // 換人時滑順收合
      slot.classList.remove('active');
      setTimeout(() => {
        renderUserEvaluation(user, slot);
        slot.classList.add('active');
      }, 220);  // 與 CSS transition 時間相同
      blocks.forEach(b => b.classList.remove('active-user'));
      block.classList.add('active-user');
      activeUser = user;
    }
  });
});




// 標籤互動


function renderUserEvaluation(user, slot) {
  // 直接覆蓋自己這個 slot（不用 setTimeout）
  slot.classList.remove('active');
  slot.innerHTML = `
  <div class="star-container" id="user-stars">
    ${[1,2,3,4,5].map(score => `
      <span class="star" data-score="${score}">
        <svg viewBox="0 0 256 256"><path d="M234.29,114.85l-45,38.83L203,211.75a16.4,16.4,0,0,1-24.5,17.82L128,198.49,77.47,229.57A16.4,16.4,0,0,1,53,211.75l13.76-58.07-45-38.83A16.46,16.46,0,0,1,31.08,86l59-4.76,22.76-55.08a16.36,16.36,0,0,1,30.27,0l22.75,55.08,59,4.76a16.46,16.46,0,0,1,9.37,28.86Z"/></svg>
      </span>`).join('')}
    <button class="blacklist-btn" style="display:none; margin-left: 14px;">列入黑名單</button>
  </div>
  <div id="user-tags"></div>

  <!-- 黑名單理由 Modal -->
  <div id="blacklist-modal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); align-items:center; justify-content:center;">
    <div style="background:#fff; padding:32px 24px 24px 24px; border-radius:12px; min-width:320px; max-width:90vw; box-shadow:0 2px 16px rgba(0,0,0,0.18); position:relative;">
      <div style="font-size:18px; font-weight:bold; margin-bottom:16px;">請選擇列入黑名單的理由</div>
      <select id="blacklist-reason-select" style="width:100%; font-size:16px; padding:6px 8px; margin-bottom:16px;">
        <option value="">請選擇理由</option>
        <option value="惡意言語或騷擾">惡意言語或騷擾</option>
        <option value="違反活動規則">違反活動規則</option>
        <option value="放鳥/未到場">放鳥/未到場</option>
        <option value="其他">其他</option>
      </select>
      <input id="blacklist-reason-other" style="display:none; width:100%; font-size:15px; padding:6px 8px; margin-bottom:16px;" placeholder="請輸入其他理由..." />
      <div style="text-align:right;">
        <button id="blacklist-cancel-btn" style="margin-right:12px; padding:6px 18px; border:none; background:#eee; border-radius:6px; font-size:15px;">取消</button>
        <button id="blacklist-confirm-btn" style="padding:6px 18px; border:none; background:#f15b5b; color:#fff; border-radius:6px; font-size:15px;">確認</button>
      </div>
    </div>
  </div>

  `;
  // 新增：取得名稱
  const userName = document.querySelector(`.avatar-block[data-user="${user}"] .avatar-name`)?.textContent || '這位參加者';
  initUserStars(user, userName);

  initUserStars(user);
  let userStars = selectedUserStarsMap.get(user) || 0;
    if (userStars > 0) {
      loadUserTagsByStars(userStars, "user-tags");
    }
  // 更新頭像勾勾
  document.querySelectorAll('.avatar-block').forEach(b => {
    const u = b.dataset.user;
    const done = isUserEvaluationComplete(u);
    const check = b.querySelector('.avatar-done-icon');
    if (check) check.style.display = done ? 'flex' : 'none';
  });
}

function isUserEvaluationComplete(user) {
  const stars = selectedUserStarsMap.get(user);
  const tags = selectedUserTagsMap.get(user);
  return stars > 0 && tags && tags.size > 0;
}
    
const urlParams = new URLSearchParams(window.location.search);
const activityId = urlParams.get('activity_id');
const currentUserId = urlParams.get('member_id');





document.querySelector('.submit-evaluation-btn').addEventListener('click', () => {
    if (selectedActivityStars === 0) {
    alert('請先評分此活動星等！');
    return;
  }
    if (selectedActivityTemplateIds.size === 0) {
    alert('請至少選一個活動標籤！');
    return;
  }
  const activityPayload = {
    activity_id: parseInt(activityId),
    member_id: currentUserId,
    stars: selectedActivityStars,
    tags: Array.from(selectedActivityTemplateIds)
  };

  const userPayloads = [];
  selectedUserStarsMap.forEach((stars, userId) => {
    userPayloads.push({
      activity_id: parseInt(activityId),
      member_id: currentUserId,
      target_user_id: userId,
      stars: stars,
      tags: Array.from(selectedUserTemplateMap.get(userId) || [])
    });
  });

  Promise.all([
    fetch('/api/activity_reviews', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(activityPayload)
    }),
    fetch('/api/user_reviews/bulk', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(userPayloads)
    })
 /* ]).then(() => {
    alert('評價已送出！');
    window.location.href = `/activity?member_id=${encodeURIComponent(currentUserId)}`;
  }).catch(err => {*/
    ]).then(() => {
    // 檢查是否有人被評 1 星；有的話 → 彈出批次列黑彈窗
      const oneStarUsers = getOneStarUsers();
      if (oneStarUsers.length === 0) {
        alert('評價已送出！');
        window.location.href = `/activity?member_id=${encodeURIComponent(currentUserId)}`;
      } else {
        showBulkBlacklistModal(oneStarUsers);
      }
    }).catch(err => {
    console.error(err);
    alert('送出失敗，請稍後再試');
  });
});

// 1. 讓 participants 陣列全域可用
let participantsArr = [];
fetch(`/api/activities/${activityId}/participants`)
  .then(res => res.json())
  .then(participants => {
    window.participantsArr = participants;
    participantsArr = participants;

    const avatarRows = document.querySelector('.avatar-rows');
    avatarRows.innerHTML = '';
    const filtered = participants.filter(p => p.user_id != currentUserId);

    for (let i = 0; i < filtered.length; i += 5) {
      // 1. 新增一排
      const row = document.createElement('div');
      row.className = 'avatar-row';

      filtered.slice(i, i + 5).forEach(p => {
        const block = document.createElement('div');
        block.className = 'avatar-block';
        block.dataset.user = p.user_id;
        block.innerHTML = `
          <div class="avatar-svg">
            <img id="avatarImage" src="/static/avatars/${p.user_id}.png" alt="會員頭像" width="56" height="56" style="border-radius:50%;" onerror="this.src='/static/avatars/default.jpg';">
            <span class="avatar-done-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" fill="#1ba711" viewBox="0 0 256 256" style="display:block;">
                <path d="M243.31,90.91l-128.4,128.4a16,16,0,0,1-22.62,0l-71.62-72a16,16,0,0,1,0-22.61l20-20a16,16,0,0,1,22.58,0L104,144.22l96.76-95.57a16,16,0,0,1,22.59,0l19.95,19.54A16,16,0,0,1,243.31,90.91Z"></path>
              </svg>
            </span>         
          </div>

          <div class="avatar-name">${p.name}</div>
          <div class="avatar-arrow"></div>
        `;


        row.appendChild(block);
      });

      avatarRows.appendChild(row);

      // 2. 新增插槽
      const slot = document.createElement('div');
      slot.className = 'feedback-output';
      slot.dataset.row = Math.floor(i / 5);
      avatarRows.appendChild(slot);
    }
    initAvatarClickEvents(); // 這個要修正成新版，見下
  });


function initAvatarClickEvents() {
  const blocks = document.querySelectorAll('.avatar-block');
  blocks.forEach((block, idx) => {
    block.addEventListener('click', () => {
      const user = block.dataset.user;
      const rowIdx = Math.floor(idx / 5); // 算出自己在第幾排
      const slot = document.querySelectorAll('.feedback-output')[rowIdx];
      let preventSwitch = false;
      if (activeUser) {
        const stars = selectedUserStarsMap.get(activeUser);
        const tags = selectedUserTagsMap.get(activeUser);
        const hasFilled = (stars > 0) || (tags && tags.size > 0);
        const isComplete = isUserEvaluationComplete(activeUser);
        preventSwitch = hasFilled && !isComplete;
      }
      if (activeUser === user && !(selectedUserStarsMap.get(user) > 0) && !(selectedUserTagsMap.get(user) && selectedUserTagsMap.get(user).size > 0)) {
        slot.classList.remove('active');
        setTimeout(() => { slot.innerHTML = ''; }, 250);
        activeUser = null;
        block.classList.remove('active-user');
      } else if (activeUser !== user) {
        if (preventSwitch) {
          alert("請先完成目前這位參加者的星等與標籤評價！");
          return;
        }
        // 收合所有 slot
        document.querySelectorAll('.feedback-output').forEach(s => {
          s.classList.remove('active');
          s.innerHTML = '';
        });
        // 展開當前 slot
        setTimeout(() => {
          renderUserEvaluation(user, slot);
          slot.classList.add('active');
        }, 220);
        blocks.forEach(b => b.classList.remove('active-user'));
        block.classList.add('active-user');
        activeUser = user;
      }
    });
  });
}
      // 取得所有被評 1 星的參加者（提供給批次黑名單用）
      function getOneStarUsers() {
        const result = [];
        // selectedUserStarsMap: Map<userId, stars>
        selectedUserStarsMap.forEach((stars, userId) => {
          if (stars === 1) {
            // 從參加者名單找名字（找不到就給個簡單的 fallback）
            let name = '';
            if (Array.isArray(participantsArr)) {
              const hit = participantsArr.find(p => String(p.user_id) === String(userId));
              name = hit?.name || '';
            }
            result.push({ user_id: userId, name: name || `User ${userId}` });
          }
        });
        return result;
      }

    function showBulkBlacklistModal(oneStarUsers) {
      const modal = document.getElementById('bulk-blacklist-modal');
      const listWrap = document.getElementById('bulk-blacklist-list');
      const btnSkip = document.getElementById('bulk-blacklist-skip');
      const btnConfirm = document.getElementById('bulk-blacklist-confirm');

      // 工具：檢查單列是否有效（若勾選→必填理由；理由=其他→必填文字）
      const rowIsValid = (uid) => {
        const cb = listWrap.querySelector(`.blk-check[data-user="${uid}"]`);
        if (!cb || !cb.checked) return true; // 沒勾選就不檢查
        const sel = listWrap.querySelector(`.blk-reason[data-user="${uid}"]`);
        const other = listWrap.querySelector(`.blk-other[data-user="${uid}"]`);
        if (!sel || !sel.value) return false;
        if (sel.value === '其他' && !(other?.value || '').trim()) return false;
        return true;
      };

      // 檢查勾選與理由是否完整，並控制按鈕與紅框提示
      const updateConfirmState = () => {
        const checks = Array.from(listWrap.querySelectorAll('.blk-check'));
        const checkedUids = checks.filter(c => c.checked).map(c => c.dataset.user);

        // 邊框先還原
        listWrap.querySelectorAll('.blk-reason').forEach(el => el.style.borderColor = '#ddd');
        listWrap.querySelectorAll('.blk-other').forEach(el => el.style.borderColor = '#ddd');

        let allValid = checkedUids.length > 0;   // ← 必須至少勾 1 位

        // 只檢查「有勾選」的人；未勾不檢查（也不會讓按鈕可按）
        for (const uid of checkedUids) {
          const sel = listWrap.querySelector(`.blk-reason[data-user="${uid}"]`);
          const other = listWrap.querySelector(`.blk-other[data-user="${uid}"]`);
          const invalid = !rowIsValid(uid); // 勾了就必選理由；選「其他」還要填字

          // 紅框提示
          sel.style.borderColor = invalid ? '#f15b5b' : '#ddd';
          if (sel.value === '其他') {
            other.style.borderColor = invalid ? '#f15b5b' : '#ddd';
          } else {
            other.style.borderColor = '#ddd';
          }
          if (invalid) allValid = false;
        }

        // 控制按鈕
        btnConfirm.disabled = !allValid;
        btnConfirm.style.opacity = allValid ? '1' : '.5';
        btnConfirm.style.cursor = allValid ? 'pointer' : 'not-allowed';
      };



      // 產生清單
      listWrap.innerHTML = '';
      oneStarUsers.forEach(u => {
        const row = document.createElement('div');
        row.className = 'blk-row';
        row.dataset.userId = u.user_id;
        row.innerHTML = `
          <input type="checkbox" class="blk-check" data-user="${u.user_id}" style="width:18px; height:18px; accent-color:#2c4975;">
          <div class="blk-name">${u.name || ('User ' + u.user_id)}</div>
          <div class="blk-fields">
            <select class="blk-reason" data-user="${u.user_id}">
              <option value="">請選擇理由</option>
              <option value="惡意言語或騷擾">惡意言語或騷擾</option>
              <option value="違反活動規則">違反活動規則</option>
              <option value="放鳥/未到場">放鳥/未到場</option>
              <option value="其他">其他</option>
            </select>
            <input class="blk-other" data-user="${u.user_id}" placeholder="請輸入其他理由..." style="display:none;">
          </div>
        `;


        listWrap.appendChild(row);

        // ↓↓↓ 就在這裡抓到「這一列」的元件
        const cb    = row.querySelector('.blk-check');
        const sel   = row.querySelector('.blk-reason');
        const other = row.querySelector('.blk-other');

        // 先把理由欄位鎖住；只有勾選該列才啟用
        const setEnabled = (on) => {
          sel.disabled   = !on;
          other.disabled = !on;
          sel.style.opacity   = on ? '1' : '.6';
          other.style.opacity = on ? '1' : '.6';
          if (!on) {                 // 取消勾選時順便清空回復
            sel.value = '';
            other.value = '';
            other.style.display = 'none';
            sel.style.borderColor = '#ddd';
            other.style.borderColor = '#ddd';
          }
        };
        setEnabled(cb.checked);       // 初始：未勾選 → 鎖住

        // 勾/取消勾 → 開關欄位 + 更新按鈕狀態
        cb.addEventListener('change', () => {
          setEnabled(cb.checked);
          updateConfirmState();
        });

        // 選「其他」時顯示輸入框；否則收起並清空
        sel.addEventListener('change', () => {
          if (sel.value === '其他') {
            other.style.display = 'inline-block';
          } else {
            other.style.display = 'none';
            other.value = '';
          }
          updateConfirmState();
        });

        // 其他理由輸入 → 更新按鈕狀態
        other.addEventListener('input', updateConfirmState);
      });


      // 初始化按鈕狀態
      updateConfirmState();

      // 顯示彈窗
      modal.style.display = 'flex';

      // 跳過：直接結束流程
      btnSkip.onclick = () => {
        modal.style.display = 'none';
        alert('評價已送出！');
        window.location.href = `/activity?member_id=${encodeURIComponent(currentUserId)}`;
      };

      // 確認列黑（保險：再檢查一次）
      btnConfirm.onclick = async () => {
        if (btnConfirm.disabled) return; // 保險線
        const checks = Array.from(listWrap.querySelectorAll('.blk-check')).filter(c => c.checked);

        const payloads = [];
        for (const c of checks) {
          const uid = c.dataset.user;
          const sel = listWrap.querySelector(`.blk-reason[data-user="${uid}"]`);
          const other = listWrap.querySelector(`.blk-other[data-user="${uid}"]`);
          let reason = sel.value;
          if (!reason) { updateConfirmState(); return; }
          if (reason === '其他') {
            const text = (other.value || '').trim();
            if (!text) { updateConfirmState(); return; }
            reason = text;
          }
          payloads.push({ member_id: currentUserId, blocked_member_id: uid, reason });
        }

        btnConfirm.disabled = true; btnSkip.disabled = true;
        try {
          await Promise.all(payloads.map(p =>
            fetch('/api/members/blacklist/block', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(p)
            })
          ));
          modal.style.display = 'none';
          alert('評價與黑名單處理完成！');
          window.location.href = `/activity?member_id=${encodeURIComponent(currentUserId)}`;
        } catch (e) {
          console.error(e);
          alert('黑名單送出失敗，請稍後再試（評價已送出）');
          modal.style.display = 'none';
          window.location.href = `/activity?member_id=${encodeURIComponent(currentUserId)}`;
        } finally {
          btnConfirm.disabled = false; btnSkip.disabled = false;
          updateConfirmState();
        }
      };
    }



  function initUserStars(user, userName) {
    const userStars = document.querySelectorAll("#user-stars .star");
    // const blacklistBtn = document.querySelector("#user-stars .blacklist-btn");
    let selectedUserStars = selectedUserStarsMap.get(user) || 0;

    // 預設顯示
    userStars.forEach(star => {
      const sScore = parseInt(star.dataset.score);
      star.classList.toggle("active", sScore <= selectedUserStars);

      star.addEventListener("click", () => {
        const score = parseInt(star.dataset.score);
        selectedUserStars = (score === selectedUserStars) ? 0 : score;
        selectedUserStarsMap.set(user, selectedUserStars);

        userStars.forEach(s => {
          const sScore = parseInt(s.dataset.score);
          s.classList.toggle("active", sScore <= selectedUserStars);
        });

        // 只有 1 星顯示按鈕，其餘隱藏
       /* if (blacklistBtn) {
          if (selectedUserStars === 1) {
            blacklistBtn.style.display = 'inline-block';
          } else {
            blacklistBtn.style.display = 'none';
          }
        }*/

        if (selectedUserStars > 0) {
          loadUserTagsByStars(selectedUserStars, "user-tags");
        }
      });
    });

  // 進入時如果預選就是1星，也要顯示
  /*if (blacklistBtn) {
    blacklistBtn.style.display = (selectedUserStars === 1) ? 'inline-block' : 'none';

    // 綁定按下後彈出理由 modal
    blacklistBtn.onclick = function () {
      const modal = document.getElementById('blacklist-modal');
      const reasonSelect = document.getElementById('blacklist-reason-select');
      const reasonOther = document.getElementById('blacklist-reason-other');
      modal.style.display = 'flex';
      reasonSelect.value = '';
      reasonOther.value = '';
      reasonOther.style.display = 'none';

      // 選擇「其他」時顯示輸入框
      reasonSelect.onchange = function() {
        if (reasonSelect.value === '其他') {
          reasonOther.style.display = 'block';
        } else {
          reasonOther.style.display = 'none';
        }
      };

      // 取消按鈕
      document.getElementById('blacklist-cancel-btn').onclick = function() {
        modal.style.display = 'none';
      };

      // 確認按鈕
      document.getElementById('blacklist-confirm-btn').onclick = async function() {
        let reason = reasonSelect.value;
        if (reason === '其他') {
          reason = reasonOther.value.trim();
        }
        if (!reason) {
          alert('請選擇或輸入理由');
          return;
        }
        // 取得 member_id, blocked_member_id
        const urlParams = new URLSearchParams(window.location.search);
        const member_id = urlParams.get('member_id');
        const blocked_member_id = user;
        if (!member_id || !blocked_member_id) {
          console.log('member_id:', member_id, 'blocked_member_id:', blocked_member_id);
          alert('缺少必要資訊，請重新登入');
          return;
        }
        // 呼叫 API
        try {
          const res = await fetch('/api/members/blacklist/block', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ member_id, blocked_member_id, reason })
          });
          const data = await res.json();
          if (res.ok) {
            // 取得 userName（從 participants 陣列找 name）
            let userName = '這位參加者';
            if (window.participantsArr && Array.isArray(window.participantsArr)) {
              const userObj = window.participantsArr.find(p => p.user_id === blocked_member_id);
              if (userObj && userObj.name) userName = userObj.name;
            }
            alert('已成功將「' + userName + '」加入黑名單！');
            modal.style.display = 'none';
          } else {
            alert(data.error || '加入黑名單失敗');
          }
        } catch (e) {
          alert('網路錯誤，請稍後再試');
        }
      };
    };
  }*/
}


function loadUserTagsByStars(stars, containerId) {
  const type = stars + 5;
  const container = document.getElementById(containerId);

  // 1. 舊內容淡出
  container.classList.remove('fade-in');
  container.classList.add('fade-out');

  fetch(`/api/review_templates?stars=${type}`)
    .then(res => res.json())
    .then(data => {
      setTimeout(() => { // 等動畫結束再換內容
        const tagContainer = document.createElement("div");
        tagContainer.className = "tag-container";
        const selectedTags = selectedUserTemplateMap.get(activeUser) || new Set();
        selectedUserTemplateMap.set(activeUser, selectedTags);

        data.forEach(item => {
          const tag = document.createElement("div");
          tag.className = "tag";
          tag.innerText = item.text;
          if (selectedTags.has(item.template_id)) {
            tag.classList.add("active");
          }
          tag.addEventListener("click", () => {
            tag.classList.toggle("active");
            if (selectedTags.has(item.template_id)) {
              selectedTags.delete(item.template_id);
            } else {
              selectedTags.add(item.template_id);
            }
            selectedUserTagsMap.set(activeUser, selectedTags);
          });
          tagContainer.appendChild(tag);
        });

        container.innerHTML = "";
        container.appendChild(tagContainer);

        // 新內容淡入
        container.classList.remove('fade-out');
        container.classList.add('fade-in');
      }, 180); // 0.18秒，跟CSS動畫時間一致
    });
}


</script>
  </body>
</html>
