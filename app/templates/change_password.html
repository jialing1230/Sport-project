<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <link rel="manifest" href="/static/manifest.json" />
        <script>
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker
            .register("/static/service-worker.js")
            .then(() => console.log("Service Worker Registered"))
            .catch((error) =>
                console.error("Service Worker Registration Failed:", error)
            );
        }
        </script>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>更改密碼</title>
        <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f5f5f5;
            color: #2c4975;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 30px;
            background-color: #fff;
            flex-wrap: wrap;
            gap: 16px;
            box-shadow: 0 1px 6px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            position: sticky;
            top: 0;
        }

        .left-section {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            padding: 10px;
        }

        .left-section svg {
            width: 24px;
            height: 24px;
            fill: var(--deep-blue); /* 注意這個變數在此未定義，可換成實際顏色 */
            cursor: pointer;
            transition: fill 0.3s ease;
        }

        .navbar-title {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            font-weight: bold;
            font-size: 20px;
            color: #2c4975;
        }

        .navbar-title img {
            height: 28px;
            margin-right: 10px;
        }

        .form-section {
            max-width: 400px;
            margin: 40px auto;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .form-section h1 {
            font-size: 24px;
            color: #2c4975;
            margin-bottom: 24px;
            text-align: center;
        }

        .form-section label {
            display: block;
            margin-top: 16px;
            margin-bottom: 6px;
            color: #2c4975;
            font-weight: bold;
        }

        .form-section input {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
        }
        .submit-btn {
            margin-top: 24px;
            width: 250px;
            padding: 12px;
            font-size: 16px;
            font-weight: bold;
            background-color: #81d3e1;     /* 淺藍色背景 */
            color: white;                  /* 白色文字 */
            border: 2px solid #81d3e1;     /* 淺藍色邊框 */
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
            display: block;              /* ✅ 使其成為區塊元素 */
            margin-left: auto;           /* ✅ 左右自動邊距來置中 */
            margin-right: auto;
        }

        .submit-btn:hover {
            background-color: #2c4975;     /* 深一點藍 */
            border-color: #2c4975;
            color: white;
        }
        .error-text {
            color: #e53935;
            font-size: 14px;
            margin-top: 4px;
            min-height: 20px; /* 預留空間避免版面跳動 */
        }
        </style>
    </head>
    <body>
        <div class="header">
            <div class="left-section">
                <svg
                id="back-button" 
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                width="24"
                height="24">
                    <path d="M15 19l-7-7 7-7"
                        stroke= #81d3e1
                        stroke-width="2"
                        fill="none"
                        stroke-linecap="round"
                        stroke-linejoin="round"></path>
                    <path d="M8 12h14"
                        stroke="#81d3e1"
                        stroke-width="2"
                        fill="none"
                        stroke-linecap="round"
                        stroke-linejoin="round"></path>
                </svg>
            </div>
            <div class="navbar-title">
                <img src="/static/logo.png" alt="Logo" />
                更改密碼
            </div>
        </div>
        <div class="form-section">
            <h1>修改登入密碼</h1>

            <label for="new-password">新密碼</label>
            <input type="password" id="new-password" placeholder="請輸入新密碼" />
            <div id="new-password-error" class="error-text"></div>


            <label for="confirm-password">再次輸入新密碼</label>
            <input type="password" id="confirm-password" placeholder="請再次輸入新密碼" />
            <div id="confirm-password-error" class="error-text"></div>
            <button type="button" class="submit-btn" id="submit-btn">確認送出</button>
        </div>

        <script>
            // 返回按鈕功能
            document.getElementById("back-button").addEventListener("click", function() {
                const urlParams = new URLSearchParams(window.location.search);
                const memberId = urlParams.get("member_id");
                if (memberId) {
                    window.location.href = `/member_view?member_id=${memberId}`;
                } else {
                    console.error("member_id 未找到");
                }
            });

            // 檢查密碼格式細節
            function getPasswordError(password) {
                if (password.length < 8) {
                return "密碼未達8字元";
                }

                const hasLower = /[a-z]/.test(password);
                const hasUpper = /[A-Z]/.test(password);
                const hasDigit = /\d/.test(password);

                if (!hasLower || !hasUpper || !hasDigit) {
                return "密碼需含大小寫字母與數字";
                }

                return ""; // ✅ 格式正確
            }

            // 驗證送出
            document.getElementById("submit-btn").addEventListener("click", async function () {
                const newPassword = document.getElementById("new-password").value.trim();
                const confirmPassword = document.getElementById("confirm-password").value.trim();

                // 先清除所有錯誤提示
                document.getElementById("new-password-error").textContent = "";
                document.getElementById("confirm-password-error").textContent = "";

                let hasError = false;

                if (!newPassword) {
                    document.getElementById("new-password-error").textContent = "請填寫新密碼";
                    hasError = true;
                } else {
                    const passwordError = getPasswordError(newPassword);
                    if (passwordError) {
                        document.getElementById("new-password-error").textContent = passwordError;
                        hasError = true;
                    }
                }

                if (!confirmPassword) {
                document.getElementById("confirm-password-error").textContent = "請再次輸入密碼";
                hasError = true;
                }

                if (newPassword && confirmPassword && newPassword !== confirmPassword) {
                document.getElementById("confirm-password-error").textContent = "兩次密碼不一致";
                hasError = true;
                }

                const urlParams = new URLSearchParams(window.location.search);
                const memberId = urlParams.get("member_id");

                if (!memberId) {
                    alert("無法找到會員 ID，請重新進入頁面。");
                    return;
                }

                // 取得舊密碼
                let currentPassword = "";
                try {
                    const response = await fetch(`/api/members/${memberId}`, {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json",
                        },
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        alert(`取得舊密碼失敗：${errorData.error || "未知錯誤"}`);
                        return;
                    }

                    const memberData = await response.json();
                    currentPassword = memberData.password;
                } catch (error) {
                    console.error("API 請求失敗：", error);
                    alert("取得舊密碼失敗，請稍後再試。");
                    return;
                }

                if (newPassword === confirmPassword && newPassword === currentPassword) {
                    alert("新密碼不能與舊密碼相同！");
                    return;
                }

                if (hasError) return;

                try {
                    const response = await fetch(`/api/members/change-password?member_id=${memberId}`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ password: newPassword }),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        alert(`密碼修改失敗：${errorData.error || "未知錯誤"}`);
                        return;
                    }

                    alert("密碼已修改成功！");
                    window.location.href = `/member_view?member_id=${memberId}`;
                } catch (error) {
                    console.error("API 請求失敗：", error);
                    alert("密碼修改失敗，請稍後再試。");
                }
            });
            // 即時清除錯誤提示
            document.getElementById("new-password").addEventListener("input", function () {
                if (this.value.trim()) {
                    document.getElementById("new-password-error").textContent = "";
                }
            });

            document.getElementById("confirm-password").addEventListener("input", function () {
                if (this.value.trim()) {
                    document.getElementById("confirm-password-error").textContent = "";
                }
            });
        </script>
    </body>
</html>
