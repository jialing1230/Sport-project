<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <link rel="manifest" href="/static/manifest.json" />
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("/static/service-worker.js")
          .then(() => console.log("Service Worker Registered"))
          .catch((error) =>
            console.error("Service Worker Registration Failed:", error)
          );
      }
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>èª²ç¨‹æœˆè²»ä»˜æ¬¾</title>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        color: #333;
        margin: 0;
        padding: 0;
      }

      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 13px 30px;
        background-color: #fff;
        flex-wrap: wrap;
        gap: 16px;
        box-shadow: 0 1px 6px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        position: sticky;
        top: 0;
      }
      #back-button {
        margin-left: -10px; /* ğŸ‘ˆ è®“ç®­é ­èˆ‡å·¦é‚Šä¿æŒè·é›¢ */
      }
      .left-section {
        display: flex;
        justify-content: flex-start;
        align-items: center;
        padding: 10px;
        margin-left: -10px;
      }
.left-section svg path {
  stroke: #2c4975;   /* é è¨­æ·±è— */
  transition: stroke 0.3s ease;
}

.left-section svg:hover path {
  stroke: #81d3e1;   /* æ»‘é¼ ç§»éå»è®Šæ·ºè— */
}

      .navbar-title {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        font-weight: bold;
        font-size: 18px;
        color: #2c4975;
      }

      .navbar-title img {
        height: 40px;
        margin-right: 5px;
        margin-top: 3px;
      }

      .container {
        position: relative;
        max-width: 900px;
        min-width: 320px;
        width: 100%;
        margin: 0px auto;
        background-color: #fff;
        padding: 30px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-wrap: wrap;
        gap: 30px;
        overflow: hidden;
      }

      .payment-form {
        flex: 1 1 500px;
        z-index: 1;
      }

      .payment-summary {
        flex: 1 1 300px;
        background-color: #f9f9f9;
        padding: 25px;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        height: fit-content;
        margin: 8px 0 8px 0;
      }

      .title-row {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        margin-bottom: 30px;
      }

      .logo-inline {
        width: 50px;
        height: 50px;
        object-fit: contain;
        border-radius: 50%;
      }

      h1 {
        color: #2c4975;
        white-space: nowrap;
        font-size: 24px;
        margin: 0;
      }

      .form-row {
        display: flex;
        flex-direction: column;
        margin-bottom: 20px;
      }

      .form-label {
        margin-bottom: 8px;
        font-weight: bold;
        color: #2c4975;
        white-space: nowrap;
      }

      .form-input {
        padding: 12px;
        width: 100%;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.2s ease;
      }

      .form-input:focus {
        outline: none;
        border-color: #81d3e1;
        box-shadow: 0 0 0 2px rgba(129, 211, 225, 0.2);
      }

      .card-row {
        display: flex;
        gap: 10px;
      }

      .card-row .form-input {
        flex: 1;
      }

      .subscription-plan-group {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        margin-top: 10PX;
      }

      .subscription-plan {
        flex: 1;
        min-width: 150px;
        padding: 20px 15px;
        background-color: #f9f9f9;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
        font-size: 14px;
        user-select: none;
        position: relative;
      }

      .subscription-plan:hover {
        background-color: #eaf3fa;
        border-color: #81d3e1;
      }

      .subscription-plan input {
        display: none;
      }

      .subscription-plan:has(input:checked) {
        background-color: #81d3e1;
        border-color: #2c4975;
        color: white;
        font-weight: bold;
      }

      .subscription-plan:active {
        transform: scale(0.98);
      }

      .plan-price {
        font-size: 24px;
        font-weight: bold;
        margin: 10px 0 5px 0;
        white-space: nowrap;
      }

      .plan-period {
        font-size: 12px;
        opacity: 0.8;
      }

      .plan-savings {
        position: absolute;
        top: -8px;
        right: -8px;
        background-color: #ff6b6b;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
      }

      .summary-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e0e0e0;
      }

      .summary-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
        font-weight: bold;
        font-size: 18px;
        color: #2c4975;
      }

      .summary-label {
        color: #666;
      }

      .summary-value {
        font-weight: bold;
        color: #333;
      }

             .btn-primary {
         padding: 12px 20px;
         font-size: 16px;
         border: none;
         border-radius: 4px;
         cursor: pointer;
         color: white;
         transition: 0.2s ease;
         white-space: nowrap;
         background-color: #fea3a8;
         width: 100%;
         margin-top: 20px;
         font-weight: bold;
       }

               .btn-primary:hover {
          background-color: #e695a0;
          transform: translateY(-1px);
        }

      .btn-primary:disabled {
        background-color: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      .security-notice {
        background-color: #e8f5e8;
        border: 1px solid #4caf50;
        border-radius: 4px;
        padding: 15px;
        margin-top: 20px;
        font-size: 14px;
        color: #2e7d32;
      }

      .security-notice::before {
        margin-right: 5px;
      }

      @media (max-width: 768px) {
        .container {
          flex-direction: column;
          padding: 20px;
        }
        

        
        .title-row {
          gap: 8px;
          margin-bottom: 20px;
        }
        
        h1 {
          font-size: 20px;
        }
        
        .form-row {
          margin-bottom: 15px;
        }
        
        .form-label {
          font-size: 14px;
        }
        
        .form-input {
          font-size: 14px;
          padding: 10px;
        }
        
        .btn-primary {
          font-size: 15px;
          padding: 10px 0;
        }
        
        .subscription-plan-group {
          flex-direction: column;
          gap: 10px;
        }
        
        .card-row {
          flex-direction: column;
          gap: 10px;
        }
      }

      @media (max-width: 480px) {
        .container {
          padding: 15px;
          width: 90%;
        }
        
        h1 {
          font-size: 18px;
        }
        
        .payment-summary {
          padding: 20px;
        }
        
        .subscription-plan {
          min-width: auto;
        }
      }

      /* Modal styles */
      .modal {
        display: none; /* é è¨­éš±è— */
        position: fixed;
        z-index: 1000;
        inset: 0; /* ç­‰æ–¼ top:0; right:0; bottom:0; left:0; */
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);

        /* âœ… ç”¨ flex å‚ç›´ + æ°´å¹³ç½®ä¸­ */
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background-color: #fff;
        margin: 0;
        padding: 25px;
        border-radius: 8px;
        width: 90%;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        animation: slideIn 0.3s ease-out;
      }

      .modal-title {
        color: #2c4975;
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 15px;
      }

      .modal-message {
        color: #2c4975;
        font-size: 16px;
        line-height: 1.5;
        margin-bottom: 25px;
        text-align: left;   /* ğŸ‘ˆ åŠ é€™è¡Œè®“æ–‡å­—é å·¦ */
      }
      .modal-message ul {
        margin: 0;
        padding-left: 85px; /* æ§åˆ¶é»é»å’Œæ–‡å­—è·é›¢ */
        list-style-type: disc; /* ä½¿ç”¨å¯¦å¿ƒåœ“é» */
      }

      .modal-message li {
        margin-bottom: 5px; /* æ¯é»ä¹‹é–“çš„é–“è· */
        color: #2c4975;
        font-size: 16px;
        line-height: 1.5;
        text-align: left;
      }

      .modal-btn {
        background-color: #fea3a8;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }

      .modal-btn:hover {
        background-color: #e695a0;
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      @keyframes slideIn {
        from { 
          opacity: 0;
          transform: translateY(-50px);
        }
        to { 
          opacity: 1;
          transform: translateY(0);
        }
      }
      .plan-section {
  flex: 1 1 100%;
}
@media (min-width: 769px) {
  .payment-form {
    order: 1;
  }
  .payment-summary {
    order: 2;
  }
}

    </style>
  </head>
  <body>
    <div class="header">
      <div class="left-section">
        <svg
          id="back-button" 
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          width="24"
          height="24">
          <path d="M15 19l-7-7 7-7"
            stroke-width="2"
            fill="none"
            stroke-linecap="round"
            stroke-linejoin="round"></path>
          <path d="M8 12h14"
            stroke-width="2"
            fill="none"
            stroke-linecap="round"
            stroke-linejoin="round"></path>
        </svg>
      </div>
      <div class="navbar-title">
        èª²ç¨‹æœˆè²»ä»˜æ¬¾
      </div>
    </div>

    <div class="container">
      <div class="plan-section">
  <label class="form-label">æœˆè²»æ–¹æ¡ˆ</label>
  <div class="subscription-plan-group">
    <div class="subscription-plan">
      <input type="radio" name="subscriptionPlan" value="monthly" id="monthly" checked>
      <label for="monthly">
        <div>æœˆè²»</div>
        <div class="plan-price">NT$ 200</div>
        <div class="plan-period">æ¯æœˆ</div>
      </label>
    </div>
    <div class="subscription-plan">
      <input type="radio" name="subscriptionPlan" value="quarterly" id="quarterly">
      <label for="quarterly">
        <div>å­£è²»</div>
        <div class="plan-price">NT$ 400</div>
        <div class="plan-period">æ¯å­£</div>
        <div class="plan-savings">çœ NT$ 200</div>
      </label>
    </div>
    <div class="subscription-plan">
      <input type="radio" name="subscriptionPlan" value="yearly" id="yearly">
      <label for="yearly">
        <div>å¹´è²»</div>
        <div class="plan-price">NT$ 1,600</div>
        <div class="plan-period">æ¯å¹´</div>
        <div class="plan-savings">çœ NT$ 800</div>
      </label>
    </div>
  </div>
</div>
      <div class="payment-summary">
        <h3 style="color: #2c4975; margin-top: 0; margin-bottom: 20px;">ä»˜æ¬¾æ‘˜è¦</h3>
        
        <div class="summary-item">
          <span class="summary-label">é¸æ“‡æ–¹æ¡ˆ</span>
          <span class="summary-value" id="selectedPlan">æœˆè²»</span>
        </div>
        
        <div class="summary-item">
          <span class="summary-label">æ–¹æ¡ˆè²»ç”¨</span>
          <span class="summary-value" id="planFee">NT$ 200</span>
        </div>
        
        
        <div class="summary-item">
          <span class="summary-label">å„ªæƒ æŠ˜æ‰£</span>
          <span class="summary-value" id="discount">NT$ 0</span>
        </div>
        
        <div class="summary-item">
          <span class="summary-label">ç¸½è¨ˆ</span>
          <span class="summary-value" id="totalAmount">NT$ 200</span>
        </div>
        
        <div style="margin-top: 20px; padding: 15px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; font-size: 13px; color: #856404;">
          <strong>æ³¨æ„äº‹é …ï¼š</strong><br>
          â€¢ æœˆè²»å°‡æ–¼æ¯æœˆè‡ªå‹•æ‰£æ¬¾<br>
          â€¢ å¯éš¨æ™‚å–æ¶ˆè¨‚é–±<br>
          â€¢ èª²ç¨‹é–‹å§‹å‰7å¤©å¯ç”³è«‹é€€æ¬¾
        </div>
      </div>
      <div class="payment-form">


        <form id="paymentForm">


          <div class="form-row">
            <label for="cardNumber" class="form-label">å¡è™Ÿ</label>
            <input
              type="text"
              id="cardNumber"
              name="cardNumber"
              class="form-input"
              placeholder="1234 5678 9012 3456"
              maxlength="19"
              required
            />
          </div>

          <div class="form-row">
            <label for="cardHolder" class="form-label">æŒå¡äººå§“å</label>
            <input
              type="text"
              id="cardHolder"
              name="cardHolder"
              class="form-input"
              placeholder="è«‹è¼¸å…¥æŒå¡äººå§“å"
              required
            />
          </div>

          <div class="form-row">
            <label class="form-label">æœ‰æ•ˆæœŸé™</label>
            <div class="card-row">
              <input
                type="text"
                id="expiryMonth"
                name="expiryMonth"
                class="form-input"
                placeholder="MM"
                maxlength="2"
                required
              />
              <span style="display: flex; align-items: center; font-size: 18px; color: #666;">/</span>
              <input
                type="text"
                id="expiryYear"
                name="expiryYear"
                class="form-input"
                placeholder="YY"
                maxlength="2"
                required
              />
            </div>
          </div>

          <div class="form-row">
            <label for="cvv" class="form-label">å®‰å…¨ç¢¼</label>
            <input
              type="text"
              id="cvv"
              name="cvv"
              class="form-input"
              placeholder="123"
              maxlength="4"
              required
            />
          </div>

          <div class="form-row">
            <button type="submit" class="btn-primary" id="submitBtn">ç¢ºèªä»˜æ¬¾</button>
          </div>

          <div class="security-notice">
            æ‚¨çš„ä»˜æ¬¾è³‡è¨Šå°‡é€éSSLåŠ å¯†å‚³è¼¸ï¼Œç¢ºä¿äº¤æ˜“å®‰å…¨ã€‚
          </div>
        </form>
      </div>

    </div>

    <!-- Modal -->
    <div id="infoModal" class="modal">
      <div class="modal-content">
        <div class="modal-title">å‡ç´šæœƒå“¡äº«å°ˆå±¬æ¬Šç›Š</div>
        <div class="modal-message">
          <ul>
            <li>èª²ç¨‹å„ªæƒ </li>
            <li>ç„¡é™æ¬¡ç™¼èµ·èª²ç¨‹</li>
            <li>è‡ªç”±åƒèˆ‡ä»»ä½•èª²ç¨‹</li>
            <li>è§£é–VIPå°ˆå±¬æ¨™ç« </li>
          </ul>
        </div>
        <button class="modal-btn" onclick="closeModal()">æˆ‘çŸ¥é“äº†</button>
      </div>
    </div>

    <script>
      // å¡è™Ÿæ ¼å¼åŒ–
      document.getElementById('cardNumber').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\s/g, '').replace(/\D/g, '');
        let formattedValue = value.replace(/(\d{4})(?=\d)/g, '$1 ');
        e.target.value = formattedValue;
      });

      // æœˆä»½é™åˆ¶
      document.getElementById('expiryMonth').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value > 12) value = 12;
        if (value < 1) value = '';
        e.target.value = value;
      });

      // å¹´ä»½é™åˆ¶
      document.getElementById('expiryYear').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length === 2) {
          let currentYear = new Date().getFullYear().toString().slice(-2);
          if (value < currentYear) {
            e.target.value = currentYear;
          }
        }
      });

      // CVV åªå…è¨±æ•¸å­—
      document.getElementById('cvv').addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/\D/g, '');
      });

      // æœˆè²»æ–¹æ¡ˆé¸æ“‡
      document.querySelectorAll('.subscription-plan').forEach(plan => {
        plan.addEventListener('click', function() {
          const radio = this.querySelector('input[type="radio"]');
          radio.checked = true;
          updateSummary();
        });
      });

      // æ›´æ–°ä»˜æ¬¾æ‘˜è¦
      function updateSummary() {
        const selectedPlan = document.querySelector('input[name="subscriptionPlan"]:checked').value;
        const planData = {
          monthly: { name: 'æœˆè²»', fee: 200, discount: 0 },
          quarterly: { name: 'å­£è²»', fee: 600, discount: 200 },
          yearly: { name: 'å¹´è²»', fee: 2400, discount: 800 }
        };
        
        const plan = planData[selectedPlan];
        const total = plan.fee - plan.discount;
        
        document.getElementById('selectedPlan').textContent = plan.name;
        document.getElementById('planFee').textContent = `NT$ ${plan.fee.toLocaleString()}`;
        document.getElementById('discount').textContent = `NT$ ${plan.discount}`;
        document.getElementById('totalAmount').textContent = `NT$ ${total.toLocaleString()}`;
      }

      // è¡¨å–®æäº¤
      document.getElementById('paymentForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('submitBtn');
        const originalText = submitBtn.textContent;
        
        // åŸºæœ¬é©—è­‰
        const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
        const cardHolder = document.getElementById('cardHolder').value.trim();
        const expiryMonth = document.getElementById('expiryMonth').value;
        const expiryYear = document.getElementById('expiryYear').value;
        const cvv = document.getElementById('cvv').value;
        
        if (!cardNumber || cardNumber.length < 16) {
          alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„å¡è™Ÿ');
          return;
        }
        
        if (!cardHolder) {
          alert('è«‹è¼¸å…¥æŒå¡äººå§“å');
          return;
        }
        
        if (!expiryMonth || !expiryYear) {
          alert('è«‹è¼¸å…¥æœ‰æ•ˆæœŸé™');
          return;
        }
        
        if (!cvv || cvv.length < 3) {
          alert('è«‹è¼¸å…¥å®‰å…¨ç¢¼');
          return;
        }
        
        // é¡¯ç¤ºè™•ç†ä¸­ç‹€æ…‹
        submitBtn.textContent = 'è™•ç†ä¸­...';
        submitBtn.disabled = true;
        
        try {
          // é€™è£¡å¯ä»¥åŠ å…¥å¯¦éš›çš„ä»˜æ¬¾APIèª¿ç”¨
          // æ¨¡æ“¬APIèª¿ç”¨å»¶é²
          await new Promise(resolve => setTimeout(resolve, 2000));
          
          // ç²å–é¸æ“‡çš„æ–¹æ¡ˆå’Œé‡‘é¡
          const selectedPlan = document.querySelector('input[name="subscriptionPlan"]:checked').value;
          const planData = {
            monthly: { name: 'æœˆè²»æ–¹æ¡ˆ', fee: 200, discount: 0, api: 'month', months: 1 },
            quarterly: { name: 'å­£è²»æ–¹æ¡ˆ', fee: 600, discount: 200, api: 'season', months: 3 },
            yearly: { name: 'å¹´è²»æ–¹æ¡ˆ', fee: 2400, discount: 800, api: 'year', months: 12 }
          };
          const plan = planData[selectedPlan];
          const total = plan.fee - plan.discount;
          // å–å¾— member_id
          // ä¸€å¾‹å¾ç¶²å€åƒæ•¸å–å¾— member_id
          const urlParams = new URLSearchParams(window.location.search);
          let memberId = urlParams.get('member_id');
          if (!memberId) {
            // å˜—è©¦å¾ hash æˆ–å…¶ä»–æ–¹å¼å–å¾—ï¼ˆå¯æ“´å……ï¼‰
            alert('æ‰¾ä¸åˆ°æœƒå“¡è³‡è¨Šï¼Œè«‹é‡æ–°ç™»å…¥');
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
            return;
          }
          // è¨ˆç®—åˆ°æœŸæ—¥
          const now = new Date();
          let expire = new Date(now);
          expire.setMonth(expire.getMonth() + plan.months);
          // è‹¥è·¨å¹´è‡ªå‹•ä¿®æ­£
          if (expire.getDate() !== now.getDate()) {
            expire.setDate(0);
          }
          const expireAt = expire.toISOString();
          // å‘¼å«è¨‚é–±API
          const resp = await fetch(`/api/members/${memberId}/subscribe`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              plan: plan.api,
              amount: total,
              expire_at: expireAt
            })
          });
          if (!resp.ok) {
            const err = await resp.json();
            throw new Error(err.error || 'è¨‚é–±å¤±æ•—');
          }
          // å°å‘æˆåŠŸé 
          const planParam = encodeURIComponent(plan.name);
          const amountParam = total.toLocaleString();
          let nextUrl = `/payment_success?plan=${planParam}&amount=${amountParam}`;
          if (memberId) {
            nextUrl += `&member_id=${memberId}`;
          }
          window.location.href = nextUrl;
          
        } catch (error) {
          alert('ä»˜æ¬¾å¤±æ•—ï¼š' + (error.message || 'è«‹ç¨å¾Œå†è©¦'));
          submitBtn.textContent = originalText;
          submitBtn.disabled = false;
        }
      });

      // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
      updateSummary();
      
      // é¡¯ç¤ºè³‡è¨Šå½ˆçª—
      showModal();
      
      // é¡¯ç¤ºå½ˆçª—å‡½æ•¸
      function showModal() {
        const modal = document.getElementById('infoModal');
        modal.style.display = 'flex';  // âœ… é–‹å•Ÿæ™‚ç”¨ flexï¼Œè€Œä¸æ˜¯ block
      }

      
      // é—œé–‰å½ˆçª—å‡½æ•¸
      function closeModal() {
        document.getElementById('infoModal').style.display = 'none';
      }
      
      // é»æ“Šå½ˆçª—å¤–éƒ¨é—œé–‰
      window.onclick = function(event) {
        const modal = document.getElementById('infoModal');
        if (event.target === modal) {
          modal.style.display = 'none';
        }
      }

      // è¿”å›æŒ‰éˆ•åŠŸèƒ½
      document.getElementById("back-button").addEventListener("click", function() {
        const urlParams = new URLSearchParams(window.location.search);
        const memberId = urlParams.get("member_id");
        if (memberId) {
          window.location.href = `/member_view?member_id=${memberId}`;
        } else {
          window.history.back();
        }
      });
    </script>
  </body>
</html>
