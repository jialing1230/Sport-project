<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <link rel="manifest" href="/static/manifest.json" />
        <script>
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker
            .register("/static/service-worker.js")
            .then(() => console.log("Service Worker Registered"))
            .catch((error) =>
                console.error("Service Worker Registration Failed:", error)
            );
        }
        </script>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>ç·¨è¼¯å…¬é–‹è³‡æ–™</title>
       <style>
            body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f5f5f5;  /* ç°åº• */
            color: #2c4975;
            }

            :root {
            --page-max: 500px;   /* å…§å®¹æœ€å¤§å¯¬ */
            --gutter: 16px;      /* å·¦å³å…§è· */
            --deep-blue: #2c4975;
            }

            /* è®“é é¢é«˜åº¦æ’æ»¿è¦–çª—ï¼ˆheader å›ºå®šï¼Œä¸Šæ–¹ä¸å‹•ï¼‰ */
            main {
            min-height: calc(100vh - 64px); /* 64px å¯è¦–éœ€æ±‚å¾®èª¿ */
            display: block;
            }

            /* ä¸­å¤®å…§å®¹å®¹å™¨ï¼šé™åˆ¶å¯¬åº¦ã€ç½®ä¸­ã€å·¦å³ä¿ç•™ç°åº• */
            .container {
            /* è®“ç™½åº•æ°¸é æ¯”ç•«é¢çª„ä¸€é» â†’ å·¦å³å„ç•™ 16px ç°é‚Š */
            width: min(500px, calc(100% - 32px));
            margin: 0 auto;                 
            padding: 0 var(--gutter) 24px;  /* å…§å®¹å…§è· */
            box-sizing: border-box;
            background: #fff;               
            min-height: calc(100vh - 64px); /* header é«˜åº¦ä»ç”¨ 64px */
            }


            /* Header å€åŸŸ */
            .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 13px 30px;
            background-color: #fff;
            flex-wrap: wrap;
            gap: 16px;
            box-shadow: 0 1px 6px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            position: sticky;
            top: 0;
            }

            .left-section {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            padding: 10px;
            }

            .left-section svg path {
            stroke: #2c4975;                 /* é è¨­æ·±è— */
            transition: stroke 0.3s ease;    /* éæ¸¡é †æš¢ */
            }

            .left-section svg:hover path {
            stroke: #81d3e1;                 /* hover æ·ºè— */
            }
            #back-button {
                margin-left: -20px; /* ğŸ‘ˆ è®“ç®­é ­èˆ‡å·¦é‚Šä¿æŒè·é›¢ */
            }
            .navbar-title {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            font-weight: bold;
            font-size: 18px;
            color: #2c4975;
            }

            .navbar-title img {
            height: 40px;
            margin-right: 5px;
            margin-top: 3px;
            }

            /* ===== å–®ä¸€å¡ç‰‡æ¨£å¼ ===== */
            .card {
            background: #fff;
            border-radius: 0;   /* ä¸Šä¸‹è¦è²¼æ»¿ï¼Œå°±ä¸è¦åœ“è§’ */
            box-shadow: none;  /* å¯ä»¥ä¿ç•™æˆ–æ‹¿æ‰ï¼Œçœ‹ä½ è¦ä¸è¦å¡ç‰‡æ„Ÿ */
            padding: 20px 4px 4px 4px;
            margin: 0;         /* ä¸Šä¸‹å–æ¶ˆç•™ç™½ */
            min-height: calc(100vh - 64px); /* æ’æ»¿é™¤æ‰ header çš„æ•´å€‹é«˜åº¦ */
            }

            /* å¡ç‰‡å…§æ¨™é¡Œ */
            .section-title {
            margin: 0 0 12px;
            color: #81d3e1;
            font-weight: 700;
            font-size: 18px;
            }

            /* å¡ç‰‡åˆ†éš”ç·š */
            .card-divider {
            border: none;
            height: 1px;
            background: rgba(0,0,0,0.08);
            margin: 20px 0;
            }

            /* è¡¨å–®æ¬„ä½ */
            .field {
            margin-top: 12px;
            }
            .field label {
            display:block;
            margin-bottom:4px;
            color: var(--deep-blue);
            }
            .field input[type="url"],
            textarea {
            width: 100%;
            padding: 10px;
            font-size: 14px;
            border-radius: 6px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            resize: vertical;
            }

            /* ç…§ç‰‡ä¸Šå‚³å€ */
            .photo-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); 
            gap: 12px;
            }

            .upload-label {
            width: 100%;
            height: 120px;
            background-color: #e0e0e0;
            border: 2px dashed #ccc;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: border-color 0.3s ease;
            flex-shrink: 0;
            aspect-ratio: 5 / 6;   /* ç¶­æŒ 100x120 çš„æ¯”ä¾‹ */
            max-width: 120px;      /* é¿å…æ¡Œæ©Ÿå¤ªå¤§è¢«æ‹‰å¤ªå¯¬ */
            }

            .upload-label:hover { border-color: #81d3e1; }
            .plus-icon { font-size: 32px; color: #aaa; }

            .photo-item {
            position: relative;
            width: 100%;
            height: 120px;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
            aspect-ratio: 5 / 6;   /* ç¶­æŒ 100x120 çš„æ¯”ä¾‹ */
            max-width: 120px;      /* é¿å…æ¡Œæ©Ÿå¤ªå¤§è¢«æ‹‰å¤ªå¯¬ */
            }
            .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
            border: 1px solid #ccc;
            }
            .photo-item input { display: none; }
            .delete-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 14px;
            cursor: pointer;
            line-height: 18px;
            text-align: center;
            padding-left: 4px;
            }

            /* å‹•ä½œåˆ—ï¼ˆå„²å­˜æŒ‰éˆ•ï¼‰ */
            .actions {
            text-align: center;
            margin: 20px 0 8px;
            }
            </style>

    </head>
    <body>
        <div class="header">
            <div class="left-section">
                <svg
                id="back-button" 
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                width="24"
                height="24">
                    <path d="M15 19l-7-7 7-7"
                        stroke= #81d3e1
                        stroke-width="2"
                        fill="none"
                        stroke-linecap="round"
                        stroke-linejoin="round"></path>
                    <path d="M8 12h14"
                        stroke="#81d3e1"
                        stroke-width="2"
                        fill="none"
                        stroke-linecap="round"
                        stroke-linejoin="round"></path>
                </svg>
            </div>
            <div class="navbar-title">
                ç·¨è¼¯å…¬é–‹è³‡æ–™
            </div>
        </div>
        <main class="container">
        <section class="card">

            <!-- é—œæ–¼æˆ‘ -->
            <h3 class="section-title">é—œæ–¼æˆ‘</h3>
            <textarea id="bio-input" rows="6" placeholder="è«‹è¼¸å…¥è‡ªæˆ‘ä»‹ç´¹..."></textarea>

            <div style="margin-top: 16px;">
            <label for="fb-link" style="display:block;margin-bottom:4px;">Facebook é€£çµ</label>
            <input id="fb-link" type="url" placeholder="https://facebook.com/yourprofile"
                    style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;box-sizing:border-box;">
            </div>

            <div style="margin-top: 12px;">
            <label for="ig-link" style="display:block;margin-bottom:4px;">Instagram é€£çµ</label>
            <input id="ig-link" type="url" placeholder="https://instagram.com/yourprofile"
                    style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;box-sizing:border-box;">
            </div>

            <!-- åˆ†éš”ç·šï¼šç”¨ hr è€Œä¸æ˜¯ div -->
            <hr class="card-divider">

            <!-- å€‹äººç…§ç‰‡ -->
            <h3 class="section-title">å€‹äººç…§ç‰‡</h3>
            <div id="photo-gallery" class="photo-gallery">
            <label for="photo-upload" class="upload-label">
                <span class="plus-icon">+</span>
            </label>
            <input type="file" id="photo-upload" accept="image/*" style="display:none;" multiple />
            </div>

            <!-- å„²å­˜æŒ‰éˆ•æ”¾å¡ç‰‡åº•éƒ¨ -->
            <div class="actions">
            <button onclick="saveBio()" style="width: 200px; padding: 10px; background-color: #81d3e1; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer;">
                å„²å­˜
            </button>
            </div>

        </section>
        </main>

        <script>
            document.getElementById("back-button").addEventListener("click", function() {
                window.history.back();
            });

            // å–å¾—åˆå§‹æ¬„ä½å€¼
            let initialBio = "";
            let initialFb = "";
            let initialIg = "";
            let initialPhotoPaths = [];
            let isDirty = false;

            // å¾ç¶²å€å–å¾— member_id
            function getMemberIdFromUrl() {
                // å…ˆå¾ query string å–å€¼
                const urlParams = new URLSearchParams(window.location.search);
                const mid = urlParams.get('member_id');
                if (mid) return mid;
                // å†å¾è·¯å¾‘å–å€¼ï¼ˆå…è¨± uuid æˆ–å­—ä¸²ï¼‰
                const pathMatch = window.location.pathname.match(/([a-zA-Z0-9\-]{8,})$/);
                if (pathMatch) return pathMatch[1];
                return null;
            }
            const member_id = getMemberIdFromUrl();


            // è¼‰å…¥æœƒå“¡è‡ªæˆ‘ä»‹ç´¹èˆ‡ç…§ç‰‡
            async function loadMemberData() {
                if (!member_id) return;
                // å–å¾—è‡ªæˆ‘ä»‹ç´¹èˆ‡ç¤¾ç¾¤é€£çµ
                try {
                    let res = await fetch(`/api/members/${member_id}`);
                    if (res.ok) {
                        let data = await res.json();
                        if (data.public_intro) {
                            document.getElementById("bio-input").value = data.public_intro;
                            initialBio = data.public_intro;
                        }
                        // æ”¯æ´å¤šç¨®æ¬„ä½åç¨±
                        const fbVal = data.fb_link || data.facebook_url || "";
                        const igVal = data.ig_link || data.instagram_url || "";
                        document.getElementById("fb-link").value = fbVal;
                        document.getElementById("ig-link").value = igVal;
                        initialFb = fbVal;
                        initialIg = igVal;
                    }
                } catch {}
                // å–å¾—ç…§ç‰‡ï¼ˆå‡è¨­æœ‰ /api/photos?member_id=xxx å›å‚³ {photos: [{file_path: ...}, ...]}ï¼‰
                try {
                    let res = await fetch(`/api/photos?member_id=${member_id}`);
                    if (res.ok) {
                        let data = await res.json();
                        if (Array.isArray(data.photos)) {
                            data.photos.forEach(photo => {
                                addPhotoItemFromUrl(photo.file_path);
                            });
                            initialPhotoPaths = data.photos.map(p => p.file_path).sort();
                        }
                    }
                } catch {}
                isDirty = false;
            }

            // æ–°å¢å·²ä¸Šå‚³ç…§ç‰‡çš„é¡¯ç¤ºå¡ç‰‡
            // è¨˜éŒ„å·²åˆªé™¤çš„ file_path
            const deletedPhotoPaths = new Set();

            function addPhotoItemFromUrl(url) {
                const photoItem = document.createElement("div");
                photoItem.className = "photo-item";
                photoItem.dataset.filePath = url;
                const img = document.createElement("img");
                img.src = url;
                const deleteBtn = document.createElement("button");
                deleteBtn.className = "delete-btn";
                deleteBtn.textContent = "âœ•";
                deleteBtn.addEventListener("click", () => {
                    gallery.removeChild(photoItem);
                    deletedPhotoPaths.add(url);
                    isDirty = true;
                });
                photoItem.appendChild(img);
                photoItem.appendChild(deleteBtn);
                gallery.insertBefore(photoItem, gallery.querySelector(".upload-label").nextSibling);
            }

            // ç›£è½æ¬„ä½è®Šå‹•
            document.addEventListener('DOMContentLoaded', function() {
                document.getElementById("bio-input").addEventListener("input", () => { isDirty = true; });
                document.getElementById("fb-link").addEventListener("input", () => { isDirty = true; });
                document.getElementById("ig-link").addEventListener("input", () => { isDirty = true; });
            });

            // é é¢è¼‰å…¥æ™‚è‡ªå‹•è¼‰å…¥è³‡æ–™
            window.addEventListener('DOMContentLoaded', loadMemberData);

            async function saveBio() {
                const bio = document.getElementById("bio-input").value;
                const fbLink = document.getElementById("fb-link").value.trim();
                const igLink = document.getElementById("ig-link").value.trim();
                if (!bio.trim()) {
                    alert("è«‹è¼¸å…¥è‡ªæˆ‘ä»‹ç´¹å…§å®¹ï¼");
                    return;
                }
                // 1. é€å‡ºè‡ªæˆ‘ä»‹ç´¹èˆ‡ç¤¾ç¾¤é€£çµ
                let introRes = await fetch(`/api/members/${member_id}/public-intro`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ public_intro: bio, fb_link: fbLink, ig_link: igLink })
                });
                let introData = await introRes.json();
                if (!introRes.ok) {
                    alert(introData.error || "è‡ªæˆ‘ä»‹ç´¹å„²å­˜å¤±æ•—");
                    return;
                }

                // 2. åˆªé™¤å·²æ¨™è¨˜åˆªé™¤çš„èˆŠç…§ç‰‡
                for (const url of deletedPhotoPaths) {
                    try {
                        let res = await fetch(`/api/photos/delete`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ member_id, file_path: url })
                        });
                        let data = await res.json();
                        if (!res.ok) {
                            alert(data.error || 'ç…§ç‰‡åˆªé™¤å¤±æ•—');
                            return;
                        }
                    } catch {
                        alert('ç…§ç‰‡åˆªé™¤å¤±æ•—');
                        return;
                    }
                }
                deletedPhotoPaths.clear();

                // 3. ä¸Šå‚³æ‰€æœ‰æ–°é¸çš„ç…§ç‰‡ï¼ˆå¾ uploadedPhotos Map å–å‡ºæ‰€æœ‰ Fileï¼‰
                let uploadCount = 0;
                for (const [fileKey, file] of uploadedPhotos.entries()) {
                    if (file) {
                        const formData = new FormData();
                        formData.append('member_id', member_id);
                        formData.append('file', file);
                        try {
                            let res = await fetch('/api/upload_photo', {
                                method: 'POST',
                                body: formData
                            });
                            let data = await res.json();
                            if (!res.ok) {
                                alert(data.error || 'ç…§ç‰‡ä¸Šå‚³å¤±æ•—');
                                return;
                            }
                            uploadCount++;
                        } catch (e) {
                            alert('ç…§ç‰‡ä¸Šå‚³ç™¼ç”ŸéŒ¯èª¤');
                            return;
                        }
                    }
                }
                isDirty = false;
                alert("è‡ªæˆ‘ä»‹ç´¹èˆ‡ç…§ç‰‡å·²å„²å­˜ï¼");
            }

            const gallery = document.getElementById("photo-gallery");
            // ç”¨ Map è¨˜éŒ„ key å°æ‡‰çš„ File ç‰©ä»¶
            const uploadedPhotos = new Map();

            document.getElementById("photo-upload").addEventListener("change", function (event) {
                const files = Array.from(event.target.files);
                files.forEach(file => {
                    const fileKey = `${file.name}_${file.size}_${file.type}`;
                    if (uploadedPhotos.has(fileKey)) {
                        alert(`å·²ä¸Šå‚³éç›¸åŒçš„ç…§ç‰‡ï¼Œè«‹å‹¿é‡è¤‡ä¸Šå‚³ã€‚`);
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const photoItem = document.createElement("div");
                        photoItem.className = "photo-item";
                        photoItem.dataset.fileKey = fileKey;
                        const img = document.createElement("img");
                        img.src = e.target.result;
                        const fileInput = document.createElement("input");
                        fileInput.type = "file";
                        fileInput.accept = "image/*";
                        const deleteBtn = document.createElement("button");
                        deleteBtn.className = "delete-btn";
                        deleteBtn.textContent = "âœ•";
                        // é»åœ–ç‰‡é‡æ–°é¸æª”æ¡ˆ
                        img.addEventListener("click", () => fileInput.click());
                        // æ›¿æ›åœ–ç‰‡
                        fileInput.addEventListener("change", function () {
                            const newFile = fileInput.files[0];
                            const newKey = `${newFile.name}_${newFile.size}_${newFile.type}`;
                            if (uploadedPhotos.has(newKey)) {
                                alert(`å·²ç¶“ä¸Šå‚³éï¼Œè«‹é¸å…¶ä»–ç…§ç‰‡ã€‚`);
                                return;
                            }
                            const newReader = new FileReader();
                            newReader.onload = function (ev) {
                                img.src = ev.target.result;
                            };
                            newReader.readAsDataURL(newFile);
                            // æ›´æ–° key
                            uploadedPhotos.delete(fileKey);
                            uploadedPhotos.set(newKey, newFile);
                            photoItem.dataset.fileKey = newKey;
                            isDirty = true;
                        });
                        // åˆªé™¤åœ–ç‰‡å¡ç‰‡
                        deleteBtn.addEventListener("click", () => {
                            gallery.removeChild(photoItem);
                            uploadedPhotos.delete(photoItem.dataset.fileKey);
                            isDirty = true;
                        });
                        photoItem.appendChild(img);
                        photoItem.appendChild(fileInput);
                        photoItem.appendChild(deleteBtn);
                        gallery.insertBefore(photoItem, gallery.querySelector(".upload-label").nextSibling);
                        uploadedPhotos.set(fileKey, file);
                        isDirty = true;
                    };
                    reader.readAsDataURL(file);
                });
                event.target.value = "";
            });

            // é›¢é–‹é é¢å‰æç¤ºæœªå„²å­˜
            window.addEventListener('beforeunload', function(e) {
                if (isDirty) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
        </script>
    </body>
</html>