<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <link rel="manifest" href="/static/manifest.json" />
        <script>
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker
            .register("/static/service-worker.js")
            .then(() => console.log("Service Worker Registered"))
            .catch((error) =>
                console.error("Service Worker Registration Failed:", error)
            );
        }
        </script>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>æ›´æ”¹å¯†ç¢¼</title>
        <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f5f5f5;
            color: #2c4975;
            padding-top: var(--header-h);  /* â† é—œéµï¼šé¨°å‡º header çš„é«˜åº¦ */
        }

        :root{
        --header-h: 64px;     /* header é«˜åº¦ */
        --page-max: 500px;    /* å…§å®¹æœ€å¤§å¯¬ */
        --gutter: 16px;       /* å…§å®¹å·¦å³å…§è·ç”¨ */
        --deep-blue: #2c4975; /* ä¹‹å‰ç”¨åˆ°ä½†æœªå®šç¾©çš„è®Šæ•¸ */
        }
        
        * {
             box-sizing: border-box; 
        }


        .header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 23px 30px;                    /* â† åƒ…å·¦å³ paddingï¼Œé¿å…å¯¦é«˜ > 48px */
        background-color: #fff;
        box-shadow: 0 1px 6px rgba(0,0,0,0.2);
        z-index: 1000;
        box-sizing: border-box;             /* å®‰å…¨ï¼špadding ä¹Ÿç®—åœ¨ 48px å…§ */
        }

        .left-section {
        display: flex;
        justify-content: flex-start;
        align-items: center;
        padding: 0;                         /* â† ä¸è¦ä¸Šä¸‹ padding */
        }

        .left-section svg{
        color: #2c4975;               /* é è¨­æ·±è— */
        transition: color 0.3s ease;  /* æº«å’Œè®ŠåŒ– */
        }
        .left-section svg:hover{
        color: #81d3e1;               /* hover è®Šæ·ºè— */
        }

        .navbar-title {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            font-weight: bold;
            font-size: 18px;
            color: #2c4975;
        }
      #back-button {
        margin-left: -10px; /* ğŸ‘ˆ è®“ç®­é ­èˆ‡å·¦é‚Šä¿æŒè·é›¢ */
      }


        .form-section{
        max-width: var(--page-max);               /* æœ€å¤§å¯¬ 500 */
        width: calc(100% - var(--gutter)*2);      /* å·¦å³ä¿ç•™ç°åº• */
        margin: 0 auto;                            /* ç½®ä¸­ */
        padding: 24px 20px;
        background-color: #fff;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);

        /* é—œéµï¼šé«˜åº¦æ’æ»¿ã€Œæ‰£æ‰ headerã€çš„è¦–çª—é«˜ */
        min-height: calc(100dvh - var(--header-h));
        display: block;
        }

        .form-section h1 {
            font-size: 24px;
            color: #2c4975;
            margin-bottom: 24px;
            text-align: center;
        }

        .form-section label {
            display: block;
            margin-bottom: 6px;
            color: #2c4975;
            font-weight: bold;
        }

        .form-section input {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
        }
        .submit-btn {
        margin-top: 10px;
        width: 250px;
        padding: 12px;
        font-size: 16px;
        font-weight: bold;
        background-color: #81d3e1;   /* æ·ºè—è‰²èƒŒæ™¯ */
        color: white;                /* ç™½è‰²æ–‡å­— */
        border: none;                /* â† ç§»é™¤é‚Šæ¡† */
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        display: block;
        margin-left: auto;
        margin-right: auto;
        }

        .submit-btn:hover {
        background-color: #2c4975;   /* æ·±è— */
        color: white;                /* ä¿æŒç™½å­— */
        }

        .error-text {
            color: #e53935;
            font-size: 14px;
            margin-top: 4px;
            min-height: 20px; /* é ç•™ç©ºé–“é¿å…ç‰ˆé¢è·³å‹• */
        }
        </style>
    </head>
    <body>
        <div class="header">
            <div class="left-section">
                <svg
                id="back-button" 
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                width="24"
                height="24">
                    <path d="M15 19l-7-7 7-7"
                        stroke="currentColor"
                        stroke-width="2"
                        fill="none"
                        stroke-linecap="round"
                        stroke-linejoin="round"></path>
                    <path d="M8 12h14"
                        stroke="currentColor"
                        stroke-width="2"
                        fill="none"
                        stroke-linecap="round"
                        stroke-linejoin="round"></path>
                </svg>
            </div>
            <div class="navbar-title">
                æ›´æ”¹å¯†ç¢¼
            </div>
        </div>
        <div class="form-section">
      

            <label for="new-password">æ–°å¯†ç¢¼</label>
            <input type="password" id="new-password" placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼" />
            <div id="new-password-error" class="error-text"></div>


            <label for="confirm-password">å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼</label>
            <input type="password" id="confirm-password" placeholder="è«‹å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼" />
            <div id="confirm-password-error" class="error-text"></div>
            <button type="button" class="submit-btn" id="submit-btn">ç¢ºèªæ›´æ”¹</button>
        </div>

        <script>
            // è¿”å›æŒ‰éˆ•åŠŸèƒ½
            document.getElementById("back-button").addEventListener("click", function() {
                const urlParams = new URLSearchParams(window.location.search);
                const memberId = urlParams.get("member_id");
                if (memberId) {
                    window.location.href = `/member_view?member_id=${memberId}`;
                } else {
                    console.error("member_id æœªæ‰¾åˆ°");
                }
            });

            // æª¢æŸ¥å¯†ç¢¼æ ¼å¼ç´°ç¯€
            function getPasswordError(password) {
                if (password.length < 8) {
                return "å¯†ç¢¼æœªé”8å­—å…ƒ";
                }

                const hasLower = /[a-z]/.test(password);
                const hasUpper = /[A-Z]/.test(password);
                const hasDigit = /\d/.test(password);

                if (!hasLower || !hasUpper || !hasDigit) {
                return "å¯†ç¢¼éœ€å«å¤§å°å¯«å­—æ¯èˆ‡æ•¸å­—";
                }

                return ""; // âœ… æ ¼å¼æ­£ç¢º
            }

            // é©—è­‰é€å‡º
            document.getElementById("submit-btn").addEventListener("click", async function () {
                const newPassword = document.getElementById("new-password").value.trim();
                const confirmPassword = document.getElementById("confirm-password").value.trim();

                // å…ˆæ¸…é™¤æ‰€æœ‰éŒ¯èª¤æç¤º
                document.getElementById("new-password-error").textContent = "";
                document.getElementById("confirm-password-error").textContent = "";

                let hasError = false;

                if (!newPassword) {
                    document.getElementById("new-password-error").textContent = "è«‹å¡«å¯«æ–°å¯†ç¢¼";
                    hasError = true;
                } else {
                    const passwordError = getPasswordError(newPassword);
                    if (passwordError) {
                        document.getElementById("new-password-error").textContent = passwordError;
                        hasError = true;
                    }
                }

                if (!confirmPassword) {
                document.getElementById("confirm-password-error").textContent = "è«‹å†æ¬¡è¼¸å…¥å¯†ç¢¼";
                hasError = true;
                }

                if (newPassword && confirmPassword && newPassword !== confirmPassword) {
                document.getElementById("confirm-password-error").textContent = "å…©æ¬¡å¯†ç¢¼ä¸ä¸€è‡´";
                hasError = true;
                }

                const urlParams = new URLSearchParams(window.location.search);
                const memberId = urlParams.get("member_id");

                if (!memberId) {
                    alert("ç„¡æ³•æ‰¾åˆ°æœƒå“¡ IDï¼Œè«‹é‡æ–°é€²å…¥é é¢ã€‚");
                    return;
                }

                // å–å¾—èˆŠå¯†ç¢¼
                let currentPassword = "";
                try {
                    const response = await fetch(`/api/members/${memberId}`, {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json",
                        },
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        alert(`å–å¾—èˆŠå¯†ç¢¼å¤±æ•—ï¼š${errorData.error || "æœªçŸ¥éŒ¯èª¤"}`);
                        return;
                    }

                    const memberData = await response.json();
                    currentPassword = memberData.password;
                } catch (error) {
                    console.error("API è«‹æ±‚å¤±æ•—ï¼š", error);
                    alert("å–å¾—èˆŠå¯†ç¢¼å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                    return;
                }

                if (newPassword === confirmPassword && newPassword === currentPassword) {
                    alert("æ–°å¯†ç¢¼ä¸èƒ½èˆ‡èˆŠå¯†ç¢¼ç›¸åŒï¼");
                    return;
                }

                if (hasError) return;

                try {
                    const response = await fetch(`/api/members/change-password?member_id=${memberId}`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ password: newPassword }),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        alert(`å¯†ç¢¼ä¿®æ”¹å¤±æ•—ï¼š${errorData.error || "æœªçŸ¥éŒ¯èª¤"}`);
                        return;
                    }

                    alert("å¯†ç¢¼å·²ä¿®æ”¹æˆåŠŸï¼");
                    window.location.href = `/member_view?member_id=${memberId}`;
                } catch (error) {
                    console.error("API è«‹æ±‚å¤±æ•—ï¼š", error);
                    alert("å¯†ç¢¼ä¿®æ”¹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                }
            });
            // å³æ™‚æ¸…é™¤éŒ¯èª¤æç¤º
            document.getElementById("new-password").addEventListener("input", function () {
                if (this.value.trim()) {
                    document.getElementById("new-password-error").textContent = "";
                }
            });

            document.getElementById("confirm-password").addEventListener("input", function () {
                if (this.value.trim()) {
                    document.getElementById("confirm-password-error").textContent = "";
                }
            });
        </script>
    </body>
</html>
