<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <link rel="manifest" href="/static/manifest.json" />
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("/static/service-worker.js")
          .then(() => console.log("Service Worker Registered"))
          .catch((error) =>
            console.error("Service Worker Registration Failed:", error)
          );
      }
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>課程月費付款</title>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        color: #333;
        margin: 0;
        padding: 0;
      }

      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 30px;
        background-color: #fff;
        flex-wrap: wrap;
        gap: 16px;
        box-shadow: 0 1px 6px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        position: sticky;
        top: 0;
      }

      .left-section {
        display: flex;
        justify-content: flex-start;
        align-items: center;
        padding: 10px;
        margin-left: -10px;
      }

      .left-section svg {
        width: 24px;
        height: 24px;
        fill: #81d3e1;
        cursor: pointer;
        transition: fill 0.3s ease;
      }

      .navbar-title {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        font-weight: bold;
        font-size: 16px;
        color: #2c4975;
      }

      .navbar-title img {
        height: 40px;
        margin-right: 5px;
        margin-top: 3px;
      }

      .container {
        position: relative;
        max-width: 900px;
        min-width: 320px;
        width: 100%;
        margin: 20px auto;
        background-color: #fff;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-wrap: wrap;
        gap: 30px;
        overflow: hidden;
        min-height: 500px;
      }

      .payment-form {
        flex: 1 1 500px;
        z-index: 1;
      }

      .payment-summary {
        flex: 1 1 300px;
        background-color: #f9f9f9;
        padding: 25px;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        height: fit-content;
      }

      .title-row {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        margin-bottom: 30px;
      }

      .logo-inline {
        width: 50px;
        height: 50px;
        object-fit: contain;
        border-radius: 50%;
      }

      h1 {
        color: #2c4975;
        white-space: nowrap;
        font-size: 24px;
        margin: 0;
      }

      .form-row {
        display: flex;
        flex-direction: column;
        margin-bottom: 20px;
      }

      .form-label {
        margin-bottom: 8px;
        font-weight: bold;
        color: #2c4975;
        white-space: nowrap;
      }

      .form-input {
        padding: 12px;
        width: 100%;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.2s ease;
      }

      .form-input:focus {
        outline: none;
        border-color: #81d3e1;
        box-shadow: 0 0 0 2px rgba(129, 211, 225, 0.2);
      }

      .card-row {
        display: flex;
        gap: 10px;
      }

      .card-row .form-input {
        flex: 1;
      }

      .subscription-plan-group {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .subscription-plan {
        flex: 1;
        min-width: 150px;
        padding: 20px 15px;
        background-color: #f9f9f9;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
        font-size: 14px;
        user-select: none;
        position: relative;
      }

      .subscription-plan:hover {
        background-color: #eaf3fa;
        border-color: #81d3e1;
      }

      .subscription-plan input {
        display: none;
      }

      .subscription-plan:has(input:checked) {
        background-color: #81d3e1;
        border-color: #2c4975;
        color: white;
        font-weight: bold;
      }

      .subscription-plan:active {
        transform: scale(0.98);
      }

      .plan-price {
        font-size: 24px;
        font-weight: bold;
        margin: 10px 0 5px 0;
        white-space: nowrap;
      }

      .plan-period {
        font-size: 12px;
        opacity: 0.8;
      }

      .plan-savings {
        position: absolute;
        top: -8px;
        right: -8px;
        background-color: #ff6b6b;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
      }

      .summary-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e0e0e0;
      }

      .summary-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
        font-weight: bold;
        font-size: 18px;
        color: #2c4975;
      }

      .summary-label {
        color: #666;
      }

      .summary-value {
        font-weight: bold;
        color: #333;
      }

             .btn-primary {
         padding: 12px 20px;
         font-size: 16px;
         border: none;
         border-radius: 4px;
         cursor: pointer;
         color: white;
         transition: 0.2s ease;
         white-space: nowrap;
         background-color: #fea3a8;
         width: 100%;
         margin-top: 20px;
         font-weight: bold;
       }

               .btn-primary:hover {
          background-color: #e695a0;
          transform: translateY(-1px);
        }

      .btn-primary:disabled {
        background-color: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      .security-notice {
        background-color: #e8f5e8;
        border: 1px solid #4caf50;
        border-radius: 4px;
        padding: 15px;
        margin-top: 20px;
        font-size: 14px;
        color: #2e7d32;
      }

      .security-notice::before {
        margin-right: 5px;
      }

      @media (max-width: 768px) {
        .container {
          flex-direction: column;
          padding: 20px;
        }
        
        .payment-summary {
          order: -1;
        }
        
        .title-row {
          gap: 8px;
          margin-bottom: 20px;
        }
        
        h1 {
          font-size: 20px;
        }
        
        .form-row {
          margin-bottom: 15px;
        }
        
        .form-label {
          font-size: 14px;
        }
        
        .form-input {
          font-size: 14px;
          padding: 10px;
        }
        
        .btn-primary {
          font-size: 15px;
          padding: 10px 0;
        }
        
        .subscription-plan-group {
          flex-direction: column;
          gap: 10px;
        }
        
        .card-row {
          flex-direction: column;
          gap: 10px;
        }
      }

      @media (max-width: 480px) {
        .container {
          padding: 15px;
        }
        
        h1 {
          font-size: 18px;
        }
        
        .payment-summary {
          padding: 20px;
        }
        
        .subscription-plan {
          min-width: auto;
        }
      }

      /* Modal styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        animation: fadeIn 0.3s ease-in-out;
      }

      .modal-content {
        background-color: #fff;
        margin: 15% auto;
        padding: 30px;
        border-radius: 8px;
        width: 90%;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        animation: slideIn 0.3s ease-out;
      }

      .modal-title {
        color: #2c4975;
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 15px;
      }

      .modal-message {
        color: #333;
        font-size: 16px;
        line-height: 1.5;
        margin-bottom: 25px;
      }

      .modal-btn {
        background-color: #fea3a8;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }

      .modal-btn:hover {
        background-color: #e695a0;
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      @keyframes slideIn {
        from { 
          opacity: 0;
          transform: translateY(-50px);
        }
        to { 
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="left-section">
        <svg
          id="back-button" 
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          width="24"
          height="24">
          <path d="M15 19l-7-7 7-7"
            stroke="#81d3e1"
            stroke-width="2"
            fill="none"
            stroke-linecap="round"
            stroke-linejoin="round"></path>
          <path d="M8 12h14"
            stroke="#81d3e1"
            stroke-width="2"
            fill="none"
            stroke-linecap="round"
            stroke-linejoin="round"></path>
        </svg>
      </div>
      <div class="navbar-title">
        <img src="/static/logo.png" alt="Logo" />
        課程月費付款
      </div>
    </div>

    <div class="container">
      <div class="payment-form">


        <form id="paymentForm">
          <div class="form-row">
            <label class="form-label">月費方案</label>
            <div class="subscription-plan-group">
              <div class="subscription-plan">
                <input type="radio" name="subscriptionPlan" value="monthly" id="monthly" checked>
                <label for="monthly">
                  <div>月費</div>
                  <div class="plan-price">NT$ 200</div>
                  <div class="plan-period">每月</div>
                </label>
              </div>
              <div class="subscription-plan">
                <input type="radio" name="subscriptionPlan" value="quarterly" id="quarterly">
                <label for="quarterly">
                  <div>季費</div>
                  <div class="plan-price">NT$ 400</div>
                  <div class="plan-period">每季</div>
                  <div class="plan-savings">省 NT$ 200</div>
                </label>
              </div>
              <div class="subscription-plan">
                <input type="radio" name="subscriptionPlan" value="yearly" id="yearly">
                <label for="yearly">
                  <div>年費</div>
                  <div class="plan-price">NT$ 1,600</div>
                  <div class="plan-period">每年</div>
                  <div class="plan-savings">省 NT$ 800</div>
                </label>
              </div>
            </div>
          </div>

          <div class="form-row">
            <label for="cardNumber" class="form-label">卡號</label>
            <input
              type="text"
              id="cardNumber"
              name="cardNumber"
              class="form-input"
              placeholder="1234 5678 9012 3456"
              maxlength="19"
              required
            />
          </div>

          <div class="form-row">
            <label for="cardHolder" class="form-label">持卡人姓名</label>
            <input
              type="text"
              id="cardHolder"
              name="cardHolder"
              class="form-input"
              placeholder="請輸入持卡人姓名"
              required
            />
          </div>

          <div class="form-row">
            <label class="form-label">有效期限</label>
            <div class="card-row">
              <input
                type="text"
                id="expiryMonth"
                name="expiryMonth"
                class="form-input"
                placeholder="MM"
                maxlength="2"
                required
              />
              <span style="display: flex; align-items: center; font-size: 18px; color: #666;">/</span>
              <input
                type="text"
                id="expiryYear"
                name="expiryYear"
                class="form-input"
                placeholder="YY"
                maxlength="2"
                required
              />
            </div>
          </div>

          <div class="form-row">
            <label for="cvv" class="form-label">安全碼</label>
            <input
              type="text"
              id="cvv"
              name="cvv"
              class="form-input"
              placeholder="123"
              maxlength="4"
              required
            />
          </div>

          <div class="form-row">
            <button type="submit" class="btn-primary" id="submitBtn">確認付款</button>
          </div>

          <div class="security-notice">
            您的付款資訊將透過SSL加密傳輸，確保交易安全。
          </div>
        </form>
      </div>

      <div class="payment-summary">
        <h3 style="color: #2c4975; margin-top: 0; margin-bottom: 20px;">付款摘要</h3>
        
        <div class="summary-item">
          <span class="summary-label">選擇方案</span>
          <span class="summary-value" id="selectedPlan">月費</span>
        </div>
        
        <div class="summary-item">
          <span class="summary-label">方案費用</span>
          <span class="summary-value" id="planFee">NT$ 200</span>
        </div>
        
        
        <div class="summary-item">
          <span class="summary-label">優惠折扣</span>
          <span class="summary-value" id="discount">NT$ 0</span>
        </div>
        
        <div class="summary-item">
          <span class="summary-label">總計</span>
          <span class="summary-value" id="totalAmount">NT$ 200</span>
        </div>
        
        <div style="margin-top: 20px; padding: 15px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; font-size: 13px; color: #856404;">
          <strong>注意事項：</strong><br>
          • 月費將於每月自動扣款<br>
          • 可隨時取消訂閱<br>
          • 課程開始前7天可申請退款
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div id="infoModal" class="modal">
      <div class="modal-content">
        <div class="modal-title">課程月費方案</div>
        <div class="modal-message">加入課程月費可享有無限次數發起課程的功能</div>
        <button class="modal-btn" onclick="closeModal()">我知道了</button>
      </div>
    </div>

    <script>
      // 卡號格式化
      document.getElementById('cardNumber').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\s/g, '').replace(/\D/g, '');
        let formattedValue = value.replace(/(\d{4})(?=\d)/g, '$1 ');
        e.target.value = formattedValue;
      });

      // 月份限制
      document.getElementById('expiryMonth').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value > 12) value = 12;
        if (value < 1) value = '';
        e.target.value = value;
      });

      // 年份限制
      document.getElementById('expiryYear').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length === 2) {
          let currentYear = new Date().getFullYear().toString().slice(-2);
          if (value < currentYear) {
            e.target.value = currentYear;
          }
        }
      });

      // CVV 只允許數字
      document.getElementById('cvv').addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/\D/g, '');
      });

      // 月費方案選擇
      document.querySelectorAll('.subscription-plan').forEach(plan => {
        plan.addEventListener('click', function() {
          const radio = this.querySelector('input[type="radio"]');
          radio.checked = true;
          updateSummary();
        });
      });

      // 更新付款摘要
      function updateSummary() {
        const selectedPlan = document.querySelector('input[name="subscriptionPlan"]:checked').value;
        const planData = {
          monthly: { name: '月費', fee: 200, discount: 0 },
          quarterly: { name: '季費', fee: 600, discount: 200 },
          yearly: { name: '年費', fee: 2400, discount: 800 }
        };
        
        const plan = planData[selectedPlan];
        const total = plan.fee - plan.discount;
        
        document.getElementById('selectedPlan').textContent = plan.name;
        document.getElementById('planFee').textContent = `NT$ ${plan.fee.toLocaleString()}`;
        document.getElementById('discount').textContent = `NT$ ${plan.discount}`;
        document.getElementById('totalAmount').textContent = `NT$ ${total.toLocaleString()}`;
      }

      // 表單提交
      document.getElementById('paymentForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('submitBtn');
        const originalText = submitBtn.textContent;
        
        // 基本驗證
        const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
        const cardHolder = document.getElementById('cardHolder').value.trim();
        const expiryMonth = document.getElementById('expiryMonth').value;
        const expiryYear = document.getElementById('expiryYear').value;
        const cvv = document.getElementById('cvv').value;
        
        if (!cardNumber || cardNumber.length < 16) {
          alert('請輸入有效的卡號');
          return;
        }
        
        if (!cardHolder) {
          alert('請輸入持卡人姓名');
          return;
        }
        
        if (!expiryMonth || !expiryYear) {
          alert('請輸入有效期限');
          return;
        }
        
        if (!cvv || cvv.length < 3) {
          alert('請輸入安全碼');
          return;
        }
        
        // 顯示處理中狀態
        submitBtn.textContent = '處理中...';
        submitBtn.disabled = true;
        
        try {
          // 這裡可以加入實際的付款API調用
          // 模擬API調用延遲
          await new Promise(resolve => setTimeout(resolve, 2000));
          
          // 獲取選擇的方案和金額
          const selectedPlan = document.querySelector('input[name="subscriptionPlan"]:checked').value;
          const planData = {
            monthly: { name: '月費方案', fee: 200, discount: 0, api: 'month', months: 1 },
            quarterly: { name: '季費方案', fee: 600, discount: 200, api: 'season', months: 3 },
            yearly: { name: '年費方案', fee: 2400, discount: 800, api: 'year', months: 12 }
          };
          const plan = planData[selectedPlan];
          const total = plan.fee - plan.discount;
          // 取得 member_id
          // 一律從網址參數取得 member_id
          const urlParams = new URLSearchParams(window.location.search);
          let memberId = urlParams.get('member_id');
          if (!memberId) {
            // 嘗試從 hash 或其他方式取得（可擴充）
            alert('找不到會員資訊，請重新登入');
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
            return;
          }
          // 計算到期日
          const now = new Date();
          let expire = new Date(now);
          expire.setMonth(expire.getMonth() + plan.months);
          // 若跨年自動修正
          if (expire.getDate() !== now.getDate()) {
            expire.setDate(0);
          }
          const expireAt = expire.toISOString();
          // 呼叫訂閱API
          const resp = await fetch(`/api/members/${memberId}/subscribe`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              plan: plan.api,
              amount: total,
              expire_at: expireAt
            })
          });
          if (!resp.ok) {
            const err = await resp.json();
            throw new Error(err.error || '訂閱失敗');
          }
          // 導向成功頁
          const planParam = encodeURIComponent(plan.name);
          const amountParam = total.toLocaleString();
          let nextUrl = `/payment_success?plan=${planParam}&amount=${amountParam}`;
          if (memberId) {
            nextUrl += `&member_id=${memberId}`;
          }
          window.location.href = nextUrl;
          
        } catch (error) {
          alert('付款失敗：' + (error.message || '請稍後再試'));
          submitBtn.textContent = originalText;
          submitBtn.disabled = false;
        }
      });

      // 頁面載入時執行
      updateSummary();
      
      // 顯示資訊彈窗
      showModal();
      
      // 顯示彈窗函數
      function showModal() {
        document.getElementById('infoModal').style.display = 'block';
      }
      
      // 關閉彈窗函數
      function closeModal() {
        document.getElementById('infoModal').style.display = 'none';
      }
      
      // 點擊彈窗外部關閉
      window.onclick = function(event) {
        const modal = document.getElementById('infoModal');
        if (event.target === modal) {
          modal.style.display = 'none';
        }
      }

      // 返回按鈕功能
      document.getElementById("back-button").addEventListener("click", function() {
        const urlParams = new URLSearchParams(window.location.search);
        const memberId = urlParams.get("member_id");
        if (memberId) {
          window.location.href = `/member_view?member_id=${memberId}`;
        } else {
          window.history.back();
        }
      });
    </script>
  </body>
</html>
