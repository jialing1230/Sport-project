<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æœƒå“¡åŸºæœ¬è³‡æ–™</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"
      rel="stylesheet"
    />
    <style>
      * { box-sizing: border-box; }
      body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        color: #333;
        margin: 0;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
      }
      .container {
        position: relative;
        max-width: 800px;
        width: 100%;
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
      }
      .form-box { flex:1 1 300px; display:flex; flex-direction:column; }
      .image-box { flex:1 1 300px; display:flex; justify-content:center; align-items:center; }
      .image-box img { max-width:100%; max-height:300px; object-fit:contain; border-radius:6px; }
      .title-row { display:flex; justify-content:center; align-items:center; gap:12px; margin-bottom:30px; }
      .logo-inline { width:50px; height:50px; border-radius:50%; object-fit:contain; }
      h1 { margin:0; font-size:24px; color:#2c4975; white-space:nowrap; }
      .required-star { color:red; margin-left:5px; font-size:18px; }
      .form-row { margin-bottom:15px; width:100%; display:flex; flex-direction:column; }
      .form-label { font-weight:bold; margin-bottom:6px; color:#2c4975; white-space:nowrap; }
      .form-input, .form-select {
        padding:10px; width:100%;
        border:1px solid #ccc; border-radius:4px;
      }
      #avatarInput { display:none; }
      .avatar-wrapper { display:flex; justify-content:center; margin-top:10px; }
      #avatarPreview {
        width:120px; height:120px; border:2px dashed #ccc;
        border-radius:50%; display:flex; justify-content:center; align-items:center;
        cursor:pointer; position:relative;
      }
      #avatarPreview.uploaded { border-color:#2c4975; }
      #avatarPreview img { width:100%; height:100%; object-fit:cover; border-radius:50%; }
      .remove-avatar-btn {
        position:absolute; top:-8px; right:-8px;
        background:none; border:none; color:#2c4975;
        font-size:24px; font-weight:900; cursor:pointer;
        transition:color .2s, transform .2s;
      }
      .remove-avatar-btn:hover { color:#1f3555; transform:scale(1.2); }
      .gender-options { display:flex; gap:20px; margin-top:6px; }
      .btn-primary {
        background:#81d3e1; color:#fff;
        padding:10px; font-size:16px;
        border:none; border-radius:4px;
        cursor:pointer; width:100%; transition:.2s;
      }
      .btn-primary:hover { background:#2c4975; }
      #cropModal {
        position:fixed; top:0; left:0; width:100vw; height:100vh;
        background:rgba(0,0,0,0.7); display:none;
        align-items:center; justify-content:center; z-index:999;
      }
      #cropContainer {
        background:#fff; padding:20px; border-radius:8px;
        max-width:90vw; max-height:90vh;
      }
      #cropImage { max-width:100%; max-height:60vh; display:block; }
      #cropConfirm {
        margin-top:10px; padding:8px 16px;
        background:#2c4975; color:#fff;
        border:none; border-radius:4px; cursor:pointer;
      }
      @media (max-width:768px){ .container { flex-direction:column; } .image-box { display:none; } }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="form-box">
        <div class="title-row">
          <img src="{{ url_for('static', filename='logo.jpg') }}" alt="Logo" class="logo-inline" />
          <h1>åŸºæœ¬è³‡æ–™</h1>
        </div>

        <div class="form-row">
          <label class="form-label">ä¸Šå‚³é ­åƒ</label>
          <input type="file" id="avatarInput" accept="image/*" />
          <div class="avatar-wrapper">
            <div id="avatarPreview">é»æ“Šä¸Šå‚³</div>
          </div>
        </div>

        <form id="profileForm">
          <div class="form-row">
            <label class="form-label" for="name">å§“å<span class="required-star">*</span></label>
            <input type="text" id="name" class="form-input" required />
          </div>
          <div class="form-row">
            <label class="form-label">å‡ºç”Ÿå¹´æœˆ<span class="required-star">*</span></label>
            <div style="display:flex;gap:10px">
              <select id="birth-year" class="form-select" required>
                <option value="">å¹´</option>
              </select>
              <select id="birth-month" class="form-select" required>
                <option value="">æœˆ</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <label class="form-label">æ€§åˆ¥<span class="required-star">*</span></label>
            <div class="gender-options">
              <label><input type="radio" name="gender" value="male" required />ç”·</label>
              <label><input type="radio" name="gender" value="female" required />å¥³</label>
            </div>
          </div>
          <div class="form-row">
            <label class="form-label">å±…ä½åœ°å€<span class="required-star">*</span></label>
            <div style="display:flex;gap:10px">
              <select id="city" class="form-select" required>
                <option value="">ç¸£å¸‚</option>
              </select>
              <select id="district" class="form-select" required>
                <option value="">é„‰é®å€</option>
              </select>
            </div>
          </div>

          <button type="submit" class="btn-primary">ä¸‹ä¸€æ­¥</button>
        </form>
      </div>

      <div class="image-box">
        <img src="{{ url_for('static', filename='logo.jpg') }}" alt="illustration" />
      </div>
    </div>

    <div id="cropModal">
      <div id="cropContainer">
        <img id="cropImage" src="" alt="è£å‰ªåœ–ç‰‡" />
        <button id="cropConfirm">å®Œæˆè£å‰ª</button>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script>
      // 1) å¾æ¨¡æ¿æ³¨å…¥çš„ member_id
      const MEMBER_ID = "{{ member_id }}";
      if (!MEMBER_ID) {
        alert('ç¼ºå°‘ member_idï¼Œè«‹é‡æ–°ç™»å…¥');
        window.location.href = '/login';
      }

      // 2) åœ–ç‰‡è£å‰ªè¨­å®š
      const avatarInput = document.getElementById('avatarInput');
      const avatarPreview = document.getElementById('avatarPreview');
      const cropModal = document.getElementById('cropModal');
      const cropImage = document.getElementById('cropImage');
      const cropConfirm = document.getElementById('cropConfirm');
      let cropper;
      avatarPreview.addEventListener('click', ()=> avatarInput.click());
      avatarInput.addEventListener('change', e=>{
        const file = e.target.files[0];
        if (!file||!file.type.startsWith('image/')) return;
        const reader = new FileReader();
        reader.onload = ev => {
          cropImage.src = ev.target.result;
          cropModal.style.display = 'flex';
          cropper && cropper.destroy();
          cropper = new Cropper(cropImage, { aspectRatio:1, viewMode:1, autoCropArea:1, background:false, guides:false });
        };
        reader.readAsDataURL(file);
      });
      cropConfirm.addEventListener('click', ()=>{
        const canvas = cropper.getCroppedCanvas({ width:300, height:300 });
        const url = canvas.toDataURL('image/png');
        avatarPreview.classList.add('uploaded');
        avatarPreview.innerHTML = `<div style="position:relative;width:100%;height:100%;"><img src="${url}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;"/><button id="removeAvatar" class="remove-avatar-btn">âœ•</button></div>`;
        document.getElementById('removeAvatar').addEventListener('click', ev=>{ev.stopPropagation();avatarPreview.innerHTML='é»æ“Šä¸Šå‚³';avatarPreview.classList.remove('uploaded');avatarInput.value='';});
        cropModal.style.display = 'none';
        cropper.destroy();
      });

      // 3) å¹´æœˆä¸‹æ‹‰
      const yearSel = document.getElementById('birth-year'), monSel = document.getElementById('birth-month'), thisYr = new Date().getFullYear();
      for(let y=thisYr-100; y<=thisYr; y++){ let o=document.createElement('option'); o.value=y; o.text=`${y} å¹´`; yearSel.appendChild(o);}  
      for(let m=1; m<=12; m++){ let o=document.createElement('option'); o.value=String(m).padStart(2,'0'); o.text=`${m} æœˆ`; monSel.appendChild(o);}  

      // 4) ç¸£å¸‚ã€å€åŸŸä¸‹æ‹‰
      const cityDistrictData = {
        å°åŒ—å¸‚: [
          "ä¸­æ­£å€",
          "å¤§åŒå€",
          "ä¸­å±±å€",
          "æ¾å±±å€",
          "å¤§å®‰å€",
          "è¬è¯å€",
          "ä¿¡ç¾©å€",
          "å£«æ—å€",
          "åŒ—æŠ•å€",
          "å…§æ¹–å€",
          "å—æ¸¯å€",
          "æ–‡å±±å€",
        ],
        æ–°åŒ—å¸‚: [
          "æ¿æ©‹å€",
          "ä¸‰é‡å€",
          "ä¸­å’Œå€",
          "æ°¸å’Œå€",
          "æ–°èŠå€",
          "æ–°åº—å€",
          "åœŸåŸå€",
          "æ¨¹æ—å€",
          "é¶¯æ­Œå€",
          "ä¸‰å³½å€",
          "æ·¡æ°´å€",
          "æ±æ­¢å€",
          "ç‘èŠ³å€",
          "è˜†æ´²å€",
          "äº”è‚¡å€",
          "æ³°å±±å€",
          "æ—å£å€",
          "æ·±å‘å€",
          "çŸ³ç¢‡å€",
          "åªæ—å€",
          "ä¸‰èŠå€",
          "çŸ³é–€å€",
          "å…«é‡Œå€",
          "å¹³æºªå€",
          "é›™æºªå€",
          "è²¢å¯®å€",
          "é‡‘å±±å€",
          "è¬é‡Œå€",
          "çƒä¾†å€",
        ],
        åŸºéš†å¸‚: [
          "ä»æ„›å€",
          "ä¿¡ç¾©å€",
          "ä¸­æ­£å€",
          "ä¸­å±±å€",
          "å®‰æ¨‚å€",
          "æš–æš–å€",
          "ä¸ƒå µå€",
        ],
        æ¡ƒåœ’å¸‚: [
          "æ¡ƒåœ’å€",
          "ä¸­å£¢å€",
          "å¹³é®å€",
          "å…«å¾·å€",
          "æ¥Šæ¢…å€",
          "è˜†ç«¹å€",
          "å¤§åœ’å€",
          "é¾œå±±å€",
          "å¤§æºªå€",
          "é¾æ½­å€",
          "æ–°å±‹å€",
          "è§€éŸ³å€",
          "å¾©èˆˆå€",
        ],
        æ–°ç«¹å¸‚: ["æ±å€", "åŒ—å€", "é¦™å±±å€"],
        æ–°ç«¹ç¸£: [
          "ç«¹åŒ—å¸‚",
          "ç«¹æ±é®",
          "æ–°è±é„‰",
          "æ¹–å£é„‰",
          "æ–°åŸ”é®",
          "é—œè¥¿é®",
          "èŠæ—é„‰",
          "å¯¶å±±é„‰",
          "åŒ—åŸ”é„‰",
          "å³¨çœ‰é„‰",
          "æ©«å±±é„‰",
          "å°–çŸ³é„‰",
          "äº”å³°é„‰",
        ],
        å®œè˜­ç¸£: [
          "å®œè˜­å¸‚",
          "ç¾…æ±é®",
          "è˜‡æ¾³é®",
          "é ­åŸé®",
          "ç¤æºªé„‰",
          "å£¯åœé„‰",
          "å“¡å±±é„‰",
          "å†¬å±±é„‰",
          "äº”çµé„‰",
          "ä¸‰æ˜Ÿé„‰",
          "å¤§åŒé„‰",
          "å—æ¾³é„‰",
        ],
        è‹—æ —ç¸£: [
          "è‹—æ —å¸‚",
          "é ­ä»½å¸‚",
          "è‹‘è£¡é®",
          "é€šéœ„é®",
          "ç«¹å—é®",
          "å¾Œé¾é®",
          "å“è˜­é®",
          "è¥¿æ¹–é„‰",
          "é€ æ©‹é„‰",
          "ä¸‰ç£é„‰",
          "å—åº„é„‰",
          "é ­å±‹é„‰",
          "å…¬é¤¨é„‰",
          "å¤§æ¹–é„‰",
          "ç…æ½­é„‰",
          "æ³°å®‰é„‰",
        ],
        å°ä¸­å¸‚: [
          "ä¸­å€",
          "æ±å€",
          "å—å€",
          "è¥¿å€",
          "åŒ—å€",
          "è¥¿å±¯å€",
          "åŒ—å±¯å€",
          "å—å±¯å€",
          "å¤ªå¹³å€",
          "å¤§é‡Œå€",
          "éœ§å³°å€",
          "çƒæ—¥å€",
          "è±åŸå€",
          "åé‡Œå€",
          "æ±å‹¢å€",
          "çŸ³å²¡å€",
          "æ–°ç¤¾å€",
          "å’Œå¹³å€",
          "ç¥å²¡å€",
          "æ½­å­å€",
          "å¤§é›…å€",
          "å¤§è‚šå€",
          "é¾äº•å€",
          "æ²™é¹¿å€",
          "æ¸…æ°´å€",
          "æ¢§æ£²å€",
          "å¤§ç”²å€",
          "å¤–åŸ”å€",
          "å¤§å®‰å€",
        ],
        å½°åŒ–ç¸£: [
          "å½°åŒ–å¸‚",
          "å“¡æ—å¸‚",
          "å’Œç¾é®",
          "é¹¿æ¸¯é®",
          "æºªæ¹–é®",
          "ç”°ä¸­é®",
          "åŒ—æ–—é®",
          "èŠ±å£‡é„‰",
          "èŠ¬åœ’é„‰",
          "ç¦èˆˆé„‰",
          "ç§€æ°´é„‰",
          "åŸ”å¿ƒé„‰",
          "æ°¸é–é„‰",
          "ç¤¾é ­é„‰",
          "äºŒæ°´é„‰",
          "ç”°å°¾é„‰",
          "åŸ¤é ­é„‰",
          "èŠ³è‹‘é„‰",
          "å¤§æ‘é„‰",
          "ç«¹å¡˜é„‰",
          "æºªå·é„‰",
        ],
        å—æŠ•ç¸£: [
          "å—æŠ•å¸‚",
          "åŸ”é‡Œé®",
          "è‰å±¯é®",
          "ç«¹å±±é®",
          "é›†é›†é®",
          "åé–“é„‰",
          "é¹¿è°·é„‰",
          "ä¸­å¯®é„‰",
          "é­šæ± é„‰",
          "åœ‹å§“é„‰",
          "æ°´é‡Œé„‰",
          "ä¿¡ç¾©é„‰",
          "ä»æ„›é„‰",
        ],
        é›²æ—ç¸£: [
          "æ–—å…­å¸‚",
          "æ–—å—é®",
          "è™å°¾é®",
          "è¥¿èºé®",
          "åœŸåº«é®",
          "åŒ—æ¸¯é®",
          "å¤å‘é„‰",
          "å¤§åŸ¤é„‰",
          "è¿æ¡é„‰",
          "æ—å…§é„‰",
          "äºŒå´™é„‰",
          "å´™èƒŒé„‰",
          "éº¥å¯®é„‰",
          "æ±å‹¢é„‰",
          "è¤’å¿ é„‰",
          "è‡ºè¥¿é„‰",
          "å…ƒé•·é„‰",
          "å››æ¹–é„‰",
          "å£æ¹–é„‰",
          "æ°´æ—é„‰",
        ],
        å˜‰ç¾©å¸‚: ["æ±å€", "è¥¿å€"],
        å˜‰ç¾©ç¸£: [
          "å¤ªä¿å¸‚",
          "æœ´å­å¸‚",
          "å¸ƒè¢‹é®",
          "å¤§æ—é®",
          "æ°‘é›„é„‰",
          "æºªå£é„‰",
          "æ–°æ¸¯é„‰",
          "å…­è…³é„‰",
          "æ±çŸ³é„‰",
          "ç¾©ç«¹é„‰",
          "é¹¿è‰é„‰",
          "æ°´ä¸Šé„‰",
          "ä¸­åŸ”é„‰",
          "ç«¹å´é„‰",
          "æ¢…å±±é„‰",
          "ç•ªè·¯é„‰",
          "å¤§åŸ”é„‰",
          "é˜¿é‡Œå±±é„‰",
        ],
        å°å—å¸‚: [
          "ä¸­è¥¿å€",
          "æ±å€",
          "å—å€",
          "åŒ—å€",
          "å®‰å¹³å€",
          "å®‰å—å€",
          "æ°¸åº·å€",
          "æ­¸ä»å€",
          "æ–°åŒ–å€",
          "å·¦é®å€",
          "ç‰äº•å€",
          "æ¥ è¥¿å€",
          "å—åŒ–å€",
          "ä»å¾·å€",
          "é—œå»Ÿå€",
          "é¾å´å€",
          "å®˜ç”°å€",
          "éº»è±†å€",
          "ä½³é‡Œå€",
          "è¥¿æ¸¯å€",
          "ä¸ƒè‚¡å€",
          "å°‡è»å€",
          "å­¸ç”²å€",
          "åŒ—é–€å€",
          "æ–°ç‡Ÿå€",
          "å¾Œå£å€",
          "ç™½æ²³å€",
          "æ±å±±å€",
          "å…­ç”²å€",
          "ä¸‹ç‡Ÿå€",
          "æŸ³ç‡Ÿå€",
          "é¹½æ°´å€",
          "å–„åŒ–å€",
          "å¤§å…§å€",
          "å±±ä¸Šå€",
          "æ–°å¸‚å€",
          "å®‰å®šå€",
        ],
        é«˜é›„å¸‚: [
          "æ–°èˆˆå€",
          "å‰é‡‘å€",
          "è‹“é›…å€",
          "é¹½åŸ•å€",
          "é¼“å±±å€",
          "æ——æ´¥å€",
          "å‰é®å€",
          "ä¸‰æ°‘å€",
          "æ¥ æ¢“å€",
          "å°æ¸¯å€",
          "å·¦ç‡Ÿå€",
          "ä»æ­¦å€",
          "å¤§ç¤¾å€",
          "å²¡å±±å€",
          "è·¯ç«¹å€",
          "é˜¿è“®å€",
          "ç”°å¯®å€",
          "ç‡•å·¢å€",
          "æ©‹é ­å€",
          "æ¢“å®˜å€",
          "å½Œé™€å€",
          "æ°¸å®‰å€",
          "æ¹–å…§å€",
          "é³³å±±å€",
          "å¤§å¯®å€",
          "æ—åœ’å€",
          "é³¥æ¾å€",
          "å¤§æ¨¹å€",
          "æ——å±±å€",
          "ç¾æ¿ƒå€",
          "å…­é¾œå€",
          "å…§é–€å€",
          "æ‰æ—å€",
          "ç”²ä»™å€",
          "æ¡ƒæºå€",
          "é‚£ç‘ªå¤å€",
          "èŒ‚æ—å€",
          "èŒ„è£å€",
        ],
        å±æ±ç¸£: [
          "å±æ±å¸‚",
          "æ½®å·é®",
          "æ±æ¸¯é®",
          "æ†æ˜¥é®",
          "è¬ä¸¹é„‰",
          "é•·æ²»é„‰",
          "éºŸæ´›é„‰",
          "ä¹å¦‚é„‰",
          "é‡Œæ¸¯é„‰",
          "é¹½åŸ”é„‰",
          "é«˜æ¨¹é„‰",
          "è¬å·’é„‰",
          "å…§åŸ”é„‰",
          "ç«¹ç”°é„‰",
          "æ–°åŸ¤é„‰",
          "æ‹å¯®é„‰",
          "æ–°åœ’é„‰",
          "å´é ‚é„‰",
          "æ—é‚Šé„‰",
          "å—å·é„‰",
          "ä½³å†¬é„‰",
          "ç‰çƒé„‰",
          "è»ŠåŸé„‰",
          "æ»¿å·é„‰",
          "æ‹å±±é„‰",
          "ä¸‰åœ°é–€é„‰",
          "éœ§å°é„‰",
          "ç‘ªå®¶é„‰",
          "æ³°æ­¦é„‰",
          "ä¾†ç¾©é„‰",
          "æ˜¥æ—¥é„‰",
          "ç…å­é„‰",
          "ç‰¡ä¸¹é„‰",
        ],
        èŠ±è“®ç¸£: [
          "èŠ±è“®å¸‚",
          "é³³æ—é®",
          "ç‰é‡Œé®",
          "æ–°åŸé„‰",
          "å‰å®‰é„‰",
          "å£½è±é„‰",
          "å…‰å¾©é„‰",
          "è±æ¿±é„‰",
          "ç‘ç©—é„‰",
          "è¬æ¦®é„‰",
          "å“æºªé„‰",
          "ç§€æ—é„‰",
        ],
        å°æ±ç¸£: [
          "å°æ±å¸‚",
          "æˆåŠŸé®",
          "é—œå±±é®",
          "å‘å—é„‰",
          "å¤§æ­¦é„‰",
          "å¤ªéº»é‡Œé„‰",
          "æ±æ²³é„‰",
          "é•·æ¿±é„‰",
          "é¹¿é‡é„‰",
          "æ± ä¸Šé„‰",
          "ç¶ å³¶é„‰",
          "å»¶å¹³é„‰",
          "æµ·ç«¯é„‰",
          "é‡‘å³°é„‰",
          "é”ä»é„‰",
          "è˜­å¶¼é„‰",
        ],
        æ¾æ¹–ç¸£: ["é¦¬å…¬å¸‚", "æ¹–è¥¿é„‰", "ç™½æ²™é„‰", "è¥¿å¶¼é„‰", "æœ›å®‰é„‰", "ä¸ƒç¾é„‰"],
        é‡‘é–€ç¸£: ["é‡‘åŸé®", "é‡‘æ¹–é®", "é‡‘æ²™é®", "é‡‘å¯§é„‰", "çƒˆå¶¼é„‰", "çƒåµé„‰"],
        é€£æ±Ÿç¸£: ["å—ç«¿é„‰", "åŒ—ç«¿é„‰", "è’å…‰é„‰", "æ±å¼•é„‰"],
      };
      const citySel = document.getElementById('city'), distSel = document.getElementById('district');
      Object.keys(cityDistrictData).forEach(c=>{ let o=document.createElement('option'); o.value=c; o.text=c; citySel.appendChild(o); });
      citySel.addEventListener('change', function(){ distSel.innerHTML='<option value="">é„‰é®å€</option>'; (cityDistrictData[this.value]||[]).forEach(d=>{ let o=document.createElement('option'); o.value=d; o.text=d; distSel.appendChild(o); }); });

      // 5) è¡¨å–®é€å‡º
      document.getElementById('profileForm').addEventListener('submit', async e=>{
        e.preventDefault();
        const name = document.getElementById('name').value.trim();
        const year = yearSel.value;
        const month = monSel.value;
        const gender = document.querySelector('input[name="gender"]:checked')?.value;
        const city = citySel.value;
        const area = distSel.value;
        if(!name||!year||!month||!gender||!city||!area){ alert('è«‹å°‡æ‰€æœ‰æ¬„ä½å¡«å¯«å®Œæ•´'); return; }
        const birthdate = `${year}-${month}-01`;
        try { const res = await fetch(`/api/members/${MEMBER_ID}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ name, gender, birthdate, city, area }) });
                const data = await res.json();
                if(res.ok&&data.success){ let msg=document.createElement('div'); msg.textContent='è³‡æ–™æ–°å¢æˆåŠŸ ğŸ‰'; msg.style.color='green'; document.querySelector('.form-box').prepend(msg); }
                else throw new Error(data.error||'æ›´æ–°å¤±æ•—'); }
        catch(err){ alert(err.message);}      
      });
    </script>
  </body>
</html>
