<!DOCTYPE html>
<html lang="zh-Hant">
    <head>
        <link rel="manifest" href="/static/manifest.json" />
        <script>
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker
            .register("/static/service-worker.js")
            .then(() => console.log("Service Worker Registered"))
            .catch((error) =>
                console.error("Service Worker Registration Failed:", error)
            );
        }
        </script>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>編輯公開資料</title>
       <style>
            body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f5f5f5;  /* 灰底 */
            color: #2c4975;
            }

            :root {
            --page-max: 500px;   /* 內容最大寬 */
            --gutter: 16px;      /* 左右內距 */
            --deep-blue: #2c4975;
            }

            /* 讓頁面高度撐滿視窗（header 固定，上方不動） */
            main {
            min-height: calc(100vh - 64px); /* 64px 可視需求微調 */
            display: block;
            }

            /* 中央內容容器：限制寬度、置中、左右保留灰底 */
            .container {
            /* 讓白底永遠比畫面窄一點 → 左右各留 16px 灰邊 */
            width: min(500px, calc(100% - 32px));
            margin: 0 auto;                 
            padding: 0 var(--gutter) 24px;  /* 內容內距 */
            box-sizing: border-box;
            background: #fff;               
            min-height: calc(100vh - 64px); /* header 高度仍用 64px */
            }


            /* Header 區域 */
            .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 30px;
            background-color: #fff;
            flex-wrap: wrap;
            gap: 16px;
            box-shadow: 0 1px 6px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            position: sticky;
            top: 0;
            }

            .left-section {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            padding: 10px;
            }

            .left-section svg path {
            stroke: #2c4975;                 /* 預設深藍 */
            transition: stroke 0.3s ease;    /* 過渡順暢 */
            }

            .left-section svg:hover path {
            stroke: #81d3e1;                 /* hover 淺藍 */
            }

            .navbar-title {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            font-weight: bold;
            font-size: 16px;
            color: #2c4975;
            }

            .navbar-title img {
            height: 40px;
            margin-right: 5px;
            margin-top: 3px;
            }

            /* ===== 單一卡片樣式 ===== */
            .card {
            background: #fff;
            border-radius: 0;   /* 上下要貼滿，就不要圓角 */
            box-shadow: none;  /* 可以保留或拿掉，看你要不要卡片感 */
            padding: 20px 4px 4px 4px;
            margin: 0;         /* 上下取消留白 */
            min-height: calc(100vh - 64px); /* 撐滿除掉 header 的整個高度 */
            }

            /* 卡片內標題 */
            .section-title {
            margin: 0 0 12px;
            color: #81d3e1;
            font-weight: 700;
            font-size: 18px;
            }

            /* 卡片分隔線 */
            .card-divider {
            border: none;
            height: 1px;
            background: rgba(0,0,0,0.08);
            margin: 20px 0;
            }

            /* 表單欄位 */
            .field {
            margin-top: 12px;
            }
            .field label {
            display:block;
            margin-bottom:4px;
            color: var(--deep-blue);
            }
            .field input[type="url"],
            textarea {
            width: 100%;
            padding: 10px;
            font-size: 14px;
            border-radius: 6px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            resize: vertical;
            }

            /* 照片上傳區 */
            .photo-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); 
            gap: 12px;
            }

            .upload-label {
            width: 100%;
            height: 120px;
            background-color: #e0e0e0;
            border: 2px dashed #ccc;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: border-color 0.3s ease;
            flex-shrink: 0;
            aspect-ratio: 5 / 6;   /* 維持 100x120 的比例 */
            max-width: 120px;      /* 避免桌機太大被拉太寬 */
            }

            .upload-label:hover { border-color: #81d3e1; }
            .plus-icon { font-size: 32px; color: #aaa; }

            .photo-item {
            position: relative;
            width: 100%;
            height: 120px;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
            aspect-ratio: 5 / 6;   /* 維持 100x120 的比例 */
            max-width: 120px;      /* 避免桌機太大被拉太寬 */
            }
            .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
            border: 1px solid #ccc;
            }
            .photo-item input { display: none; }
            .delete-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 14px;
            cursor: pointer;
            line-height: 18px;
            text-align: center;
            padding-left: 4px;
            }

            /* 動作列（儲存按鈕） */
            .actions {
            text-align: center;
            margin: 20px 0 8px;
            }
            </style>

    </head>
    <body>
        <div class="header">
            <div class="left-section">
                <svg
                id="back-button" 
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                width="24"
                height="24">
                    <path d="M15 19l-7-7 7-7"
                        stroke= #81d3e1
                        stroke-width="2"
                        fill="none"
                        stroke-linecap="round"
                        stroke-linejoin="round"></path>
                    <path d="M8 12h14"
                        stroke="#81d3e1"
                        stroke-width="2"
                        fill="none"
                        stroke-linecap="round"
                        stroke-linejoin="round"></path>
                </svg>
            </div>
            <div class="navbar-title">
                <img src="/static/logo.png" alt="Logo" />
                編輯公開資料
            </div>
        </div>
        <main class="container">
        <section class="card">

            <!-- 關於我 -->
            <h3 class="section-title">關於我</h3>
            <textarea id="bio-input" rows="6" placeholder="請輸入自我介紹..."></textarea>

            <div style="margin-top: 16px;">
            <label for="fb-link" style="display:block;margin-bottom:4px;">Facebook 連結</label>
            <input id="fb-link" type="url" placeholder="https://facebook.com/yourprofile"
                    style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;box-sizing:border-box;">
            </div>

            <div style="margin-top: 12px;">
            <label for="ig-link" style="display:block;margin-bottom:4px;">Instagram 連結</label>
            <input id="ig-link" type="url" placeholder="https://instagram.com/yourprofile"
                    style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;box-sizing:border-box;">
            </div>

            <!-- 分隔線：用 hr 而不是 div -->
            <hr class="card-divider">

            <!-- 個人照片 -->
            <h3 class="section-title">個人照片</h3>
            <div id="photo-gallery" class="photo-gallery">
            <label for="photo-upload" class="upload-label">
                <span class="plus-icon">+</span>
            </label>
            <input type="file" id="photo-upload" accept="image/*" style="display:none;" multiple />
            </div>

            <!-- 儲存按鈕放卡片底部 -->
            <div class="actions">
            <button onclick="saveBio()" style="width: 200px; padding: 10px; background-color: #81d3e1; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer;">
                儲存
            </button>
            </div>

        </section>
        </main>

        <script>
            document.getElementById("back-button").addEventListener("click", function() {
                window.history.back();
            });

            // 取得初始欄位值
            let initialBio = "";
            let initialFb = "";
            let initialIg = "";
            let initialPhotoPaths = [];
            let isDirty = false;

            // 從網址取得 member_id
            function getMemberIdFromUrl() {
                // 先從 query string 取值
                const urlParams = new URLSearchParams(window.location.search);
                const mid = urlParams.get('member_id');
                if (mid) return mid;
                // 再從路徑取值（允許 uuid 或字串）
                const pathMatch = window.location.pathname.match(/([a-zA-Z0-9\-]{8,})$/);
                if (pathMatch) return pathMatch[1];
                return null;
            }
            const member_id = getMemberIdFromUrl();


            // 載入會員自我介紹與照片
            async function loadMemberData() {
                if (!member_id) return;
                // 取得自我介紹與社群連結
                try {
                    let res = await fetch(`/api/members/${member_id}`);
                    if (res.ok) {
                        let data = await res.json();
                        if (data.public_intro) {
                            document.getElementById("bio-input").value = data.public_intro;
                            initialBio = data.public_intro;
                        }
                        // 支援多種欄位名稱
                        const fbVal = data.fb_link || data.facebook_url || "";
                        const igVal = data.ig_link || data.instagram_url || "";
                        document.getElementById("fb-link").value = fbVal;
                        document.getElementById("ig-link").value = igVal;
                        initialFb = fbVal;
                        initialIg = igVal;
                    }
                } catch {}
                // 取得照片（假設有 /api/photos?member_id=xxx 回傳 {photos: [{file_path: ...}, ...]}）
                try {
                    let res = await fetch(`/api/photos?member_id=${member_id}`);
                    if (res.ok) {
                        let data = await res.json();
                        if (Array.isArray(data.photos)) {
                            data.photos.forEach(photo => {
                                addPhotoItemFromUrl(photo.file_path);
                            });
                            initialPhotoPaths = data.photos.map(p => p.file_path).sort();
                        }
                    }
                } catch {}
                isDirty = false;
            }

            // 新增已上傳照片的顯示卡片
            // 記錄已刪除的 file_path
            const deletedPhotoPaths = new Set();

            function addPhotoItemFromUrl(url) {
                const photoItem = document.createElement("div");
                photoItem.className = "photo-item";
                photoItem.dataset.filePath = url;
                const img = document.createElement("img");
                img.src = url;
                const deleteBtn = document.createElement("button");
                deleteBtn.className = "delete-btn";
                deleteBtn.textContent = "✕";
                deleteBtn.addEventListener("click", () => {
                    gallery.removeChild(photoItem);
                    deletedPhotoPaths.add(url);
                    isDirty = true;
                });
                photoItem.appendChild(img);
                photoItem.appendChild(deleteBtn);
                gallery.insertBefore(photoItem, gallery.querySelector(".upload-label").nextSibling);
            }

            // 監聽欄位變動
            document.addEventListener('DOMContentLoaded', function() {
                document.getElementById("bio-input").addEventListener("input", () => { isDirty = true; });
                document.getElementById("fb-link").addEventListener("input", () => { isDirty = true; });
                document.getElementById("ig-link").addEventListener("input", () => { isDirty = true; });
            });

            // 頁面載入時自動載入資料
            window.addEventListener('DOMContentLoaded', loadMemberData);

            async function saveBio() {
                const bio = document.getElementById("bio-input").value;
                const fbLink = document.getElementById("fb-link").value.trim();
                const igLink = document.getElementById("ig-link").value.trim();
                if (!bio.trim()) {
                    alert("請輸入自我介紹內容！");
                    return;
                }
                // 1. 送出自我介紹與社群連結
                let introRes = await fetch(`/api/members/${member_id}/public-intro`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ public_intro: bio, fb_link: fbLink, ig_link: igLink })
                });
                let introData = await introRes.json();
                if (!introRes.ok) {
                    alert(introData.error || "自我介紹儲存失敗");
                    return;
                }

                // 2. 刪除已標記刪除的舊照片
                for (const url of deletedPhotoPaths) {
                    try {
                        let res = await fetch(`/api/photos/delete`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ member_id, file_path: url })
                        });
                        let data = await res.json();
                        if (!res.ok) {
                            alert(data.error || '照片刪除失敗');
                            return;
                        }
                    } catch {
                        alert('照片刪除失敗');
                        return;
                    }
                }
                deletedPhotoPaths.clear();

                // 3. 上傳所有新選的照片（從 uploadedPhotos Map 取出所有 File）
                let uploadCount = 0;
                for (const [fileKey, file] of uploadedPhotos.entries()) {
                    if (file) {
                        const formData = new FormData();
                        formData.append('member_id', member_id);
                        formData.append('file', file);
                        try {
                            let res = await fetch('/api/upload_photo', {
                                method: 'POST',
                                body: formData
                            });
                            let data = await res.json();
                            if (!res.ok) {
                                alert(data.error || '照片上傳失敗');
                                return;
                            }
                            uploadCount++;
                        } catch (e) {
                            alert('照片上傳發生錯誤');
                            return;
                        }
                    }
                }
                isDirty = false;
                alert("自我介紹與照片已儲存！");
            }

            const gallery = document.getElementById("photo-gallery");
            // 用 Map 記錄 key 對應的 File 物件
            const uploadedPhotos = new Map();

            document.getElementById("photo-upload").addEventListener("change", function (event) {
                const files = Array.from(event.target.files);
                files.forEach(file => {
                    const fileKey = `${file.name}_${file.size}_${file.type}`;
                    if (uploadedPhotos.has(fileKey)) {
                        alert(`已上傳過相同的照片，請勿重複上傳。`);
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const photoItem = document.createElement("div");
                        photoItem.className = "photo-item";
                        photoItem.dataset.fileKey = fileKey;
                        const img = document.createElement("img");
                        img.src = e.target.result;
                        const fileInput = document.createElement("input");
                        fileInput.type = "file";
                        fileInput.accept = "image/*";
                        const deleteBtn = document.createElement("button");
                        deleteBtn.className = "delete-btn";
                        deleteBtn.textContent = "✕";
                        // 點圖片重新選檔案
                        img.addEventListener("click", () => fileInput.click());
                        // 替換圖片
                        fileInput.addEventListener("change", function () {
                            const newFile = fileInput.files[0];
                            const newKey = `${newFile.name}_${newFile.size}_${newFile.type}`;
                            if (uploadedPhotos.has(newKey)) {
                                alert(`已經上傳過，請選其他照片。`);
                                return;
                            }
                            const newReader = new FileReader();
                            newReader.onload = function (ev) {
                                img.src = ev.target.result;
                            };
                            newReader.readAsDataURL(newFile);
                            // 更新 key
                            uploadedPhotos.delete(fileKey);
                            uploadedPhotos.set(newKey, newFile);
                            photoItem.dataset.fileKey = newKey;
                            isDirty = true;
                        });
                        // 刪除圖片卡片
                        deleteBtn.addEventListener("click", () => {
                            gallery.removeChild(photoItem);
                            uploadedPhotos.delete(photoItem.dataset.fileKey);
                            isDirty = true;
                        });
                        photoItem.appendChild(img);
                        photoItem.appendChild(fileInput);
                        photoItem.appendChild(deleteBtn);
                        gallery.insertBefore(photoItem, gallery.querySelector(".upload-label").nextSibling);
                        uploadedPhotos.set(fileKey, file);
                        isDirty = true;
                    };
                    reader.readAsDataURL(file);
                });
                event.target.value = "";
            });

            // 離開頁面前提示未儲存
            window.addEventListener('beforeunload', function(e) {
                if (isDirty) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
        </script>
    </body>
</html>