<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <link rel="manifest" href="/static/manifest.json" />
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("/static/service-worker.js")
          .then(() => console.log("Service Worker Registered"))
          .catch((error) =>
            console.error("Service Worker Registration Failed:", error)
          );
      }
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç™¼èµ·æ´»å‹•</title>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        color: #333;
        margin: 0;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
      }
      .container {
        max-width: 800px;
        width: 100%;
        background-color: #fff;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      .title-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 30px;
      }
      .title-left,
      .title-right {
        width: 60px; /* å’Œ SVG å¯¬åº¦å·®ä¸å¤šï¼Œä¿æŒå°ç¨± */
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .title-center {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        flex-grow: 1;
      }
      .back-button {
        background: none;
        border: none;
        cursor: pointer;
      }
      .logo-inline {
        width: 50px;
        height: 50px;
        object-fit: contain;
        border-radius: 50%;
      }
      h1 {
        color: #2c4975;
        white-space: nowrap;
        font-size: 24px;
        margin: 0;
      }
      .form-row {
        margin-bottom: 20px;
      }
      .form-label {
        margin-bottom: 20px;
        font-weight: bold;
        color: #2c4975;
        display: block;
      }
      .radio-card-group {
        display: flex;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
      }
     .radio-card {
        padding: 10px 20px;
        background-color: #f9f9f9;
        border: 1px solid #ccc;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
		font-size: 15px;
	    user-select: none;
	    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      .radio-card input {
        display: none;
      }
	  .radio-card:hover {
	   background-color: #eaf3fa;
	   color: #2c4975;
	  }
      .radio-card:has(input:checked) {
        background-color: #81d3e1;
        color: white;
		font-weight: bold;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }
	  .radio-card:active {
	   transform: scale(0.96);
	  }
	  .radio-card:has(input:checked) span {
		  color: white; /* å°ˆé–€è®“åŒ…ä½æ–‡å­—çš„ span è®Šç™½è‰² */
		}
      .btn-primary {
        padding: 10px 20px;
        font-size: 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        color: white;
        background-color: #81d3e1;
        width: 100%;
        transition: 0.2s ease;
      }
      .btn-primary:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .btn-primary:hover:enabled {
        background-color: #2c4975;
      }
      input[type="text"],
      input[type="datetime-local"],
      input[type="number"],
      textarea {
        padding: 10px;
        width: 100%;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
      }
      textarea {
        resize: vertical;
        min-height: 100px;
      }
      #other-sport-row {
        margin-top: 16px;
        display: none;
      }
      .back-button {
        background: none;
        border: none;
        cursor: pointer;
        margin-left: -8px; /* â† æ§åˆ¶å¾€å·¦ */
      }
      .arrow-icon {
        fill: #2c4975;
        transition: fill 0.2s ease;
      }

      .back-button:hover .arrow-icon {
        fill: #81d3e1;
      }
	  .text-button {
		  background: none;
		  border: none;
		  color: #81d3e1;
		  font-size: 14px;
		  cursor: pointer;
		  font-weight: bold;
		}

		.text-button:hover {
		  color: #81d3e1;
		}

		.dropdown-list {
		  position: absolute;
		  top: 100%;
		  left: 0;
		  z-index: 10;
		  margin-top: 4px;
		  width: 100%;
		  padding: 8px;
		  background-color: #f9f9f9;
		  border: 1px solid #ccc;
		  border-radius: 4px;
		  list-style-type: none;
		  max-height: 200px;
		  overflow-y: auto;
		  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
		}
		.label-button-row {
		  display: flex;
		  justify-content: space-between;
		  align-items: center;
		  margin-bottom: 6px;
		}
		.dropdown-list li {
		  padding: 6px 10px;
		  cursor: pointer;
		}

		.dropdown-list li:hover {
		  background-color: #eaf3fa;
		}
		.form-label-inline {
		  font-weight: bold;
		  color: #2c4975;
		  font-size: 16px;
		}


    </style>
  </head>
  <body>
    <div class="container">
      <div class="title-row">
        <div class="title-left">
          <button onclick="history.back()" class="back-button">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="28"
              height="28"
              class="arrow-icon"
              viewBox="0 0 256 256"
            >
              <path
                d="M228,128a12,12,0,0,1-12,12H69l51.52,51.51a12,12,0,0,1-17,17l-72-72a12,12,0,0,1,0-17l72-72a12,12,0,0,1,17,17L69,116H216A12,12,0,0,1,228,128Z"
              />
            </svg>
          </button>
        </div>
        <div class="title-center">
          <img src="/static/logo.png" alt="Logo" class="logo-inline" />
          <h1>ç™¼èµ·æ´»å‹•</h1>
        </div>
        <div class="title-right"><!-- é ç•™ç©ºé–“ç”¨ --></div>
      </div>
      <form id="preferenceForm">
		 <div class="form-row" style="position: relative;">
		  <div class="label-button-row">
			<label class="form-label-inline">æ´»å‹•åç¨±</label>
			<button type="button" class="text-button" onclick="togglePastTitles()">æ›¾ç™¼èµ·çš„æ´»å‹•</button>
		  </div>
		  <input
			id="titleInput"
			type="text"
			name="title"
			placeholder="å…¬é–‹é¡¯ç¤ºï¼Œè«‹ç°¡æ˜æ¸…æ¥š"
			required
		  />
		  <ul id="pastTitles" class="dropdown-list" style="display: none;"></ul>
		</div>

        <div class="form-row">
          <label class="form-label">é¡å‹</label>
          <div class="radio-card-group" id="sport-options">
            <!-- é¸é …å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
          </div>
          <div class="form-row" id="other-sport-row">
            <input
              type="text"
              id="other-sport-input"
              placeholder="è«‹è¼¸å…¥å…¶ä»–é¡å‹"
            />
          </div>
        </div>
        <div class="form-row">
          <label class="form-label">é–‹å§‹æ™‚é–“</label>
          <input type="datetime-local" name="startTime" required />
        </div>
        <div class="form-row">
          <label class="form-label">çµæŸæ™‚é–“</label>
          <input type="datetime-local" name="endTime" required />
        </div>
        <div class="form-row">
          <label class="form-label">åœ°é»</label>
          <div style="display: flex; gap: 10px;">
            <input
              type="text"
              id="place-input"
              name="location"
              placeholder="è«‹è¼¸å…¥å®Œæ•´åœ°å€"
              required
              style="flex: 1;"
            />

          </div>
          <!-- éš±è—æ¬„ä½ä¾†å„²å­˜ç¶“ç·¯åº¦ -->
          <input type="hidden" id="location-lat" name="location_lat" />
          <input type="hidden" id="location-lng" name="location_lng" />
        </div>
        <div class="form-row">
          <label class="form-label">åœ°åœ–é è¦½</label>
          <div id="map" style="width: 100%; height: 300px; border: 1px solid #ccc; border-radius: 4px;"></div>
        </div>
        
        <div class="form-row">
          <label class="form-label">äººæ•¸ï¼ˆåŒ…å«è‡ªå·±ï¼‰</label>
          <input
            type="number"
            name="numPeople"
            placeholder="è«‹è¼¸å…¥æ­£ç¢ºäººæ•¸"
            required
            min="1"
          />
        </div>
        <div class="form-row">
          <label class="form-label">å ´åœ°è²» (NTD)</label>
          <input
            type="number"
            name="venue_fee"
            placeholder="è«‹è¼¸å…¥å ´åœ°è²»ç”¨"
            step="0.01"
            min="0"
            required
          />
        </div>
        <div class="form-row">
          <label class="form-label">å ±åæˆªæ­¢æ—¥æœŸ</label>
          <input type="datetime-local" name="registration_deadline" required />
        </div>
        <div class="form-row">
          <label class="form-label">æ€§åˆ¥</label>
          <div class="radio-card-group">
            <label class="radio-card">
			  <input type="radio" name="gender" value="ç”·æ€§" required />
			  <span>ç”·æ€§</span>
			</label>
            <label class="radio-card"
              ><input
                type="radio" name="gender" value="å¥³æ€§" required />
			  <span>å¥³æ€§</span>
			</label>
           <label class="radio-card">
			  <input type="radio" name="gender" value="ä¸é™" required />
			  <span>ä¸é™</span>
			</label>
		  </div>
		</div>

		<div class="form-row">
		  <label class="form-label">å¹´é½¡å€é–“</label>
		  <div class="radio-card-group">
			<label class="radio-card">
			  <input type="radio" name="ageRange" value="18-25" required />
			  <span>18â€“25</span>
			</label>
			<label class="radio-card">
			  <input type="radio" name="ageRange" value="26-35" required />
			  <span>26â€“35</span>
			</label>
			<label class="radio-card">
			  <input type="radio" name="ageRange" value="36-45" required />
			  <span>36â€“45</span>
			</label>
			<label class="radio-card">
			  <input type="radio" name="ageRange" value="46-64" required />
			  <span>46â€“64</span>
			</label>
			<label class="radio-card">
			  <input type="radio" name="ageRange" value="65+" required />
			  <span>65ä»¥ä¸Š</span>
			</label>
			<label class="radio-card">
			  <input type="radio" name="ageRange" value="ä¸é™" required />
			  <span>ä¸é™</span>
			</label>
		  </div>
		</div>

		<div class="form-row">
		  <label class="form-label">ç­‰ç´š</label>
		  <div class="radio-card-group">
			<label class="radio-card">
			  <input type="radio" name="level" value="åˆå­¸" required />
			  <span>åˆå­¸</span>
			</label>
			<label class="radio-card">
			  <input type="radio" name="level" value="ä¸­éš" required />
			  <span>ä¸­éš</span>
			</label>
			<label class="radio-card">
			  <input type="radio" name="level" value="é€²éš" required />
			  <span>é€²éš</span>
			</label>
			<label class="radio-card">
			  <input type="radio" name="level" value="ä¸é™" required />
			  <span>ä¸é™</span>
			</label>
		  </div>
		</div>
        <div class="form-row">
          <label class="form-label">è£œå……èªªæ˜</label>
          <textarea
            name="description"
            placeholder="EXï¼šåœ°æ¨™æè¿°ã€è£å‚™å»ºè­°ã€æ³¨æ„äº‹é …..."
          ></textarea>
        </div>
        <button type="submit" class="btn-primary" id="submitBtn">
          ç™¼èµ·æ´»å‹•
        </button>
      </form>
    </div>
    <script>

      const sportRadios = document.querySelectorAll('input[name="sport"]');
      const otherSportRow = document.getElementById("other-sport-row");
      const otherSportInput = document.getElementById("other-sport-input");
      const submitBtn = document.getElementById("submitBtn");

      sportRadios.forEach((radio) => {
        radio.addEventListener("change", function () {
          otherSportRow.style.display =
            this.value === "å…¶ä»–" ? "block" : "none";
          if (this.value !== "å…¶ä»–") otherSportInput.value = "";
        });
      });

      fetch("/api/preferences/options")
        .then((response) => response.json())
        .then((data) => {
          const sportOptionsContainer =
            document.getElementById("sport-options");
          data.sport_types.forEach((sport) => {
            const label = document.createElement("label");
            label.className = "radio-card";
            label.innerHTML = `
              <input type="radio" name="sport" value="${sport.sport_type_id}" required />
              ${sport.name}
            `;
            sportOptionsContainer.appendChild(label);
          });
        })
        .catch((error) => console.error("Error fetching sport types:", error));

      const urlParams = new URLSearchParams(window.location.search);
      const memberId = urlParams.get("member_id");

      document.getElementById("preferenceForm").addEventListener("submit", function (e) {
  e.preventDefault();

  const formData = new FormData(this);
  const now = new Date();
  const registrationDeadline = new Date(formData.get("registration_deadline"));
  const startTime = new Date(formData.get("startTime"));
  const endTime = new Date(formData.get("endTime"));

  if (registrationDeadline <= now) {
    alert("å ±åæˆªæ­¢æ—¥æœŸå¿…é ˆåœ¨ç¾åœ¨æ™‚é–“ä¹‹å¾Œï¼");
    return;
  }

  if (startTime <= now) {
    alert("é–‹å§‹æ™‚é–“å¿…é ˆåœ¨ç¾åœ¨æ™‚é–“ä¹‹å¾Œï¼");
    return;
  }

  if (endTime <= now) {
    alert("çµæŸæ™‚é–“å¿…é ˆåœ¨ç¾åœ¨æ™‚é–“ä¹‹å¾Œï¼");
    return;
  }

  if (registrationDeadline >= startTime) {
    alert("å ±åæˆªæ­¢æ—¥æœŸå¿…é ˆæ—©æ–¼é–‹å§‹æ™‚é–“ï¼");
    return;
  }

  if (startTime >= endTime) {
    alert("é–‹å§‹æ™‚é–“å¿…é ˆæ—©æ–¼çµæŸæ™‚é–“ï¼");
    return;
  }

  if (!confirm("ç¢ºå®šè¦ç™¼èµ·æ´»å‹•å—ï¼Ÿ")) {
    return;
  }

  const locationName = formData.get("location");
const locationLat = document.getElementById("location-lat").value;
const locationLng = document.getElementById("location-lng").value;

if (!locationLat || !locationLng) {
  alert("è«‹é¸æ“‡ Google å»ºè­°çš„åœ°å€é¸é …ï¼Œæ‰èƒ½æ¨™è¨˜åœ°åœ–èˆ‡ç™¼èµ·æ´»å‹•ï¼");
  return;
}

const data = {
  title: formData.get("title"),
  start_time: formData.get("startTime"),
  end_time: formData.get("endTime"),
  location_name: locationName,
  location_lat: locationLat,
  location_lng: locationLng,
  max_participants: parseInt(formData.get("numPeople")),
  venue_fee: parseFloat(formData.get("venue_fee")),
  registration_deadline: formData.get("registration_deadline"),
  organizer_id: memberId,
  level: formData.get("level"),
  sport_type_id: parseInt(formData.get("sport")),
  description: formData.get("description"),
  status: "open",
  target_identity: "ä¸é™",
  gender: formData.get("gender"),
  age_range: formData.get("ageRange"),
};

fetch("/api/activities", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(data),
})
  .then((res) => {
    if (res.ok) {
      alert("æ´»å‹•ç™¼èµ·æˆåŠŸï¼");
      window.location.href = `/activity?member_id=${memberId}`;
    } else {
      alert("æ´»å‹•ç™¼èµ·å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼");
    }
  })
  .catch((err) => {
    console.error("éŒ¯èª¤:", err);
    alert("ç™¼èµ·æ´»å‹•æ™‚å‡ºéŒ¯ï¼");
  });

}); // ğŸ‘ˆ æœ€å¤–å±¤ addEventListener çš„çµå°¾

      function sportNameToId(sport) {
        const mapping = {
          è·‘æ­¥: 1,
          ç¾½çƒ: 2,
          ç‘œçˆ: 3,
          å¥èº«: 4,
          é¨å–®è»Š: 5,
          ç±ƒçƒ: 6,
          æ¸¸æ³³: 7,
          æ’çƒ: 8,
          ç¶²çƒ: 9,
          æ£’çƒ: 10,
          è¶³çƒ: 11,
        };
        return mapping[sport] || 0;
      }
	  function togglePastTitles() {
    const list = document.getElementById("pastTitles");
    list.style.display = list.style.display === "none" ? "block" : "none";

    if (list.innerHTML.trim() === "") {
      const urlParams = new URLSearchParams(window.location.search);
      const memberId = urlParams.get("member_id");

      if (!memberId) {
        console.error("ç„¡æ³•å–å¾— member_id");
        return;
      }

      fetch(`/api/activities/past_activity?member_id=${memberId}`)
        .then((response) => response.json())
        .then((data) => {
          const uniqueTitles = new Set();
          data.forEach((activity) => {
            if (!uniqueTitles.has(activity.title)) {
              uniqueTitles.add(activity.title);
              const li = document.createElement("li");
              li.textContent = `${activity.title} - ${activity.location_name}`;
              li.style.cursor = "pointer";
              li.addEventListener("click", () => {
                document.querySelector('input[name="title"]').value = activity.title;
                document.querySelector('input[name="location"]').value = activity.location_name;
                document.getElementById("location-lat").value = activity.location_lat;
                document.getElementById("location-lng").value = activity.location_lng;

                const sportOptions = document.querySelectorAll('input[name="sport"]');
                sportOptions.forEach((option) => {
                  if (option.value == activity.sport_type_id) {
                    option.checked = true;
                  }
                });

                // æ›´æ–°åœ°åœ–ä¸­å¿ƒå’Œæ¨™è¨˜
                const location = { lat: parseFloat(activity.location_lat), lng: parseFloat(activity.location_lng) };
                map.setCenter(location);
                if (marker) marker.setMap(null);
                marker = new google.maps.Marker({
                  map: map,
                  position: location,
                  title: activity.location_name,
                });

                list.style.display = "none";
              });
              list.appendChild(li);
            }
          });
        })
        .catch((error) => console.error("Error fetching past activities:", error));
    }
  }
      // ğŸ‘‡ æ’å…¥é€™æ®µ autocomplete + åœ°åœ–é‚è¼¯
      
  let map, marker, autocomplete;

  function initAutocomplete() {
    console.log("âœ… initAutocomplete å·²åŸ·è¡Œï¼");

    // åˆå§‹åŒ–åœ°åœ–
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 25.0330, lng: 121.5654 }, // å°åŒ—é è¨­
      zoom: 15,
    });

    // ç¶å®šè‡ªå‹•å®Œæˆè¼¸å…¥æ¬„ä½
    const input = document.getElementById("place-input");
    autocomplete = new google.maps.places.Autocomplete(input, {
      types: ["geocode"],
      componentRestrictions: { country: "tw" },
    });

    // ç•¶ä½¿ç”¨è€…é¸å–å»ºè­°åœ°å€æ™‚
    autocomplete.addListener("place_changed", () => {
      const place = autocomplete.getPlace();
      console.log("ğŸ“ ä½¿ç”¨è€…é¸æ“‡åœ°é»ï¼š", place);

      if (!place.geometry || !place.geometry.location) {
        alert("æ‰¾ä¸åˆ°æ­¤åœ°å€çš„åœ°ç†ä½ç½®ï¼Œè«‹é‡æ–°è¼¸å…¥ï¼");
        return;
      }

      const location = place.geometry.location;
      const lat = location.lat();
      const lng = location.lng();

      // ç§»å‹•åœ°åœ–ä¸­å¿ƒ
      map.setCenter(location);

      // é¡¯ç¤ºæ–°æ¨™è¨˜
      if (marker) marker.setMap(null);
      marker = new google.maps.Marker({
        map: map,
        position: location,
        title: place.name || input.value,
      });

      // å¯«å…¥éš±è—æ¬„ä½ï¼Œé€å¾Œç«¯
      document.getElementById("location-lat").value = lat;
      document.getElementById("location-lng").value = lng;

      // ç¢ºèªè¼¸å‡º
      console.log("âœ… ç·¯åº¦ lat:", lat);
      console.log("âœ… ç¶“åº¦ lng:", lng);
    });
  }
</script>


    </script>
<script
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAjPPoRxjshMgepTKlniZst9G4fgpqQkQk&libraries=places&callback=initAutocomplete"
defer
></script>
</body>
</html>
